<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gincana de Unidades: A Aventura do Desbravador</title>
    <!-- Chosen Palette: Warm Neutrals & Serene Blue -->
    <!-- Application Structure Plan: The application is structured as a single-page tabbed dashboard. This architecture was chosen to provide users with a clean, organized, and non-linear way to access different types of information. Instead of a long scroll, users can instantly switch between contexts: 'In√≠cio' for a quick overview and scoreboard, 'Calend√°rio' for planning, 'Regulamento' for rules reference, and 'Sobre o Clube' for foundational information. This task-oriented separation enhances usability and makes finding specific information much faster and more intuitive. -->
    <!-- Visualization & Content Choices: 
        - Scoreboard (Goal: Compare): A Chart.js horizontal bar chart was selected to visually represent and compare unit scores, as it's highly effective for ranking. This is paired with dynamic stat cards (HTML/CSS) to provide a quick summary (Goal: Inform). Interaction: The chart is dynamically rendered from JS data fetched from Firestore.
        - Calendar (Goal: Organize/Inform): An accordion-style list, grouped by month, is used instead of a complex calendar grid. This simplifies implementation while still allowing users to easily find activities. Interaction: Clicking a month reveals its activities.
        - Regulations (Goal: Inform/Organize): Content from the regulation report is structured into accordion sections for 'Pontua√ß√£o', 'Crit√©rios de Desempate', 'Conduta Esperada', and 'Procedimentos para Recursos'. This approach breaks down legalistic text into digestible, expandable chunks.
        - About the Club (Goal: Inform): 'As Bases do Clube' and 'Estrutura e Fun√ß√µes' are presented using accordions. This keeps detailed textual information concise until expanded.
        - Graphics (Goal: Enhance UI): Unicode characters (emojis) are used for icons in the navigation tabs, providing visual cues without the overhead or complexity of image files or SVG, adhering to the constraints.
        - Library/Method: Chart.js for visualizations. Firestore for remote data storage and real-time updates. Firebase Authentication for user roles. All other elements are built with structured HTML and styled with Tailwind CSS. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        // Global variables for Firebase access
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.currentUser = null;
        window.userRole = null;

        // Expondo fun√ß√µes do Firestore para o escopo global (window)
        window.doc = doc;
        window.getDoc = getDoc;
        window.addDoc = addDoc;
        window.setDoc = setDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.onSnapshot = onSnapshot;
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.getDocs = getDocs;
        window.serverTimestamp = serverTimestamp;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged; // Expor para uso em initApp

        // =====================================================================================================
        // === ATEN√á√ÉO: CONFIGURA√á√ÉO DO FIREBASE - VOC√ä PRECISA PREENCHER ESTAS VARI√ÅVEIS ===
        // =====================================================================================================
        // 1. Substitua 'SEU_FIREBASE_PROJECT_ID_AQUI' pelo ID do seu projeto Firebase (ex: 'meu-clube-gincana-12345').
        //    Este ID ser√° usado para organizar os dados no Firestore.
        window.appId = 'gincana-de-unidade';

        // 2. Cole AQUI o objeto 'firebaseConfig' COMPLETO que voc√™ copiou do Console do Firebase.
        //    Ele deve ser parecido com o exemplo abaixo, mas com as suas chaves e IDs reais.
        //    IMPORTANTE: Estamos definindo window.firebaseConfig para que seja acess√≠vel globalmente.
        window.firebaseConfig = {
            apiKey: "AIzaSyBJI_Hrp1I5GJHt82UKo5xjr392Z4XTMS8",
            authDomain: "gincana-de-unidade.firebaseapp.com",
            projectId: "gincana-de-unidade",
            storageBucket: "gincana-de-unidade.firebasestorage.app",
            messagingSenderId: "497226153394",
            appId: "1:497226153394:web:35d484f3737e3a3b4938ab"
        };

        // initialAuthToken n√£o √© mais usado com autentica√ß√£o por e-mail/senha, mas mantido para compatibilidade
        const initialAuthToken = null;
        // =====================================================================================================
        // === FIM DA CONFIGURA√á√ÉO DO FIREBASE ===
        // =====================================================================================================

        // Apenas para depura√ß√£o: Verifique o que est√° sendo lido na configura√ß√£o
        console.log("firebaseConfig lido:", window.firebaseConfig);
        console.log("window.appId lido:", window.appId);
        console.log("authDomain lido:", window.firebaseConfig.authDomain);


        // MessageBox function (retained for consistency with previous responses)
        window.showMessage = (msg, callback, showCancel = false) => {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const confirmBtn = document.getElementById('messageConfirmBtn');
            const cancelBtn = document.getElementById('messageCancelBtn');

            messageText.textContent = msg;
            messageBox.classList.remove('hidden');

            confirmBtn.onclick = () => {
                messageBox.classList.add('hidden');
                if (callback) callback(true);
            };

            if (showCancel) {
                cancelBtn.classList.remove('hidden');
                cancelBtn.onclick = () => {
                    messageBox.classList.add('hidden');
                    if (callback) callback(false);
                };
            } else {
                cancelBtn.classList.add('hidden');
            }
        };

        // Firebase Initialization and Authentication
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Verifica se as credenciais foram preenchidas (agora via window.firebaseConfig)
                if (!window.firebaseConfig.apiKey || !window.firebaseConfig.projectId || !window.firebaseConfig.authDomain) {
                    window.showMessage("Erro: As credenciais do Firebase (apiKey, projectId, authDomain) n√£o foram preenchidas ou est√£o incompletas no c√≥digo. Por favor, insira-as corretamente.");
                    document.getElementById('loading-overlay').classList.add('hidden');
                    return;
                }

                window.firebaseApp = initializeApp(window.firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);

                // Listener de estado de autentica√ß√£o principal
                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        window.currentUser = user;
                        // Tenta buscar o papel do utilizador no Firestore
                        const userDocRef = doc(window.db, 'artifacts', window.appId, 'users', user.uid);
                        const userDocSnap = await getDoc(userDocRef);

                        if (userDocSnap.exists()) {
                            window.userRole = userDocSnap.data().role;
                        } else {
                            // Se o utilizador n√£o tiver um papel, define como l√≠der por padr√£o
                            // Isso acontece no primeiro login/registo.
                            await setDoc(userDocRef, { role: 'leader', uid: user.uid, email: user.email || 'N/A' });
                            window.userRole = 'leader';
                        }
                        // Esconde o formul√°rio de login e mostra o conte√∫do principal
                        document.getElementById('auth-section').classList.add('hidden');
                        document.getElementById('main-app-content').classList.remove('hidden');
                        document.getElementById('loading-overlay').classList.add('hidden');
                        initApp(); // Inicializa a l√≥gica principal da aplica√ß√£o
                    } else {
                        window.currentUser = null;
                        window.userRole = null;
                        // Mostra o formul√°rio de login e esconde o conte√∫do principal
                        document.getElementById('auth-section').classList.remove('hidden');
                        document.getElementById('main-app-content').classList.add('hidden');
                        document.getElementById('loading-overlay').classList.add('hidden');
                        setupAuthFormListeners(); // Configura os listeners do formul√°rio de autentica√ß√£o
                    }
                });

            } catch (error) {
                console.error("Erro na inicializa√ß√£o do Firebase:", error);
                window.showMessage("Erro cr√≠tico na inicializa√ß√£o do aplicativo. Por favor, recarregue.");
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        });
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .tab-button.active {
            border-bottom-color: #2563eb;
            /* theme-blue-600 */
            color: #2563eb;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }

        .accordion-button.open+.accordion-content {
            max-height: 1000px;
            /* Adjust as needed for content length */
        }

        .chart-container {
            position: relative;
            height: 40vh;
            /* Responsive height */
            width: 100%;
            max-width: 800px;
            /* Max width to prevent excessive stretching */
            margin: auto;
            /* Center horizontally */
            max-height: 400px;
            /* Max height to prevent vertical overflow */
        }

        @media (max-width: 768px) {
            .chart-container {
                height: 60vh;
                /* Taller on mobile for better readability */
            }
        }

        .list-disc-custom li::marker {
            color: #2563eb;
            /* Custom bullet color */
        }

        .list-decimal-custom li::marker {
            color: #2563eb;
            /* Custom number color */
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay"
        class="fixed inset-0 bg-slate-100 bg-opacity-90 flex flex-col justify-center items-center z-50">
        <div class="animate-spin rounded-full h-20 w-20 border-t-2 border-b-2 border-blue-500"></div>
        <p class="mt-4 text-lg text-slate-700">A carregar aplica√ß√£o...</p>
    </div>

    <!-- Message Box -->
    <div id="messageBox" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 hidden">
        <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full text-center">
            <p id="messageText" class="text-lg font-semibold mb-4"></p>
            <div class="flex justify-center space-x-4">
                <button id="messageConfirmBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">OK</button>
                <button id="messageCancelBtn"
                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 hidden">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Authentication Section -->
    <section id="auth-section"
        class="flex items-center justify-center min-h-screen bg-gradient-to-br from-slate-100 to-blue-200 p-4 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
            <h2 class="text-3xl font-bold text-blue-800 mb-6">Acesso √† Gincana</h2>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="email" class="sr-only">Email</label>
                    <input type="email" id="email" placeholder="Email"
                        class="w-full p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                        required>
                </div>
                <div>
                    <label for="password" class="sr-only">Palavra-passe</label>
                    <input type="password" id="password" placeholder="Palavra-passe"
                        class="w-full p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                        required>
                </div>
                <button type="submit" id="login-btn"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">Iniciar
                    Sess√£o</button>
                <button type="button" id="register-btn"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">Registar</button>
            </form>
            <p class="text-sm text-slate-500 mt-4">
                Se esta √© a sua primeira vez, registe-se. Ap√≥s o registo, o seu papel (L√≠der ou Secret√°rio) ser√°
                definido no sistema.
            </p>
        </div>
    </section>

    <!-- Main Application Content (hidden until authenticated) -->
    <div id="main-app-content" class="container mx-auto p-4 md:p-8 hidden">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-blue-800">Gincana de Unidades</h1>
            <h2 class="text-2xl md:text-3xl font-semibold text-slate-600">A Aventura do Desbravador</h2>
            <p class="mt-4 text-slate-500 italic max-w-3xl mx-auto">"N√£o to mandei eu? S√™ forte e corajoso; n√£o temas,
                nem te espantes, porque o Senhor teu Deus √© contigo, por onde quer que andares." ‚Äì Josu√© 1:9</p>
            <p id="user-info" class="mt-2 text-sm text-slate-500">Carregando informa√ß√µes do utilizador...</p>
            <button id="logout-btn"
                class="mt-4 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">Sair</button>
        </header>

        <!-- Navigation Tabs -->
        <nav class="flex justify-center border-b-2 border-slate-200 mb-8 overflow-x-auto">
            <button data-tab="inicio"
                class="tab-button text-lg font-semibold p-4 border-b-4 border-transparent hover:text-blue-600 transition-colors duration-300 whitespace-nowrap">üèÅ
                In√≠cio</button>
            <button data-tab="calendario"
                class="tab-button text-lg font-semibold p-4 border-b-4 border-transparent hover:text-blue-600 transition-colors duration-300 whitespace-nowrap">üìÖ
                Calend√°rio</button>
            <button data-tab="regulamento"
                class="tab-button text-lg font-semibold p-4 border-b-4 border-transparent hover:text-blue-600 transition-colors duration-300 whitespace-nowrap">üìú
                Regulamento</button>
            <button data-tab="sobre"
                class="tab-button text-lg font-semibold p-4 border-b-4 border-transparent hover:text-blue-600 transition-colors duration-300 whitespace-nowrap">üõ°Ô∏è
                Sobre o Clube</button>
            <button data-tab="gestao"
                class="tab-button text-lg font-semibold p-4 border-b-4 border-transparent hover:text-blue-600 transition-colors duration-300 whitespace-nowrap hidden">‚öôÔ∏è
                Gest√£o</button>
        </nav>

        <!-- Content Area -->
        <main>
            <!-- In√≠cio / Dashboard Section -->
            <section id="inicio" class="content-section">
                <p class="mb-6 text-slate-700 text-center">Bem-vindo ao painel da Gincana de Unidades! Aqui voc√™
                    encontra um resumo r√°pido do progresso e o placar geral das unidades. Explore as outras abas para
                    detalhes sobre o calend√°rio, regulamento e informa√ß√µes do clube.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 text-center">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-slate-500 font-semibold text-lg">Unidade em Destaque</h3>
                        <p id="unidade-destaque" class="text-3xl font-bold text-blue-600 mt-2">Carregando...</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-slate-500 font-semibold text-lg">Total de Pontos Acumulados</h3>
                        <p id="total-pontos" class="text-3xl font-bold text-blue-600 mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-slate-500 font-semibold text-lg">Atividades Conclu√≠das</h3>
                        <p id="atividades-realizadas" class="text-3xl font-bold text-blue-600 mt-2">0 / 0</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-2xl font-bold text-slate-700 mb-4 text-center">Placar Geral da Gincana</h3>
                    <div class="chart-container">
                        <canvas id="scoreChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Calend√°rio Section -->
            <section id="calendario" class="content-section">
                <h2 class="text-3xl font-bold text-center mb-8 text-slate-700">Calend√°rio de Atividades</h2>
                <p class="mb-6 text-slate-700 text-center">Navegue pelas atividades di√°rias e semanais programadas para
                    cada m√™s. As atividades semanais ocorrem sempre aos domingos.</p>
                <div id="calendario-container" class="space-y-4">
                </div>
            </section>

            <!-- Regulamento Section -->
            <section id="regulamento" class="content-section">
                <h2 class="text-3xl font-bold text-center mb-8 text-slate-700">Regulamento Interno da Gincana</h2>
                <p class="mb-6 text-slate-700 text-center">Conhe√ßa as regras de pontua√ß√£o, crit√©rios de desempate,
                    conduta esperada e procedimentos para recursos, garantindo uma gincana justa e organizada.</p>
                <div class="space-y-4">
                    <div class="bg-white rounded-xl shadow-md">
                        <button
                            class="accordion-button w-full text-left p-6 font-bold text-xl text-blue-800 flex justify-between items-center">
                            <span>1. Sistema de Pontua√ß√£o</span>
                            <span class="transform transition-transform duration-300">‚ñº</span>
                        </button>
                        <div id="pontuacao-content" class="accordion-content px-6 pb-6 text-slate-600 space-y-4">
                            <h4 class="font-bold text-lg text-slate-700">Pontua√ß√£o Base por Atividade:</h4>
                            <ul class="list-disc list-inside list-disc-custom space-y-1">
                                <li><strong>Atividades Di√°rias:</strong> 5 pontos por Desbravador presente e ativo na
                                    atividade. 5-10 pontos extras por Desbravador que concluir ou acertar o desafio.
                                </li>
                                <li><strong>Atividades Semanais:</strong> 20 pontos por unidade que participar
                                    integralmente. 30-100 pontos por desempenho/conclus√£o. 10-50 pontos extras por
                                    qualidade/criatividade.</li>
                            </ul>
                            <h4 class="font-bold text-lg text-slate-700 mt-4">B√¥nus Especiais:</h4>
                            <ul class="list-disc list-inside list-disc-custom space-y-1">
                                <li><strong>"Esp√≠rito Desbravador" (Semanal):</strong> 50 pontos.</li>
                                <li><strong>"Unidade Nota 10" (Mensal):</strong> 100 pontos.</li>
                                <li><strong>"Uniforme Impec√°vel" (Semanal):</strong> 20 pontos.</li>
                                <li><strong>"Desafio Surpresa":</strong> Pontos vari√°veis.</li>
                            </ul>
                            <h4 class="font-bold text-lg text-slate-700 mt-4">Penalidades:</h4>
                            <ul class="list-disc list-inside list-disc-custom space-y-1">
                                <li><strong>Atraso na Entrega:</strong> -10 pontos por dia.</li>
                                <li><strong>Comportamento Antidesbravador:</strong> -20 a -50 pontos.</li>
                                <li><strong>Falta em Atividades Obrigat√≥rias:</strong> -10 pontos por membro.</li>
                            </ul>
                            <h4 class="font-bold text-lg text-slate-700 mt-4">Placar e Acompanhamento:</h4>
                            <p>Um Placar Geral vis√≠vel e atualizado semanalmente (online ou f√≠sico) com a pontua√ß√£o de
                                cada unidade. Um "Painel de Conquistas" registrar√° visualmente os progressos.</p>
                            <h4 class="font-bold text-lg text-slate-700 mt-4">Submiss√£o e Valida√ß√£o de Requisitos:</h4>
                            <p>Os l√≠deres de unidade registrar√£o a conclus√£o dos requisitos no "Cantinho da Unidade" (<a
                                    href="https://clubes.adventistas.org/br/unit-control/" target="_blank"
                                    class="text-blue-600 hover:underline">https://clubes.adventistas.org/br/unit-control/</a>).
                                A secret√°ria do clube validar√° os requisitos e atribuir√° a pontua√ß√£o via SGC (<a
                                    href="https://sg.sdasystems.org/cms/login.php?lang=pt_br" target="_blank"
                                    class="text-blue-600 hover:underline">https://sg.sdasystems.org/cms/login.php?lang=pt_br</a>).
                                Um PDF com o placar de pontos atualizado ser√° divulgado semanalmente.</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md">
                        <button
                            class="accordion-button w-full text-left p-6 font-bold text-xl text-blue-800 flex justify-between items-center">
                            <span>2. Crit√©rios de Desempate</span>
                            <span class="transform transition-transform duration-300">‚ñº</span>
                        </button>
                        <div id="desempate-content" class="accordion-content px-6 pb-6 text-slate-600 space-y-4">
                            <p>Em caso de empate na pontua√ß√£o final ou em qualquer etapa decisiva, os seguintes
                                crit√©rios ser√£o aplicados sequencialmente:</p>
                            <ol class="list-decimal list-inside list-decimal-custom space-y-1">
                                <li>Maior n√∫mero de B√¥nus "Esp√≠rito Desbravador" acumulados.</li>
                                <li>Maior n√∫mero de Atividades Semanais conclu√≠das com pontua√ß√£o m√°xima.</li>
                                <li>Menor n√∫mero de Penalidades registradas.</li>
                                <li>Sorteio: Em caso de persist√™ncia do empate, ser√° realizado um sorteio justo e
                                    transparente.</li>
                            </ol>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md">
                        <button
                            class="accordion-button w-full text-left p-6 font-bold text-xl text-blue-800 flex justify-between items-center">
                            <span>3. Conduta Esperada</span>
                            <span class="transform transition-transform duration-300">‚ñº</span>
                        </button>
                        <div id="conduta-content" class="accordion-content px-6 pb-6 text-slate-600 space-y-4">
                            <p>Todos os Desbravadores e l√≠deres devem aderir aos princ√≠pios de conduta do Clube:</p>
                            <ul class="list-disc list-inside list-disc-custom space-y-1">
                                <li><strong>Respeito:</strong> Tratar todos com respeito, cortesia e empatia.</li>
                                <li><strong>Coopera√ß√£o:</strong> Trabalhar em equipe, auxiliando os colegas e a unidade.
                                </li>
                                <li><strong>Disciplina:</strong> Seguir as instru√ß√µes dos l√≠deres e as regras do clube.
                                </li>
                                <li><strong>Integridade:</strong> Ser honesto em todas as atividades e submiss√µes.</li>
                                <li><strong>Esp√≠rito Esportivo:</strong> Aceitar vit√≥rias e derrotas com humildade e
                                    dignidade.</li>
                                <li><strong>Seguran√ßa:</strong> Priorizar a seguran√ßa pr√≥pria e alheia em todas as
                                    atividades.</li>
                            </ul>
                            <p class="mt-2">Comportamentos que contrariem os ideais do Desbravador ou que prejudiquem o
                                ambiente da gincana ser√£o pass√≠veis de penalidades.</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md">
                        <button
                            class="accordion-button w-full text-left p-6 font-bold text-xl text-blue-800 flex justify-between items-center">
                            <span>4. Procedimentos para Recursos (Apela√ß√µes)</span>
                            <span class="transform transition-transform duration-300">‚ñº</span>
                        </button>
                        <div id="recursos-content" class="accordion-content px-6 pb-6 text-slate-600 space-y-4">
                            <p>Caso uma unidade ou l√≠der discorde da pontua√ß√£o atribu√≠da ou de uma penalidade, poder√°
                                apresentar um recurso:</p>
                            <ol class="list-decimal list-inside list-decimal-custom space-y-1">
                                <li><strong>Comunica√ß√£o Inicial:</strong> O l√≠der da unidade deve comunicar formalmente
                                    a secret√°ria do clube, por escrito (e-mail ou mensagem oficial), no prazo m√°ximo de
                                    24 horas ap√≥s a divulga√ß√£o da pontua√ß√£o contestada.</li>
                                <li><strong>An√°lise Preliminar:</strong> A secret√°ria e o diretor associado respons√°vel
                                    pela gincana analisar√£o o recurso e as evid√™ncias.</li>
                                <li><strong>Decis√£o:</strong> A decis√£o ser√° comunicada ao l√≠der da unidade em at√© 48
                                    horas. A decis√£o da diretoria √© final e irrevog√°vel.</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sobre o Clube Section -->
            <section id="sobre" class="content-section">
                <h2 class="text-3xl font-bold text-center mb-8 text-slate-700">Sobre o Clube de Desbravadores</h2>
                <p class="mb-6 text-slate-700 text-center">Conhe√ßa os fundamentos, a hist√≥ria e a estrutura que guiam o
                    Clube de Desbravadores, um movimento mundial dedicado ao desenvolvimento integral de juvenis e
                    adolescentes.</p>
                <div class="space-y-4">
                    <div class="bg-white rounded-xl shadow-md">
                        <button
                            class="accordion-button w-full text-left p-6 font-bold text-xl text-blue-800 flex justify-between items-center">
                            <span>As Bases do Clube</span>
                            <span class="transform transition-transform duration-300">‚ñº</span>
                        </button>
                        <div id="bases-content" class="accordion-content px-6 pb-6 text-slate-600 space-y-4">
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md">
                        <button
                            class="accordion-button w-full text-left p-6 font-bold text-xl text-blue-800 flex justify-between items-center">
                            <span>Estrutura e Fun√ß√µes</span>
                            <span class="transform transition-transform duration-300">‚ñº</span>
                        </button>
                        <div id="funcoes-content" class="accordion-content px-6 pb-6 text-slate-600 space-y-4">
                        </div>
                    </div>
                </div>
            </section>

            <!-- Gest√£o Section (Leader/Secretary Dashboard) -->
            <section id="gestao" class="content-section">
                <h2 class="text-3xl font-bold text-center mb-8 text-slate-700" id="gestao-title">Carregando Gest√£o...
                </h2>
                <div id="gestao-content">
                    <!-- Content will be injected here based on user role -->
                </div>
            </section>
        </main>
    </div>

    <script>
        // Data definitions (static content)
        const staticData = {
            calendar: {
                "Junho: M√™s do Pioneirismo e da Natureza": [
                    { date: "08/06/2025", title: "Constru√ß√£o de Abrigo Improvisado", desc: "Cada unidade deve construir um abrigo simples e funcional usando materiais naturais ou lona/corda, capaz de proteger minimamente de intemp√©ries. (Pioneirismo)" },
                    { date: "15/06/2025", title: "Trilha de Observa√ß√£o e Registro", desc: "Caminhada em trilha segura com uma lista de itens da natureza para encontrar, identificar e registrar (fotos, desenhos ou anota√ß√µes). (Natureza)" },
                    { date: "22/06/2025", title: "Cozinha Mateira Criativa", desc: "Preparar um lanche simples e saboroso ao ar livre utilizando t√©cnicas de fogueira segura. Criatividade na receita e seguran√ßa no manuseio do fogo ser√£o avaliadas. (Culin√°ria/Pioneirismo)" },
                    { date: "29/06/2025", title: "Ca√ßa ao Tesouro da Orienta√ß√£o", desc: "Utilizando b√∫ssola e um mapa simples, as unidades devem seguir pistas para encontrar um tesouro escondido. (Orienta√ß√£o)" }
                ],
                "Julho: M√™s da Sa√∫de e Bem-Estar": [
                    { date: "06/07/2025", title: "Circuito de Habilidades F√≠sicas", desc: "Montagem de um circuito com 5 a 7 esta√ß√µes que envolvam corrida, salto, agachamento, flex√£o, polichinelos (adaptadas √† idade e capacidade). As unidades competem para completar o circuito no menor tempo, com boa execu√ß√£o. (F√≠sico)" },
                    { date: "13/07/2025", title: "Oficina de Primeiros Socorros B√°sicos", desc: "Simula√ß√£o de situa√ß√µes de emerg√™ncia comuns (pequenos cortes, entorses, picadas de inseto). As unidades devem demonstrar como fazer curativos simples, imobilizar um bra√ßo, estancar sangramento e acionar ajuda. (Primeiros Socorros)" },
                    { date: "20/07/2025", title: "Gincana Esportiva L√∫dica", desc: "Competi√ß√µes de jogos populares e cooperativos como cabo de guerra, corrida de saco, queimada (com regras adaptadas para seguran√ßa e inclus√£o). O esp√≠rito esportivo e a divers√£o ser√£o valorizados. (F√≠sico/Integra√ß√£o)" },
                    { date: "27/07/2025", title: "Culin√°ria Saud√°vel Desbravador", desc: "Cada unidade prepara uma receita saud√°vel e saborosa (ex: salada de frutas criativa, sandu√≠ches naturais, sucos detox). A apresenta√ß√£o, o sabor e a explica√ß√£o dos benef√≠cios nutricionais ser√£o avaliadas. (Culin√°ria/Sa√∫de)" }
                ],
                "Agosto: M√™s da Comunica√ß√£o e Express√£o": [
                    { date: "03/08/2025", title: "Teatro de Fantoches/M√≠mica com Mensagem", desc: "Cada unidade cria e apresenta uma pequena pe√ßa de teatro de fantoches ou uma esquete de m√≠mica com uma mensagem positiva ou um ensinamento moral (ex: sobre honestidade, amizade, respeito). (Criatividade/Express√£o)" },
                    { date: "10/08/2025", title: "Campanha de Conscientiza√ß√£o Criativa", desc: "As unidades devem desenvolver uma pequena campanha de conscientiza√ß√£o sobre um tema relevante para a comunidade (ex: reciclagem, combate ao bullying, import√¢ncia da leitura). Podem ser cartazes, v√≠deos curtos (para exibi√ß√£o interna), jingles ou pequenas apresenta√ß√µes. (Servi√ßo/Comunica√ß√£o)" },
                    { date: "17/08/2025", title: "Roda de Conversa: Meus Sonhos e Talentos", desc: "Em um ambiente acolhedor, cada Desbravador compartilha um sonho pessoal ou um talento que possui/gostaria de desenvolver. A escuta ativa e o apoio m√∫tuo s√£o incentivados. (Espiritual/Social)" },
                    { date: "24/08/2025", title: "Visita e A√ß√£o de Doa√ß√£o a uma Institui√ß√£o", desc: "A unidade organiza e realiza uma visita a um asilo, orfanato ou institui√ß√£o de caridade (com permiss√£o e acompanhamento da diretoria), levando doa√ß√µes (arrecadadas previamente) e, se poss√≠vel, realizando uma pequena apresenta√ß√£o ou atividade interativa. (Servi√ßo Comunit√°rio)" },
                    { date: "31/08/2025", title: "Descanso/Prepara√ß√£o para Setembro", desc: "Dia livre para atividades de autocuidado e reflex√£o individual." }
                ],
                "Setembro: M√™s do Conhecimento e da Hist√≥ria": [
                    { date: "07/09/2025", title: "Gincana do Conhecimento Desbravador", desc: "Uma competi√ß√£o de perguntas e respostas sobre a hist√≥ria do clube, seus ideais (Voto e Lei), classes, especialidades e regulamentos b√°sicos. (Mental)" },
                    { date: "14/09/2025", title: "Estudo B√≠blico Aprofundado e Apresenta√ß√£o", desc: "Cada unidade escolhe um tema b√≠blico (ex: a cria√ß√£o, a hist√≥ria de Jos√©, os milagres de Jesus) e prepara um pequeno estudo para apresentar de forma criativa (com slides, desenhos, encena√ß√£o) para as outras unidades. (Espiritual/Mental)" },
                    { date: "21/09/2025", title: "Projeto de Civismo 'Minha P√°tria, Minha Hist√≥ria'", desc: "Pesquisar sobre um her√≥i nacional, um s√≠mbolo do pa√≠s (bandeira, hino) ou um evento hist√≥rico importante. As unidades devem apresentar suas descobertas de forma criativa (mural, jogral, v√≠deo). (C√≠vico/Mental)" },
                    { date: "28/09/2025", title: "Cria√ß√£o de um 'Museu' do Clube", desc: "Cada unidade monta um pequeno painel ou 'exposi√ß√£o' com fotos, objetos, distintivos e hist√≥rias que representem a trajet√≥ria da sua unidade e do clube. (Hist√≥ria/Criatividade)" }
                ],
                "Outubro: M√™s da Aventura e da Supera√ß√£o": [
                    { date: "05/10/2025", title: "Circuito de Aventura 'Desbravador Radical'", desc: "Montar um circuito com obst√°culos (rastejar sob cordas, pular pneus, passar por t√∫neis improvisados, escalar baixo em estruturas seguras) que exija coordena√ß√£o, agilidade e trabalho em equipe. (F√≠sico/Mental)" },
                    { date: "12/10/2025", title: "Desafio de Sobreviv√™ncia (Te√≥rico e Pr√°tico)", desc: "Simula√ß√£o de situa√ß√µes de sobreviv√™ncia. As unidades devem demonstrar habilidades como purificar √°gua (te√≥rico), fazer um sinal de socorro, montar uma pequena armadilha (segura e n√£o-letal), identificar plantas seguras para consumo (te√≥rico). (Pioneirismo/Mental)" },
                    { date: "19/10/2025", title: "Jogo Noturno 'Mist√©rio da Mata'", desc: "Um jogo de estrat√©gia ou ca√ßa ao tesouro em ambiente escuro (com lanternas e supervis√£o rigorosa), onde as unidades precisam usar a audi√ß√£o, tato e trabalho em equipe para cumprir objetivos. (Mental/F√≠sico)" },
                    { date: "26/10/2025", title: "Desafio de Resolu√ß√£o de Problemas 'A Ponte da Unidade'", desc: "Apresentar um problema complexo para as unidades, como 'construir uma ponte que suporte um peso X usando apenas materiais Y e Z'. A criatividade e a efic√°cia da solu√ß√£o ser√£o avaliadas. (Mental/Engenharia)" }
                ],
                "Novembro: M√™s da Gratid√£o e da Celebra√ß√£o": [
                    { date: "02/11/2025", title: "Prepara√ß√£o da C√°psula do Tempo da Gincana", desc: "Cada unidade re√∫ne objetos simb√≥licos, fotos, mensagens e relatos sobre suas experi√™ncias na gincana. A c√°psula ser√° lacrada e aberta em uma data futura (ex: daqui a 1 ano), para relembrar as conquistas. (Criatividade/Reflex√£o)" },
                    { date: "09/11/2025", title: "Dia da Gratid√£o e Servi√ßo Comunit√°rio", desc: "A√ß√µes de servi√ßo focadas em expressar gratid√£o √† comunidade ou √† igreja. Exemplos: limpeza e organiza√ß√£o do local do clube, ajuda em eventos da igreja, prepara√ß√£o de cestas b√°sicas para doa√ß√£o. (Servi√ßo/Espiritual)" },
                    { date: "16/11/2025", title: "Ensaio Geral para a Celebra√ß√£o Final", desc: "As unidades praticam quaisquer apresenta√ß√µes, cantos, jograis ou n√∫meros de Ordem Unida que desejam apresentar no evento de encerramento. Este √© um momento de integra√ß√£o e aprimoramento. (Integra√ß√£o)" },
                    { date: "23/11/2025", title: "Grande Jogo Final 'A Jornada do Desbravador'", desc: "Uma atividade abrangente que combina elementos de todos os meses, testando diversas habilidades (f√≠sicas, mentais, de pioneirismo, etc.) e o esp√≠rito de equipe. Pode ser um circuito de esta√ß√µes, um jogo de tabuleiro gigante ou uma grande ca√ßa ao tesouro com desafios variados. (Revis√£o/Integra√ß√£o)" },
                    { date: "30/11/2025", title: "√öltima revis√£o e prepara√ß√£o para a Celebra√ß√£o Final", desc: "Dia dedicado aos √∫ltimos preparativos para o grande evento de encerramento da gincana." }
                ],
                "Dezembro: Grande Celebra√ß√£o e Encerramento": [
                    { date: "01/12/2025", title: "Grande Celebra√ß√£o e Encerramento da Gincana", desc: "Um evento especial com a presen√ßa dos pais, familiares e da comunidade, para celebrar as conquistas da gincana. Incluir√° apresenta√ß√µes das unidades, reconhecimento, a revela√ß√£o do placar final e premia√ß√£o, uma mensagem final inspiradora dos l√≠deres e confraterniza√ß√£o." }
                ]
            },
            bases: [
                { title: "Origem Hist√≥rica", content: "O Clube de Desbravadores foi oficializado em n√≠vel mundial no ano de 1950 pela Associa√ß√£o Geral da Igreja Adventista do S√©timo Dia, nos Estados Unidos. Suas ra√≠zes, no entanto, remontam a iniciativas anteriores de clubes mission√°rios e de jovens que buscavam o desenvolvimento integral." },
                { title: "Filosofia", content: "A filosofia do Clube de Desbravadores baseia-se no desenvolvimento harmonioso das for√ßas f√≠sicas, mentais e espirituais dos juvenis e adolescentes. O programa busca preparar os jovens para a cidadania √∫til, o servi√ßo √† comunidade e o compromisso com Deus. Tudo o que o Desbravador faz tem um sentido, uma base, um alicerce de valores crist√£os e princ√≠pios de vida." },
                { title: "Objetivos Priorit√°rios", content: "Os objetivos do Clube s√£o amplos e visam o crescimento completo do indiv√≠duo: Desenvolvimento F√≠sico, Mental, Espiritual e Social." },
                { title: "S√≠mbolos do Clube", content: "Os s√≠mbolos do Desbravador s√£o elementos visuais e conceituais que representam seus princ√≠pios: Ideais (Voto e Lei), Hino, Emblemas, Bandeira, Bandeirim e o Uniforme." }
            ],
            funcoes: {
                "Cargos da Unidade": [
                    { title: "Conselheiro(a)", content: "√â a autoridade m√°xima dentro da unidade, respons√°vel pela ordem e andamento geral. Atua como elo entre a unidade e a dire√ß√£o do clube. Geralmente, deve ser batizado e ter mais de 18 anos (ou 16+ com supervis√£o de um diretor maior de idade em atividades externas)." },
                    { title: "Capit√£o(√£)", content: "Membro da unidade (10 a 15 anos) respons√°vel por animar o grupo a cumprir o programa, por meio do exemplo e influ√™ncia pessoal. Lidera a unidade em forma√ß√µes de Ordem Unida e a representa perante a dire√ß√£o. Deve ser organizado, ter lideran√ßa, disciplina, honestidade, fidelidade e humildade." },
                    { title: "Secret√°rio(a) de Unidade", content: "Respons√°vel por manter os registos da unidade atualizados, incluindo chamada de presen√ßa, pontualidade, assiduidade, uso do uniforme e higiene pessoal. Idade entre 10 e 15 anos." },
                    { title: "Tesoureiro(a) de Unidade", content: "Gerencia os pequenos recursos financeiros da unidade, mantendo registos precisos de despesas e receitas. Idade entre 10 e 15 anos." },
                    { title: "Padioleiro(a) de Unidade", content: "Atua como o 'enfermeiro' da unidade, respons√°vel por auxiliar em pequenos acidentes e aplicar primeiros socorros b√°sicos, sob supervis√£o. Idade entre 10 e 15 anos." },
                    { title: "Almoxarife de Unidade", content: "Respons√°vel pela guarda e organiza√ß√£o dos materiais e equipamentos da unidade. Idade entre 10 e 15 anos." },
                    { title: "Capel√£o(√£) de Unidade", content: "Mant√©m a ordem e harmonia espiritual da unidade, juntamente com o conselheiro, promovendo momentos de reflex√£o e estudo b√≠blico. Idade entre 10 e 15 anos, deve ser de boa √≠ndole e respeitador." }
                ],
                "Cargos da Dire√ß√£o do Clube": [
                    { title: "Diretor(a) do Clube", content: "√â a autoridade m√°xima do clube. Respons√°vel por planejar, organizar e supervisionar todas as atividades, manter a liga√ß√£o com o Pastor e a Associa√ß√£o, presidir as reuni√µes da comiss√£o executiva e docente, e assegurar um programa completo para o clube. Deve ser um l√≠der maduro, com boa reputa√ß√£o na Igreja e ter o treinamento para oficiais. Deve ser um exemplo de espiritualidade, prontid√£o, amabilidade, temperan√ßa, pontualidade e asseio pessoal, incluindo o uso adequado do uniforme." },
                    { title: "Diretores(as) Associados(as)", content: "S√£o o bra√ßo direito do diretor, respons√°veis pelo cumprimento do programa do clube. Coordenam as Classes, Especialidades e Unidades, gerenciando o trabalho dos instrutores e conselheiros. Geralmente h√° um diretor associado para a ala feminina e outro para a ala masculina. N√£o h√° limite para o n√∫mero de diretores associados, dependendo do tamanho do clube." },
                    { title: "Secret√°rio(a) do Clube", content: "Assume a responsabilidade pela documenta√ß√£o e registo das atividades do clube. Isso abrange a manuten√ß√£o de registos de membros, elabora√ß√£o de relat√≥rios de eventos e comunica√ß√£o de informa√ß√µes cruciais aos membros e suas fam√≠lias. Essencial para a organiza√ß√£o administrativa do clube." },
                    { title: "Tesoureiro(a) do Clube", content: "Gerencia as finan√ßas do clube, mantendo um registo preciso das despesas e receitas, elaborando or√ßamentos e assegurando o uso respons√°vel dos recursos financeiros dispon√≠veis. Respons√°vel pela sa√∫de financeira do clube." },
                    { title: "Capel√£o(√£) do Clube", content: "Encarregado da dimens√£o espiritual do clube, liderando estudos b√≠blicos, momentos de ora√ß√£o e promovendo os valores e princ√≠pios inerentes √† cren√ßa Adventista do S√©timo Dia. Essencial para o desenvolvimento espiritual dos Desbravadores." },
                    { title: "Conselheiros(as) (Gerais) e Instrutores(as)", content: "Os conselheiros supervisionam as unidades, enquanto os instrutores s√£o respons√°veis por ensinar as classes e especialidades. Ambos trabalham em estreita colabora√ß√£o com os diretores associados para garantir a execu√ß√£o do programa educativo do clube. A fun√ß√£o de conselheiro √© considerada uma das mais importantes, devido ao contato direto com os juvenis." }
                ]
            }
        };

        let chartInstance = null;
        let currentUnits = [];
        let currentActivities = [];
        let currentSubmissions = [];

        // Global functions for Firebase data operations
        async function getUnits() {
            const unitsColRef = collection(window.db, 'artifacts', window.appId, 'public', 'data', 'units');
            const q = query(unitsColRef);
            return new Promise((resolve, reject) => {
                onSnapshot(q, (snapshot) => {
                    currentUnits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    currentUnits.sort((a, b) => (b.score || 0) - (a.score || 0)); // Sort by score descending
                    resolve(currentUnits);
                }, reject);
            });
        }

        async function getActivities() {
            const activitiesColRef = collection(window.db, 'artifacts', window.appId, 'public', 'data', 'activities');
            const q = query(activitiesColRef);
            return new Promise((resolve, reject) => {
                onSnapshot(q, (snapshot) => {
                    currentActivities = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    resolve(currentActivities);
                }, reject);
            });
        }

        async function getSubmissions() {
            const submissionsColRef = collection(window.db, 'artifacts', window.appId, 'public', 'data', 'submissions');
            const q = query(submissionsColRef);
            return new Promise((resolve, reject) => {
                onSnapshot(q, (snapshot) => {
                    currentSubmissions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    currentSubmissions.sort((a, b) => b.submittedAt?.toDate() - a.submittedAt?.toDate()); // Sort by newest
                    resolve(currentSubmissions);
                }, reject);
            });
        }


        // --- UI RENDER FUNCTIONS ---
        function wrapLabel(label, maxLen) {
            if (label.length <= maxLen) return label;
            let wrappedLabel = '';
            let words = label.split(' ');
            let currentLine = '';
            for (let i = 0; i < words.length; i++) {
                let word = words[i];
                if ((currentLine + word).length <= maxLen) {
                    currentLine += (currentLine === '' ? '' : ' ') + word;
                } else {
                    wrappedLabel += currentLine + '\n';
                    currentLine = word;
                }
            }
            wrappedLabel += currentLine;
            return wrappedLabel;
        }

        function renderDashboard() {
            const totalScore = currentUnits.reduce((sum, item) => sum + (item.score || 0), 0);
            const totalActivitiesDefined = Object.values(staticData.calendar).flat().length;
            const approvedSubmissionsCount = currentSubmissions.filter(sub => sub.status === 'approved').length;

            document.getElementById('unidade-destaque').textContent = currentUnits.length > 0 ? currentUnits[0].unit : 'N/A';
            document.getElementById('total-pontos').textContent = totalScore;
            document.getElementById('atividades-realizadas').textContent = `${approvedSubmissionsCount} / ${totalActivitiesDefined}`;

            renderScoreChart(currentUnits);
        }

        function renderScoreChart(unitsData) {
            const ctx = document.getElementById('scoreChart').getContext('2d');
            if (chartInstance) {
                chartInstance.destroy();
            }
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: unitsData.map(item => wrapLabel(item.name, 16)),
                    datasets: [{
                        label: 'Pontua√ß√£o da Unidade',
                        data: unitsData.map(item => item.score || 0),
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1,
                        borderRadius: 5,
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `${context.dataset.label}: ${context.raw} pontos`;
                                }
                            }
                        },
                        // Ensure labels are wrapped for better readability on smaller charts
                        // This is a custom plugin or a callback on the scale ticks
                        // For Chart.js v3+, you might need a custom plugin for multi-line labels on Y-axis
                        // Example (simplified, may need adjustment for specific Chart.js version):
                        // afterBuildTicks: function(axis) {
                        //     axis.ticks = axis.ticks.map(tick => ({
                        //         value: tick.value,
                        //         label: wrapLabel(tick.label, 15) // Wrap at 15 characters
                        //     }));
                        // }
                    }
                    ,
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                display: true,
                                color: 'rgba(203, 213, 225, 0.5)'
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                callback: function (value, index, ticks) {
                                    return wrapLabel(this.getLabelForValue(value), 16); // Apply wrapping to Y-axis labels
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderCalendar() {
            const container = document.getElementById('calendario-container');
            container.innerHTML = '';
            Object.entries(staticData.calendar).forEach(([month, activities]) => {
                const monthDiv = document.createElement('div');
                monthDiv.className = 'bg-white rounded-xl shadow-md';

                const button = document.createElement('button');
                button.className = 'accordion-button w-full text-left p-6 font-bold text-xl text-blue-800 flex justify-between items-center';
                button.innerHTML = `<span>${month}</span><span class="transform transition-transform duration-300">‚ñº</span>`;

                const contentDiv = document.createElement('div');
                contentDiv.className = 'accordion-content px-6 pb-6 text-slate-600 space-y-4';

                activities.forEach(activity => {
                    contentDiv.innerHTML += `
                        <div class="pt-4 border-t first:border-t-0 border-slate-200">
                            <p class="font-semibold text-slate-700">${activity.date} - ${activity.title}</p>
                            <p class="text-sm">${activity.desc}</p>
                        </div>
                    `;
                });

                monthDiv.appendChild(button);
                monthDiv.appendChild(contentDiv);
                container.appendChild(monthDiv);
            });
        }

        function renderAbout() {
            const basesContainer = document.getElementById('bases-content');
            basesContainer.innerHTML = staticData.bases.map(item => `<div class="pt-4 border-t first:border-t-0 border-slate-200"><h4 class="font-bold text-lg text-slate-700">${item.title}</h4><p>${item.content}</p></div>`).join('');

            const funcoesContainer = document.getElementById('funcoes-content');
            funcoesContainer.innerHTML = '';
            Object.entries(staticData.funcoes).forEach(([category, roles]) => {
                let categoryHtml = `<h4 class="font-bold text-lg text-slate-700 pt-4 border-t first:border-t-0 border-slate-200">${category}</h4><ul class="list-disc list-inside list-disc-custom space-y-2">`;
                roles.forEach(role => {
                    categoryHtml += `<li><strong>${role.title}:</strong> ${role.content}</li>`;
                });
                categoryHtml += `</ul>`;
                funcoesContainer.innerHTML += categoryHtml;
            });
        }

        // --- MANAGEMENT DASHBOARDS (LEADER/SECRETARY) ---

        function renderUnitLeaderDashboard() {
            document.getElementById('gestao-title').textContent = 'Dashboard do L√≠der de Unidade';
            const gestaoContent = document.getElementById('gestao-content');
            gestaoContent.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h3 class="text-xl font-semibold text-blue-600 mb-4">Enviar Atividade Conclu√≠da</h3>
                    <form id="submit-activity-form" class="space-y-4 mb-8">
                        <div>
                            <label for="unit-select-leader" class="block text-sm font-medium text-slate-700">Sua Unidade:</label>
                            <select id="unit-select-leader" class="mt-1 block w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="">Selecione sua unidade</option>
                            </select>
                            <p id="no-units-message" class="text-red-500 text-sm mt-2 hidden">Nenhuma unidade encontrada. Pe√ßa ao secret√°rio para cadastrar as unidades.</p>
                        </div>
                        <div>
                            <label for="activity-select-leader" class="block text-sm font-medium text-slate-700">Atividade:</label>
                            <select id="activity-select-leader" class="mt-1 block w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="">Selecione uma atividade</option>
                            </select>
                            <p id="no-activities-message" class="text-red-500 text-sm mt-2 hidden">Nenhuma atividade cadastrada. Pe√ßa ao secret√°rio para cadastrar as atividades.</p>
                        </div>
                        <div>
                            <label for="details-leader" class="block text-sm font-medium text-slate-700">Detalhes da Conclus√£o (O que foi feito?):</label>
                            <textarea id="details-leader" rows="4" class="mt-1 block w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Descreva como a atividade foi conclu√≠da..." required></textarea>
                        </div>
                        <div>
                            <label for="photo-url-leader" class="block text-sm font-medium text-slate-700">Link da Foto/Evid√™ncia (Opcional):</label>
                            <input type="text" id="photo-url-leader" class="mt-1 block w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: https://linkdafoto.com/minhafoto.jpg">
                            <p class="text-xs text-slate-500 mt-1">Em uma aplica√ß√£o real, aqui haveria um upload de arquivo. Por enquanto, insira um link.</p>
                        </div>
                        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">Enviar para Valida√ß√£o</button>
                    </form>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold text-blue-600 mb-4">Meus Envios Recentes</h3>
                    <div id="leader-submissions-list">
                        <p class="text-slate-600">Nenhum envio feito ainda para esta unidade.</p>
                    </div>
                </div>
            `;

            const unitSelectLeader = document.getElementById('unit-select-leader');
            const activitySelectLeader = document.getElementById('activity-select-leader');
            const noUnitsMessage = document.getElementById('no-units-message');
            const noActivitiesMessage = document.getElementById('no-activities-message');

            if (currentUnits.length > 0) {
                unitSelectLeader.innerHTML = currentUnits.map(unit => `<option value="${unit.id}">${unit.name}</option>`).join('');
                unitSelectLeader.value = currentUnits[0].id; // Select first unit by default
                noUnitsMessage.classList.add('hidden');
            } else {
                noUnitsMessage.classList.remove('hidden');
            }

            if (currentActivities.length > 0) {
                activitySelectLeader.innerHTML = '<option value="">Selecione uma atividade</option>' + currentActivities.map(activity => `<option value="${activity.id}">${activity.name} (${activity.type})</option>`).join('');
                noActivitiesMessage.classList.add('hidden');
            } else {
                noActivitiesMessage.classList.remove('hidden');
            }

            document.getElementById('submit-activity-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const selectedUnitId = unitSelectLeader.value;
                const activityId = activitySelectLeader.value;
                const details = document.getElementById('details-leader').value;
                const photoUrl = document.getElementById('photo-url-leader').value;

                if (!selectedUnitId || !activityId || !details.trim()) {
                    window.showMessage("Por favor, preencha todos os campos obrigat√≥rios (Unidade, Atividade e Detalhes).");
                    return;
                }

                const activity = currentActivities.find(act => act.id === activityId);
                if (!activity) {
                    window.showMessage("Atividade selecionada inv√°lida.");
                    return;
                }

                try {
                    const submissionsColRef = collection(window.db, 'artifacts', window.appId, 'public', 'data', 'submissions');
                    await addDoc(submissionsColRef, {
                        unitId: selectedUnitId,
                        unitName: currentUnits.find(u => u.id === selectedUnitId)?.name || 'Unidade Desconhecida',
                        activityId: activityId,
                        activityName: activity.name,
                        details: details,
                        photoUrl: photoUrl,
                        status: 'pending',
                        submittedBy: window.currentUser.uid,
                        submittedAt: serverTimestamp(),
                    });
                    window.showMessage("Atividade enviada para valida√ß√£o com sucesso!");
                    document.getElementById('submit-activity-form').reset();
                } catch (error) {
                    console.error("Erro ao enviar atividade:", error);
                    window.showMessage("Erro ao enviar atividade. Tente novamente.");
                }
            });

            function updateLeaderSubmissionsList(selectedUnitId) {
                const leaderSubmissionsList = document.getElementById('leader-submissions-list');
                const unitSubmissions = currentSubmissions.filter(sub => sub.unitId === selectedUnitId);

                if (unitSubmissions.length === 0) {
                    leaderSubmissionsList.innerHTML = '<p class="text-slate-600">Nenhum envio feito ainda para esta unidade.</p>';
                    return;
                }

                let tableHtml = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead class="bg-blue-100">
                                <tr>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700 rounded-tl-lg">Atividade</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Detalhes</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Status</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Pontos</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700 rounded-tr-lg">Data</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                unitSubmissions.forEach(sub => {
                    const statusClass = sub.status === 'pending' ? 'pending' : (sub.status === 'approved' ? 'approved' : 'rejected');
                    tableHtml += `
                        <tr class="border-b border-slate-200 last:border-b-0 hover:bg-slate-50">
                            <td class="py-3 px-4 text-sm">${sub.activityName}</td>
                            <td class="py-3 px-4 text-sm max-w-xs truncate">${sub.details}</td>
                            <td class="py-3 px-4 text-sm">
                                <span class="px-2 py-1 rounded-full text-xs font-semibold status-badge ${statusClass}">
                                    ${sub.status === 'pending' ? 'Pendente' : (sub.status === 'approved' ? 'Aprovado' : 'Rejeitado')}
                                </span>
                            </td>
                            <td class="py-3 px-4 text-sm font-bold">${sub.pointsAwarded || 'N/A'}</td>
                            <td class="py-3 px-4 text-sm">
                                ${sub.submittedAt ? new Date(sub.submittedAt.toDate()).toLocaleDateString('pt-BR') : 'N/A'}
                            </td>
                        </tr>
                    `;
                });
                tableHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
                leaderSubmissionsList.innerHTML = tableHtml;
            }

            unitSelectLeader.addEventListener('change', (e) => {
                updateLeaderSubmissionsList(e.target.value);
            });

            // Initial render of leader submissions based on default selected unit
            if (unitSelectLeader.value) {
                updateLeaderSubmissionsList(unitSelectLeader.value);
            }
        }

        function renderSecretaryDashboard() {
            document.getElementById('gestao-title').textContent = 'Dashboard do Secret√°rio do Clube';
            const gestaoContent = document.getElementById('gestao-content');
            gestaoContent.innerHTML = `
                <!-- Gerenciamento de Unidades -->
                <section class="mb-8 p-4 bg-blue-50 rounded-xl shadow-inner">
                    <h3 class="text-xl font-semibold text-blue-600 mb-4">Gerenciar Unidades</h3>
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <input type="text" id="new-unit-name" placeholder="Nome da nova unidade" class="flex-grow p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <button id="add-unit-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">Adicionar Unidade</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead class="bg-blue-100">
                                <tr>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700 rounded-tl-lg">Unidade</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Pontua√ß√£o</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700 rounded-tr-lg">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="units-table-body">
                                <tr><td colspan="3" class="py-4 px-4 text-center text-slate-600">Nenhuma unidade cadastrada.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Gerenciamento de Atividades -->
                <section class="mb-8 p-4 bg-green-50 rounded-xl shadow-inner">
                    <h3 class="text-xl font-semibold text-green-600 mb-4">Gerenciar Atividades</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <input type="text" id="new-activity-name" placeholder="Nome da atividade" class="p-3 border border-slate-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                        <select id="new-activity-type" class="p-3 border border-slate-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                            <option value="">Tipo (F√≠sico, Mental, Espiritual, etc.)</option>
                            <option value="F√≠sico">F√≠sico</option>
                            <option value="Mental">Mental</option>
                            <option value="Espiritual">Espiritual</option>
                            <option value="Social">Social</option>
                            <option value="Pioneirismo">Pioneirismo</option>
                            <option value="Natureza">Natureza</option>
                            <option value="Servi√ßo">Servi√ßo Comunit√°rio</option>
                            <option value="Culin√°ria">Culin√°ria</option>
                            <option value="Geral">Geral</option>
                        </select>
                        <input type="number" id="new-activity-max-points" placeholder="Pontua√ß√£o M√°xima" class="p-3 border border-slate-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                    </div>
                    <button id="add-activity-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">Adicionar Atividade</button>
                    <div class="overflow-x-auto mt-6">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead class="bg-green-100">
                                <tr>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700 rounded-tl-lg">Atividade</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Tipo</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Pontos M√°x.</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700 rounded-tr-lg">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="activities-table-body">
                                <tr><td colspan="4" class="py-4 px-4 text-center text-slate-600">Nenhuma atividade cadastrada.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Valida√ß√£o de Envios Pendentes -->
                <section class="mb-8 p-4 bg-yellow-50 rounded-xl shadow-inner">
                    <h3 class="text-xl font-semibold text-yellow-800 mb-4">Envios Pendentes para Valida√ß√£o (<span id="pending-submissions-count">0</span>)</h3>
                    <div id="pending-submissions-list">
                        <p class="text-slate-600">Nenhum envio pendente no momento.</p>
                    </div>
                </section>

                <!-- Hist√≥rico de Envios -->
                <section class="mb-8 p-4 bg-slate-50 rounded-xl shadow-inner">
                    <h3 class="text-xl font-semibold text-slate-700 mb-4">Hist√≥rico de Todos os Envios</h3>
                    <div id="all-submissions-list">
                        <p class="text-slate-600">Nenhum envio registrado ainda.</p>
                    </div>
                </section>
            `;

            // Unit Management
            document.getElementById('add-unit-btn').addEventListener('click', async () => {
                const newUnitName = document.getElementById('new-unit-name').value.trim();
                if (!newUnitName) {
                    window.showMessage("O nome da unidade n√£o pode ser vazio.");
                    return;
                }
                try {
                    const unitsColRef = collection(window.db, 'artifacts', window.appId, 'public', 'data', 'units');
                    await addDoc(unitsColRef, { name: newUnitName, score: 0, createdAt: serverTimestamp() });
                    window.showMessage(`Unidade "${newUnitName}" adicionada com sucesso!`);
                    document.getElementById('new-unit-name').value = '';
                } catch (error) {
                    console.error("Erro ao adicionar unidade:", error);
                    window.showMessage("Erro ao adicionar unidade. Tente novamente.");
                }
            });

            // Activity Management
            document.getElementById('add-activity-btn').addEventListener('click', async () => {
                const name = document.getElementById('new-activity-name').value.trim();
                const type = document.getElementById('new-activity-type').value;
                const maxPoints = parseInt(document.getElementById('new-activity-max-points').value);

                if (!name || !type || isNaN(maxPoints) || maxPoints < 0) {
                    window.showMessage("Por favor, preencha todos os campos da atividade corretamente.");
                    return;
                }
                try {
                    const activitiesColRef = collection(window.db, 'artifacts', window.appId, 'public', 'data', 'activities');
                    await addDoc(activitiesColRef, { name, type, maxPoints, createdAt: serverTimestamp() });
                    window.showMessage(`Atividade "${name}" adicionada com sucesso!`);
                    document.getElementById('new-activity-name').value = '';
                    document.getElementById('new-activity-type').value = '';
                    document.getElementById('new-activity-max-points').value = '';
                } catch (error) {
                    console.error("Erro ao adicionar atividade:", error);
                    window.showMessage("Erro ao adicionar atividade. Tente novamente.");
                }
            });

            // Real-time updates for Secretary Dashboard
            const unsubscribeUnits = onSnapshot(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'units'), (snapshot) => {
                currentUnits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                currentUnits.sort((a, b) => (b.score || 0) - (a.score || 0));
                updateUnitsTable();
                renderDashboard(); // Update dashboard when units change
            }, (error) => console.error("Erro ao carregar unidades (Secret√°rio):", error));

            const unsubscribeActivities = onSnapshot(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'activities'), (snapshot) => {
                currentActivities = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateActivitiesTable();
            }, (error) => console.error("Erro ao carregar atividades (Secret√°rio):", error));

            const unsubscribeSubmissions = onSnapshot(collection(window.db, 'artifacts', window.appId, 'public', 'data', 'submissions'), (snapshot) => {
                currentSubmissions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                currentSubmissions.sort((a, b) => b.submittedAt?.toDate() - a.submittedAt?.toDate());
                updateSubmissionsTables();
                renderDashboard(); // Update dashboard when submissions change
            }, (error) => console.error("Erro ao carregar envios (Secret√°rio):", error));

            function updateUnitsTable() {
                const tbody = document.getElementById('units-table-body');
                if (!tbody) return;
                if (currentUnits.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="py-4 px-4 text-center text-slate-600">Nenhuma unidade cadastrada.</td></tr>';
                } else {
                    tbody.innerHTML = currentUnits.map(unit => `
                        <tr class="border-b border-slate-200 last:border-b-0 hover:bg-slate-50">
                            <td class="py-3 px-4 text-sm">${unit.name}</td>
                            <td class="py-3 px-4 text-sm font-bold">${unit.score || 0}</td>
                            <td class="py-3 px-4 text-sm">
                                <button data-id="${unit.id}" data-name="${unit.name}" class="delete-unit-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-xs transition duration-300 ease-in-out transform hover:scale-105">Excluir</button>
                            </td>
                        </tr>
                    `).join('');
                    tbody.querySelectorAll('.delete-unit-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => handleDeleteUnit(e.target.dataset.id, e.target.dataset.name));
                    });
                }
            }

            async function handleDeleteUnit(unitId, unitName) {
                window.showMessage(`Tem certeza que deseja excluir a unidade "${unitName}"? Isso remover√° todos os seus dados.`, async (confirmed) => {
                    if (confirmed) {
                        try {
                            const unitDocRef = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'units', unitId);
                            await deleteDoc(unitDocRef);
                            window.showMessage(`Unidade "${unitName}" exclu√≠da com sucesso!`);
                        } catch (error) {
                            console.error("Erro ao excluir unidade:", error);
                            window.showMessage("Erro ao excluir unidade. Tente novamente.");
                        }
                    }
                }, true);
            }

            function updateActivitiesTable() {
                const tbody = document.getElementById('activities-table-body');
                if (!tbody) return;
                if (currentActivities.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="py-4 px-4 text-center text-slate-600">Nenhuma atividade cadastrada.</td></tr>';
                } else {
                    tbody.innerHTML = currentActivities.map(activity => `
                        <tr class="border-b border-slate-200 last:border-b-0 hover:bg-slate-50">
                            <td class="py-3 px-4 text-sm">${activity.name}</td>
                            <td class="py-3 px-4 text-sm">${activity.type}</td>
                            <td class="py-3 px-4 text-sm font-bold">${activity.maxPoints}</td>
                            <td class="py-3 px-4 text-sm">
                                <button data-id="${activity.id}" data-name="${activity.name}" class="delete-activity-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-xs transition duration-300 ease-in-out transform hover:scale-105">Excluir</button>
                            </td>
                        </tr>
                    `).join('');
                    tbody.querySelectorAll('.delete-activity-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => handleDeleteActivity(e.target.dataset.id, e.target.dataset.name));
                    });
                }
            }

            async function handleDeleteActivity(activityId, activityName) {
                window.showMessage(`Tem certeza que deseja excluir a atividade "${activityName}"?`, async (confirmed) => {
                    if (confirmed) {
                        try {
                            const activityDocRef = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'activities', activityId);
                            await deleteDoc(activityDocRef);
                            window.showMessage(`Atividade "${activityName}" exclu√≠da com sucesso!`);
                        } catch (error) {
                            console.error("Erro ao excluir atividade:", error);
                            window.showMessage("Erro ao excluir atividade. Tente novamente.");
                        }
                    }
                }, true);
            }

            function updateSubmissionsTables() {
                const pendingSubmissions = currentSubmissions.filter(sub => sub.status === 'pending');
                const allSubmissions = currentSubmissions;

                document.getElementById('pending-submissions-count').textContent = pendingSubmissions.length;

                const pendingListDiv = document.getElementById('pending-submissions-list');
                if (!pendingListDiv) return;
                if (pendingSubmissions.length === 0) {
                    pendingListDiv.innerHTML = '<p class="text-slate-600">Nenhum envio pendente no momento.</p>';
                } else {
                    let tableHtml = `
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white rounded-lg shadow-md">
                                <thead class="bg-yellow-100">
                                    <tr>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700 rounded-tl-lg">Unidade</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Atividade</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Detalhes</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Evid√™ncia</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Pontos a Atribuir</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700 rounded-tr-lg">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    pendingSubmissions.forEach(sub => {
                        const activityMaxPoints = currentActivities.find(act => act.id === sub.activityId)?.maxPoints || 0;
                        tableHtml += `
                            <tr class="border-b border-slate-200 last:border-b-0 hover:bg-slate-50">
                                <td class="py-3 px-4 text-sm">${sub.unitName}</td>
                                <td class="py-3 px-4 text-sm">${sub.activityName}</td>
                                <td class="py-3 px-4 text-sm max-w-xs truncate">${sub.details}</td>
                                <td class="py-3 px-4 text-sm">
                                    ${sub.photoUrl ? `<a href="${sub.photoUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">Ver Foto</a>` : 'N/A'}
                                </td>
                                <td class="py-3 px-4 text-sm">
                                    <input type="number" value="${activityMaxPoints}" min="0" max="${activityMaxPoints}" data-submission-id="${sub.id}" class="points-input w-20 p-1 border border-slate-300 rounded-md text-center">
                                    <span class="ml-1 text-xs text-slate-500">/${activityMaxPoints}</span>
                                </td>
                                <td class="py-3 px-4 text-sm flex flex-col sm:flex-row gap-2">
                                    <button data-id="${sub.id}" data-unit-id="${sub.unitId}" class="approve-btn bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-lg text-xs transition duration-300 ease-in-out transform hover:scale-105">Aprovar</button>
                                    <button data-id="${sub.id}" class="reject-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-xs transition duration-300 ease-in-out transform hover:scale-105">Rejeitar</button>
                                </td>
                            </tr>
                        `;
                    });
                    tableHtml += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    pendingListDiv.innerHTML = tableHtml;

                    pendingListDiv.querySelectorAll('.approve-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const submissionId = e.target.dataset.id;
                            const unitId = e.target.dataset.unitId;
                            const pointsInput = e.target.closest('tr').querySelector('.points-input');
                            const points = parseInt(pointsInput.value);
                            handleApproveSubmission(submissionId, unitId, points);
                        });
                    });
                    pendingListDiv.querySelectorAll('.reject-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => handleRejectSubmission(e.target.dataset.id));
                    });
                }

                const allSubmissionsListDiv = document.getElementById('all-submissions-list');
                if (!allSubmissionsListDiv) return;
                if (allSubmissions.length === 0) {
                    allSubmissionsListDiv.innerHTML = '<p class="text-slate-600">Nenhum envio registrado ainda.</p>';
                } else {
                    let tableHtml = `
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white rounded-lg shadow-md">
                                <thead class="bg-slate-200">
                                    <tr>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700 rounded-tl-lg">Unidade</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Atividade</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Status</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Pontos</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Data Envio</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700 rounded-tr-lg">Data Valida√ß√£o</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    allSubmissions.forEach(sub => {
                        const statusClass = sub.status === 'pending' ? 'pending' : (sub.status === 'approved' ? 'approved' : 'rejected');
                        tableHtml += `
                            <tr class="border-b border-slate-200 last:border-b-0 hover:bg-slate-50">
                                <td class="py-3 px-4 text-sm">${sub.unitName}</td>
                                <td class="py-3 px-4 text-sm">${sub.activityName}</td>
                                <td class="py-3 px-4 text-sm">
                                    <span class="px-2 py-1 rounded-full text-xs font-semibold status-badge ${statusClass}">
                                        ${sub.status === 'pending' ? 'Pendente' : (sub.status === 'approved' ? 'Aprovado' : 'Rejeitado')}
                                    </span>
                                </td>
                                <td class="py-3 px-4 text-sm font-bold">${sub.pointsAwarded || 'N/A'}</td>
                                <td class="py-3 px-4 text-sm">
                                    ${sub.submittedAt ? new Date(sub.submittedAt.toDate()).toLocaleDateString('pt-BR') : 'N/A'}
                                </td>
                                <td class="py-3 px-4 text-sm">
                                    ${sub.validatedAt ? new Date(sub.validatedAt.toDate()).toLocaleDateString('pt-BR') : 'N/A'}
                                </td>
                            </tr>
                        `;
                    });
                    tableHtml += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    allSubmissionsListDiv.innerHTML = tableHtml;
                }
            }

            async function handleApproveSubmission(submissionId, unitId, points) {
                if (points === null || points < 0) {
                    window.showMessage("Por favor, insira uma pontua√ß√£o v√°lida.");
                    return;
                }

                window.showMessage(`Confirmar aprova√ß√£o do envio com ${points} pontos?`, async (confirmed) => {
                    if (confirmed) {
                        try {
                            const submissionDocRef = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'submissions', submissionId);
                            await updateDoc(submissionDocRef, {
                                status: 'approved',
                                pointsAwarded: parseInt(points),
                                validatedAt: serverTimestamp(),
                            });

                            const unitDocRef = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'units', unitId);
                            const unitSnap = await getDoc(unitDocRef);
                            if (unitSnap.exists()) {
                                const currentScore = unitSnap.data().score || 0;
                                await updateDoc(unitDocRef, {
                                    score: currentScore + parseInt(points),
                                });
                            }
                            window.showMessage("Envio aprovado e pontua√ß√£o da unidade atualizada!");
                        } catch (error) {
                            console.error("Erro ao aprovar envio:", error);
                            window.showMessage("Erro ao aprovar envio. Tente novamente.");
                        }
                    }
                }, true);
            }

            async function handleRejectSubmission(submissionId) {
                window.showMessage("Tem certeza que deseja rejeitar este envio?", async (confirmed) => {
                    if (confirmed) {
                        try {
                            const submissionDocRef = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'submissions', submissionId);
                            await updateDoc(submissionDocRef, {
                                status: 'rejected',
                                pointsAwarded: 0,
                                validatedAt: serverTimestamp(),
                            });
                            window.showMessage("Envio rejeitado com sucesso!");
                        } catch (error) {
                            console.error("Erro ao rejeitar envio:", error);
                            window.showMessage("Erro ao rejeitar envio. Tente novamente.");
                        }
                    }
                }, true);
            }
        }

        // --- AUTHENTICATION UI LOGIC ---
        function setupAuthFormListeners() {
            const authForm = document.getElementById('auth-form');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const loginBtn = document.getElementById('login-btn');
            const registerBtn = document.getElementById('register-btn');
            const logoutBtn = document.getElementById('logout-btn');

            if (authForm && loginBtn && registerBtn) {
                loginBtn.onclick = async (e) => {
                    e.preventDefault();
                    const email = emailInput.value;
                    const password = passwordInput.value;
                    try {
                        await window.signInWithEmailAndPassword(window.auth, email, password);
                        // onAuthStateChanged will handle UI update
                    } catch (error) {
                        console.error("Erro ao iniciar sess√£o:", error);
                        window.showMessage(`Erro ao iniciar sess√£o: ${error.message}`);
                    }
                };

                registerBtn.onclick = async (e) => {
                    e.preventDefault();
                    const email = emailInput.value;
                    const password = passwordInput.value;
                    try {
                        const userCredential = await window.createUserWithEmailAndPassword(window.auth, email, password);
                        // No primeiro registo, o papel √© definido como 'leader' no onAuthStateChanged
                        window.showMessage("Registo bem-sucedido! A iniciar sess√£o...");
                        // onAuthStateChanged will handle UI update
                    } catch (error) {
                        console.error("Erro ao registar:", error);
                        window.showMessage(`Erro ao registar: ${error.message}`);
                    }
                };
            }

            if (logoutBtn) {
                logoutBtn.onclick = async () => {
                    try {
                        await window.signOut(window.auth);
                        window.showMessage("Sess√£o terminada com sucesso!");
                        // onAuthStateChanged will handle UI update
                    } catch (error) {
                        console.error("Erro ao terminar sess√£o:", error);
                        window.showMessage(`Erro ao terminar sess√£o: ${error.message}`);
                    }
                };
            }
        }


        // --- MAIN APPLICATION INITIALIZATION ---
        async function initApp() {
            // Update user info in header
            if (window.currentUser) {
                document.getElementById('user-info').textContent = `Ol√°, ${window.userRole === 'secretary' ? 'Secret√°rio(a)' : 'L√≠der de Unidade'} (ID: ${window.currentUser.uid})`;
                document.getElementById('logout-btn').classList.remove('hidden');
            } else {
                document.getElementById('user-info').textContent = `N√£o autenticado.`;
                document.getElementById('logout-btn').classList.add('hidden');
            }

            // Show/hide 'Gest√£o' tab based on role
            if (window.userRole === 'leader' || window.userRole === 'secretary') {
                document.querySelector('button[data-tab="gestao"]').classList.remove('hidden');
            } else {
                document.querySelector('button[data-tab="gestao"]').classList.add('hidden');
            }

            // Fetch initial data for all sections
            await Promise.all([getUnits(), getActivities(), getSubmissions()]);

            // Render static content
            renderCalendar();
            renderAbout();

            // Initial tab display
            const tabs = document.querySelectorAll('.tab-button');
            const contentSections = document.querySelectorAll('.content-section');

            function switchTab(e) {
                const targetTab = e.currentTarget.dataset.tab;

                tabs.forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.tab === targetTab);
                });

                contentSections.forEach(section => {
                    section.classList.toggle('active', section.id === targetTab);
                });

                if (targetTab === 'inicio') {
                    renderDashboard();
                } else if (targetTab === 'gestao') {
                    if (window.userRole === 'secretary') {
                        renderSecretaryDashboard();
                    } else if (window.userRole === 'leader') {
                        renderUnitLeaderDashboard();
                    } else {
                        // Fallback if somehow user gets to gest√£o tab without role
                        window.showMessage("Voc√™ n√£o tem permiss√£o para aceder a esta se√ß√£o.");
                        document.querySelector('.tab-button[data-tab="inicio"]').click(); // Redirect to home
                    }
                }
            }

            tabs.forEach(tab => tab.addEventListener('click', switchTab));

            document.body.addEventListener('click', function (event) {
                if (event.target.matches('.accordion-button') || event.target.closest('.accordion-button')) {
                    const button = event.target.matches('.accordion-button') ? event.target : event.target.closest('.accordion-button');
                    const content = button.nextElementSibling;
                    const icon = button.querySelector('span:last-child');

                    button.classList.toggle('open');
                    icon.classList.toggle('rotate-180');

                    if (button.classList.contains('open')) {
                        content.style.maxHeight = content.scrollHeight + 'px';
                    } else {
                        content.style.maxHeight = null;
                    }
                }
            });

            // Set initial tab to 'inicio' and render dashboard
            document.querySelector('.tab-button[data-tab="inicio"]').classList.add('active');
            document.getElementById('inicio').classList.add('active');
            renderDashboard();
        }
    </script>
</body>

</html>