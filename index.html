<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gincana de Unidades: A Aventura do Desbravador</title>
    <!-- Chosen Palette: Warm Neutrals & Serene Blue -->
    <!-- Application Structure Plan: The application is structured as a single-page tabbed dashboard. This architecture was chosen to provide users with a clean, organized, and non-linear way to access different types of information. Instead of a long scroll, users can instantly switch between contexts: 'Início' for a quick overview and scoreboard, 'Calendário' for planning, 'Regulamento' for rules reference, and 'Sobre o Clube' for foundational information. This task-oriented separation enhances usability and makes finding specific information much faster and more intuitive. -->
    <!-- Visualization & Content Choices: 
        - Scoreboard (Goal: Compare): A Chart.js horizontal bar chart was selected to visually represent and compare unit scores, as it's highly effective for ranking. This is paired with dynamic stat cards (HTML/CSS) to provide a quick summary (Goal: Inform). Interaction: The chart is dynamically rendered from JS data fetched from Firestore.
        - Calendar (Goal: Organize/Inform): An accordion-style list, grouped by month, is used instead of a complex calendar grid. This simplifies implementation while still allowing users to easily find activities. Interaction: Clicking a month reveals its activities.
        - Regulations (Goal: Inform/Organize): Content from the regulation report is structured into accordion sections for 'Pontuação', 'Critérios de Desempate', 'Conduta Esperada', and 'Procedimentos para Recursos'. This approach breaks down legalistic text into digestible, expandable chunks.
        - About the Club (Goal: Inform): 'As Bases do Clube' and 'Estrutura e Funções' are presented using accordions. This keeps detailed textual information concise until expanded.
        - Graphics (Goal: Enhance UI): Unicode characters (emojis) are used for icons in the navigation tabs, providing visual cues without the overhead or complexity of image files or SVG, adhering to the constraints.
        - Library/Method: Chart.js for visualizations. Firestore for remote data storage and real-time updates. Firebase Authentication for user roles. All other elements are built with structured HTML and styled with Tailwind CSS. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        // Importações do Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        // Variáveis de estado do Firebase e da aplicação (dentro do escopo do módulo)
        let firebaseApp = null;
        let db = null;
        let auth = null;
        let currentUser = null;
        let userRole = null;


        const appId = 'gincana-de-unidades';

        const firebaseConfig = {
            apiKey: "AIzaSyBJI_Hrp1I5GJHt82UKo5xjr392Z4XTMS8",
            authDomain: "gincana-de-unidade.firebaseapp.com",
            projectId: "gincana-de-unidade",
            storageBucket: "gincana-de-unidade.firebasestorage.app",
            messagingSenderId: "497226153394",
            appId: "1:497226153394:web:35d484f3737e3a3b4938ab"
        };

        // initialAuthToken não é mais usado com autenticação por e-mail/senha
        const initialAuthToken = null;

        // Apenas para depuração: Verifique o que está sendo lido na configuração
        console.log("firebaseConfig lido:", firebaseConfig);
        console.log("appId lido:", appId);
        console.log("authDomain lido:", firebaseConfig.authDomain);


        // MessageBox function
        const showMessage = (msg, callback, showCancel = false) => {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const confirmBtn = document.getElementById('messageConfirmBtn');
            const cancelBtn = document.getElementById('messageCancelBtn');

            messageText.textContent = msg;
            messageBox.classList.remove('hidden');

            confirmBtn.onclick = () => {
                messageBox.classList.add('hidden');
                if (callback) callback(true);
            };

            if (showCancel) {
                cancelBtn.classList.remove('hidden');
                cancelBtn.onclick = () => {
                    messageBox.classList.add('hidden');
                    if (callback) callback(false);
                };
            } else {
                cancelBtn.classList.add('hidden');
            }
        };

        // Variáveis de estado da aplicação (dados dinâmicos do Firestore)
        let chartInstance = null;
        let currentUnits = [];
        let currentActivities = [];
        let currentSubmissions = [];

        // Funções de operação de dados do Firebase (agora dentro do escopo do módulo)
        async function getUnits() {
            const unitsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'units');
            const q = query(unitsColRef);
            return new Promise((resolve, reject) => {
                onSnapshot(q, (snapshot) => {
                    currentUnits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    currentUnits.sort((a, b) => (b.score || 0) - (a.score || 0)); // Ordenar por pontuação descendente
                    resolve(currentUnits);
                }, reject);
            });
        }

        async function getActivities() {
            const activitiesColRef = collection(db, 'artifacts', appId, 'public', 'data', 'activities');
            const q = query(activitiesColRef);
            return new Promise((resolve, reject) => {
                onSnapshot(q, (snapshot) => {
                    currentActivities = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    resolve(currentActivities);
                }, reject);
            });
        }

        async function getSubmissions() {
            const submissionsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'submissions');
            const q = query(submissionsColRef);
            return new Promise((resolve, reject) => {
                onSnapshot(q, (snapshot) => {
                    currentSubmissions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    currentSubmissions.sort((a, b) => b.submittedAt?.toDate() - a.submittedAt?.toDate()); // Ordenar por mais recente
                    resolve(currentSubmissions);
                }, reject);
            });
        }


        // --- Funções de Renderização da UI ---
        function wrapLabel(label, maxLen) {
            if (label.length <= maxLen) return label;
            let wrappedLabel = '';
            let words = label.split(' ');
            let currentLine = '';
            for (let i = 0; i < words.length; i++) {
                let word = words[i];
                if ((currentLine + word).length <= maxLen) {
                    currentLine += (currentLine === '' ? '' : ' ') + word;
                } else {
                    wrappedLabel += currentLine + '\n';
                    currentLine = word;
                }
            }
            wrappedLabel += currentLine;
            return wrappedLabel;
        }

        function renderDashboard() {
            const totalScore = currentUnits.reduce((sum, item) => sum + (item.score || 0), 0);
            const totalActivitiesDefined = Object.values(staticData.calendar).flat().length;
            const approvedSubmissionsCount = currentSubmissions.filter(sub => sub.status === 'approved').length;

            document.getElementById('unidade-destaque').textContent = currentUnits.length > 0 ? currentUnits[0].name : 'N/A';
            document.getElementById('total-pontos').textContent = totalScore;
            document.getElementById('atividades-realizadas').textContent = `${approvedSubmissionsCount} / ${totalActivitiesDefined}`;

            renderScoreChart(currentUnits);
        }

        function renderScoreChart(unitsData) {
            const ctx = document.getElementById('scoreChart').getContext('2d');
            if (chartInstance) {
                chartInstance.destroy();
            }
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: unitsData.map(item => wrapLabel(item.name, 16)),
                    datasets: [{
                        label: 'Pontuação da Unidade',
                        data: unitsData.map(item => item.score || 0),
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1,
                        borderRadius: 5,
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `${context.dataset.label}: ${context.raw} pontos`;
                                }
                            }
                        },
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                display: true,
                                color: 'rgba(203, 213, 225, 0.5)'
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                callback: function (value, index, ticks) {
                                    return wrapLabel(this.getLabelForValue(value), 16);
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderCalendar() {
            const container = document.getElementById('calendario-container');
            container.innerHTML = '';
            Object.entries(staticData.calendar).forEach(([month, activities]) => {
                const monthDiv = document.createElement('div');
                monthDiv.className = 'bg-white rounded-xl shadow-md';

                const button = document.createElement('button');
                button.className = 'accordion-button w-full text-left p-6 font-bold text-xl text-blue-800 flex justify-between items-center';
                button.innerHTML = `<span>${month}</span><span class="transform transition-transform duration-300">▼</span>`;

                const contentDiv = document.createElement('div');
                contentDiv.className = 'accordion-content px-6 pb-6 text-slate-600 space-y-4';

                activities.forEach(activity => {
                    contentDiv.innerHTML += `
                        <div class="pt-4 border-t first:border-t-0 border-slate-200">
                            <p class="font-semibold text-slate-700">${activity.date} - ${activity.title}</p>
                            <p class="text-sm">${activity.desc}</p>
                        </div>
                    `;
                });

                monthDiv.appendChild(button);
                monthDiv.appendChild(contentDiv);
                container.appendChild(monthDiv);
            });
        }

        function renderAbout() {
            const basesContainer = document.getElementById('bases-content');
            basesContainer.innerHTML = staticData.bases.map(item => `<div class="pt-4 border-t first:border-t-0 border-slate-200"><h4 class="font-bold text-lg text-slate-700">${item.title}</h4><p>${item.content}</p></div>`).join('');

            const funcoesContainer = document.getElementById('funcoes-content');
            funcoesContainer.innerHTML = '';
            Object.entries(staticData.funcoes).forEach(([category, roles]) => {
                let categoryHtml = `<h4 class="font-bold text-lg text-slate-700 pt-4 border-t first:border-t-0 border-slate-200">${category}</h4><ul class="list-disc list-inside list-disc-custom space-y-2">`;
                roles.forEach(role => {
                    categoryHtml += `<li><strong>${role.title}:</strong> ${role.content}</li>`;
                });
                categoryHtml += `</ul>`;
                funcoesContainer.innerHTML += categoryHtml;
            });
        }

        // --- DASHBOARDS DE GESTÃO (LÍDER/SECRETÁRIO) ---

        function renderUnitLeaderDashboard() {
            document.getElementById('gestao-title').textContent = 'Dashboard do Líder de Unidade';
            const gestaoContent = document.getElementById('gestao-content');
            gestaoContent.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h3 class="text-xl font-semibold text-blue-600 mb-4">Enviar Atividade Concluída</h3>
                    <form id="submit-activity-form" class="space-y-4 mb-8">
                        <div>
                            <label for="unit-select-leader" class="block text-sm font-medium text-slate-700">Sua Unidade:</label>
                            <select id="unit-select-leader" class="mt-1 block w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="">Selecione sua unidade</option>
                            </select>
                            <p id="no-units-message" class="text-red-500 text-sm mt-2 hidden">Nenhuma unidade encontrada. Peça ao secretário para cadastrar as unidades.</p>
                        </div>
                        <div>
                            <label for="activity-select-leader" class="block text-sm font-medium text-slate-700">Atividade:</label>
                            <select id="activity-select-leader" class="mt-1 block w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="">Selecione uma atividade</option>
                            </select>
                            <p id="no-activities-message" class="text-red-500 text-sm mt-2 hidden">Nenhuma atividade cadastrada. Peça ao secretário para cadastrar as atividades.</p>
                        </div>
                        <div>
                            <label for="details-leader" class="block text-sm font-medium text-slate-700">Detalhes da Conclusão (O que foi feito?):</label>
                            <textarea id="details-leader" rows="4" class="mt-1 block w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Descreva como a atividade foi concluída..." required></textarea>
                        </div>
                        <div>
                            <label for="photo-url-leader" class="block text-sm font-medium text-slate-700">Link da Foto/Evidência (Opcional):</label>
                            <input type="text" id="photo-url-leader" class="mt-1 block w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: https://linkdafoto.com/minhafoto.jpg">
                            <p class="text-xs text-slate-500 mt-1">Em uma aplicação real, aqui haveria um upload de arquivo. Por enquanto, insira um link.</p>
                        </div>
                        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">Enviar para Validação</button>
                    </form>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold text-blue-600 mb-4">Meus Envios Recentes</h3>
                    <div id="leader-submissions-list">
                        <p class="text-slate-600">Nenhum envio feito ainda para esta unidade.</p>
                    </div>
                </div>
            `;

            const unitSelectLeader = document.getElementById('unit-select-leader');
            const activitySelectLeader = document.getElementById('activity-select-leader');
            const noUnitsMessage = document.getElementById('no-units-message');
            const noActivitiesMessage = document.getElementById('no-activities-message');

            if (currentUnits.length > 0) {
                unitSelectLeader.innerHTML = currentUnits.map(unit => `<option value="${unit.id}">${unit.name}</option>`).join('');
                unitSelectLeader.value = currentUnits[0].id; // Select first unit by default
                noUnitsMessage.classList.add('hidden');
            } else {
                noUnitsMessage.classList.remove('hidden');
            }

            if (currentActivities.length > 0) {
                activitySelectLeader.innerHTML = '<option value="">Selecione uma atividade</option>' + currentActivities.map(activity => `<option value="${activity.id}">${activity.name} (${activity.type})</option>`).join('');
                noActivitiesMessage.classList.add('hidden');
            } else {
                noActivitiesMessage.classList.remove('hidden');
            }

            document.getElementById('submit-activity-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const selectedUnitId = unitSelectLeader.value;
                const activityId = activitySelectLeader.value;
                const details = document.getElementById('details-leader').value;
                const photoUrl = document.getElementById('photo-url-leader').value;

                if (!selectedUnitId || !activityId || !details.trim()) {
                    showMessage("Por favor, preencha todos os campos obrigatórios (Unidade, Atividade e Detalhes).");
                    return;
                }

                const activity = currentActivities.find(act => act.id === activityId);
                if (!activity) {
                    showMessage("Atividade selecionada inválida.");
                    return;
                }

                try {
                    const submissionsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'submissions');
                    await addDoc(submissionsColRef, {
                        unitId: selectedUnitId,
                        unitName: currentUnits.find(u => u.id === selectedUnitId)?.name || 'Unidade Desconhecida',
                        activityId: activityId,
                        activityName: activity.name,
                        details: details,
                        photoUrl: photoUrl,
                        status: 'pending',
                        submittedBy: currentUser.uid,
                        submittedAt: serverTimestamp(),
                    });
                    showMessage("Atividade enviada para validação com sucesso!");
                    document.getElementById('submit-activity-form').reset();
                } catch (error) {
                    console.error("Erro ao enviar atividade:", error);
                    showMessage("Erro ao enviar atividade. Tente novamente.");
                }
            });

            function updateLeaderSubmissionsList(selectedUnitId) {
                const leaderSubmissionsList = document.getElementById('leader-submissions-list');
                const unitSubmissions = currentSubmissions.filter(sub => sub.unitId === selectedUnitId);

                if (unitSubmissions.length === 0) {
                    leaderSubmissionsList.innerHTML = '<p class="text-slate-600">Nenhum envio feito ainda para esta unidade.</p>';
                    return;
                }

                let tableHtml = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead class="bg-blue-100">
                                <tr>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700 rounded-tl-lg">Atividade</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Detalhes</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Status</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Pontos</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700 rounded-tr-lg">Data</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                unitSubmissions.forEach(sub => {
                    const statusClass = sub.status === 'pending' ? 'pending' : (sub.status === 'approved' ? 'approved' : 'rejected');
                    tableHtml += `
                        <tr class="border-b border-slate-200 last:border-b-0 hover:bg-slate-50">
                            <td class="py-3 px-4 text-sm">${sub.activityName}</td>
                            <td class="py-3 px-4 text-sm max-w-xs truncate">${sub.details}</td>
                            <td class="py-3 px-4 text-sm">
                                <span class="px-2 py-1 rounded-full text-xs font-semibold status-badge ${statusClass}">
                                    ${sub.status === 'pending' ? 'Pendente' : (sub.status === 'approved' ? 'Aprovado' : 'Rejeitado')}
                                </span>
                            </td>
                            <td class="py-3 px-4 text-sm font-bold">${sub.pointsAwarded || 'N/A'}</td>
                            <td class="py-3 px-4 text-sm">
                                ${sub.submittedAt ? new Date(sub.submittedAt.toDate()).toLocaleDateString('pt-BR') : 'N/A'}
                            </td>
                        </tr>
                    `;
                });
                tableHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
                leaderSubmissionsList.innerHTML = tableHtml;
            }

            unitSelectLeader.addEventListener('change', (e) => {
                updateLeaderSubmissionsList(e.target.value);
            });

            // Initial render of leader submissions based on default selected unit
            if (unitSelectLeader.value) {
                updateLeaderSubmissionsList(unitSelectLeader.value);
            }
        }

        function renderSecretaryDashboard() {
            document.getElementById('gestao-title').textContent = 'Dashboard do Secretário do Clube';
            const gestaoContent = document.getElementById('gestao-content');
            gestaoContent.innerHTML = `
                <!-- Gerenciamento de Unidades -->
                <section class="mb-8 p-4 bg-blue-50 rounded-xl shadow-inner">
                    <h3 class="text-xl font-semibold text-blue-600 mb-4">Gerenciar Unidades</h3>
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <input type="text" id="new-unit-name" placeholder="Nome da nova unidade" class="flex-grow p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <button id="add-unit-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">Adicionar Unidade</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead class="bg-blue-100">
                                <tr>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700 rounded-tl-lg">Unidade</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Pontuação</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700 rounded-tr-lg">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="units-table-body">
                                <tr><td colspan="3" class="py-4 px-4 text-center text-slate-600">Nenhuma unidade cadastrada.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Gerenciamento de Atividades -->
                <section class="mb-8 p-4 bg-green-50 rounded-xl shadow-inner">
                    <h3 class="text-xl font-semibold text-green-600 mb-4">Gerenciar Atividades</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <input type="text" id="new-activity-name" placeholder="Nome da atividade" class="p-3 border border-slate-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                        <select id="new-activity-type" class="p-3 border border-slate-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                            <option value="">Tipo (Físico, Mental, Espiritual, etc.)</option>
                            <option value="Físico">Físico</option>
                            <option value="Mental">Mental</option>
                            <option value="Espiritual">Espiritual</option>
                            <option value="Social">Social</option>
                            <option value="Pioneirismo">Pioneirismo</option>
                            <option value="Natureza">Natureza</option>
                            <option value="Serviço">Serviço Comunitário</option>
                            <option value="Culinária">Culinária</option>
                            <option value="Geral">Geral</option>
                        </select>
                        <input type="number" id="new-activity-max-points" placeholder="Pontuação Máxima" class="p-3 border border-slate-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                    </div>
                    <button id="add-activity-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">Adicionar Atividade</button>
                    <div class="overflow-x-auto mt-6">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead class="bg-green-100">
                                <tr>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700 rounded-tl-lg">Atividade</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Tipo</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Pontos Máx.</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700 rounded-tr-lg">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="activities-table-body">
                                <tr><td colspan="4" class="py-4 px-4 text-center text-slate-600">Nenhuma atividade cadastrada.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Validação de Envios Pendentes -->
                <section class="mb-8 p-4 bg-yellow-50 rounded-xl shadow-inner">
                    <h3 class="text-xl font-semibold text-yellow-800 mb-4">Envios Pendentes para Validação (<span id="pending-submissions-count">0</span>)</h3>
                    <div id="pending-submissions-list">
                        <p class="text-slate-600">Nenhum envio pendente no momento.</p>
                    </div>
                </section>

                <!-- Histórico de Envios -->
                <section class="mb-8 p-4 bg-slate-50 rounded-xl shadow-inner">
                    <h3 class="text-xl font-semibold text-slate-700 mb-4">Histórico de Todos os Envios</h3>
                    <div id="all-submissions-list">
                        <p class="text-slate-600">Nenhum envio registrado ainda.</p>
                    </div>
                </section>
            `;

            // Unit Management
            document.getElementById('add-unit-btn').addEventListener('click', async () => {
                const newUnitName = document.getElementById('new-unit-name').value.trim();
                if (!newUnitName) {
                    showMessage("O nome da unidade não pode ser vazio.");
                    return;
                }
                try {
                    const unitsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'units');
                    await addDoc(unitsColRef, { name: newUnitName, score: 0, createdAt: serverTimestamp() });
                    showMessage(`Unidade "${newUnitName}" adicionada com sucesso!`);
                    document.getElementById('new-unit-name').value = '';
                } catch (error) {
                    console.error("Erro ao adicionar unidade:", error);
                    showMessage("Erro ao adicionar unidade. Tente novamente.");
                }
            });

            // Activity Management
            document.getElementById('add-activity-btn').addEventListener('click', async () => {
                const name = document.getElementById('new-activity-name').value.trim();
                const type = document.getElementById('new-activity-type').value;
                const maxPoints = parseInt(document.getElementById('new-activity-max-points').value);

                if (!name || !type || isNaN(maxPoints) || maxPoints < 0) {
                    showMessage("Por favor, preencha todos os campos da atividade corretamente.");
                    return;
                }
                try {
                    const activitiesColRef = collection(db, 'artifacts', appId, 'public', 'data', 'activities');
                    await addDoc(activitiesColRef, { name, type, maxPoints, createdAt: serverTimestamp() });
                    showMessage(`Atividade "${name}" adicionada com sucesso!`);
                    document.getElementById('new-activity-name').value = '';
                    document.getElementById('new-activity-type').value = '';
                    document.getElementById('new-activity-max-points').value = '';
                } catch (error) {
                    console.error("Erro ao adicionar atividade:", error);
                    showMessage("Erro ao adicionar atividade. Tente novamente.");
                }
            });

            // Real-time updates for Secretary Dashboard
            const unsubscribeUnits = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'units'), (snapshot) => {
                currentUnits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                currentUnits.sort((a, b) => (b.score || 0) - (a.score || 0));
                updateUnitsTable();
                renderDashboard(); // Update dashboard when units change
            }, (error) => console.error("Erro ao carregar unidades (Secretário):", error));

            const unsubscribeActivities = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'activities'), (snapshot) => {
                currentActivities = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateActivitiesTable();
            }, (error) => console.error("Erro ao carregar atividades (Secretário):", error));

            const unsubscribeSubmissions = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'submissions'), (snapshot) => {
                currentSubmissions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                currentSubmissions.sort((a, b) => b.submittedAt?.toDate() - a.submittedAt?.toDate());
                updateSubmissionsTables();
                renderDashboard(); // Update dashboard when submissions change
            }, (error) => console.error("Erro ao carregar envios (Secretário):", error));

            function updateUnitsTable() {
                const tbody = document.getElementById('units-table-body');
                if (!tbody) return;
                if (currentUnits.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="py-4 px-4 text-center text-slate-600">Nenhuma unidade cadastrada.</td></tr>';
                } else {
                    tbody.innerHTML = currentUnits.map(unit => `
                        <tr class="border-b border-slate-200 last:border-b-0 hover:bg-slate-50">
                            <td class="py-3 px-4 text-sm">${unit.name}</td>
                            <td class="py-3 px-4 text-sm font-bold">${unit.score || 0}</td>
                            <td class="py-3 px-4 text-sm">
                                <button data-id="${unit.id}" data-name="${unit.name}" class="delete-unit-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-xs transition duration-300 ease-in-out transform hover:scale-105">Excluir</button>
                            </td>
                        </tr>
                    `).join('');
                    tbody.querySelectorAll('.delete-unit-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => handleDeleteUnit(e.target.dataset.id, e.target.dataset.name));
                    });
                }
            }

            async function handleDeleteUnit(unitId, unitName) {
                showMessage(`Tem certeza que deseja excluir a unidade "${unitName}"? Isso removerá todos os seus dados.`, async (confirmed) => {
                    if (confirmed) {
                        try {
                            const unitDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'units', unitId);
                            await deleteDoc(unitDocRef);
                            showMessage(`Unidade "${unitName}" excluída com sucesso!`);
                        } catch (error) {
                            console.error("Erro ao excluir unidade:", error);
                            showMessage("Erro ao excluir unidade. Tente novamente.");
                        }
                    }
                }, true);
            }

            function updateActivitiesTable() {
                const tbody = document.getElementById('activities-table-body');
                if (!tbody) return;
                if (currentActivities.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="py-4 px-4 text-center text-slate-600">Nenhuma atividade cadastrada.</td></tr>';
                } else {
                    tbody.innerHTML = currentActivities.map(activity => `
                        <tr class="border-b border-slate-200 last:border-b-0 hover:bg-slate-50">
                            <td class="py-3 px-4 text-sm">${activity.name}</td>
                            <td class="py-3 px-4 text-sm">${activity.type}</td>
                            <td class="py-3 px-4 text-sm font-bold">${activity.maxPoints}</td>
                            <td class="py-3 px-4 text-sm">
                                <button data-id="${activity.id}" data-name="${activity.name}" class="delete-activity-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-xs transition duration-300 ease-in-out transform hover:scale-105">Excluir</button>
                            </td>
                        </tr>
                    `).join('');
                    tbody.querySelectorAll('.delete-activity-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => handleDeleteActivity(e.target.dataset.id, e.target.dataset.name));
                    });
                }
            }

            async function handleDeleteActivity(activityId, activityName) {
                showMessage(`Tem certeza que deseja excluir a atividade "${activityName}"?`, async (confirmed) => {
                    if (confirmed) {
                        try {
                            const activityDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'activities', activityId);
                            await deleteDoc(activityDocRef);
                            showMessage(`Atividade "${activityName}" excluída com sucesso!`);
                        } catch (error) {
                            console.error("Erro ao excluir atividade:", error);
                            showMessage("Erro ao excluir atividade. Tente novamente.");
                        }
                    }
                }, true);
            }

            function updateSubmissionsTables() {
                const pendingSubmissions = currentSubmissions.filter(sub => sub.status === 'pending');
                const allSubmissions = currentSubmissions;

                document.getElementById('pending-submissions-count').textContent = pendingSubmissions.length;

                const pendingListDiv = document.getElementById('pending-submissions-list');
                if (!pendingListDiv) return;
                if (pendingSubmissions.length === 0) {
                    pendingListDiv.innerHTML = '<p class="text-slate-600">Nenhum envio pendente no momento.</p>';
                } else {
                    let tableHtml = `
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white rounded-lg shadow-md">
                                <thead class="bg-yellow-100">
                                    <tr>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700 rounded-tl-lg">Unidade</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Atividade</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Detalhes</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Evidência</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Pontos a Atribuir</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700 rounded-tr-lg">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    pendingSubmissions.forEach(sub => {
                        const activityMaxPoints = currentActivities.find(act => act.id === sub.activityId)?.maxPoints || 0;
                        tableHtml += `
                            <tr class="border-b border-slate-200 last:border-b-0 hover:bg-slate-50">
                                <td class="py-3 px-4 text-sm">${sub.unitName}</td>
                                <td class="py-3 px-4 text-sm">${sub.activityName}</td>
                                <td class="py-3 px-4 text-sm max-w-xs truncate">${sub.details}</td>
                                <td class="py-3 px-4 text-sm">
                                    ${sub.photoUrl ? `<a href="${sub.photoUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">Ver Foto</a>` : 'N/A'}
                                </td>
                                <td class="py-3 px-4 text-sm">
                                    <input type="number" value="${activityMaxPoints}" min="0" max="${activityMaxPoints}" data-submission-id="${sub.id}" class="points-input w-20 p-1 border border-slate-300 rounded-md text-center">
                                    <span class="ml-1 text-xs text-slate-500">/${activityMaxPoints}</span>
                                </td>
                                <td class="py-3 px-4 text-sm flex flex-col sm:flex-row gap-2">
                                    <button data-id="${sub.id}" data-unit-id="${sub.unitId}" class="approve-btn bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-lg text-xs transition duration-300 ease-in-out transform hover:scale-105">Aprovar</button>
                                    <button data-id="${sub.id}" class="reject-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-xs transition duration-300 ease-in-out transform hover:scale-105">Rejeitar</button>
                                </td>
                            </tr>
                        `;
                    });
                    tableHtml += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    pendingListDiv.innerHTML = tableHtml;

                    pendingListDiv.querySelectorAll('.approve-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const submissionId = e.target.dataset.id;
                            const unitId = e.target.dataset.unitId;
                            const pointsInput = e.target.closest('tr').querySelector('.points-input');
                            const points = parseInt(pointsInput.value);
                            handleApproveSubmission(submissionId, unitId, points);
                        });
                    });
                    pendingListDiv.querySelectorAll('.reject-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => handleRejectSubmission(e.target.dataset.id));
                    });
                }

                const allSubmissionsListDiv = document.getElementById('all-submissions-list');
                if (!allSubmissionsListDiv) return;
                if (allSubmissions.length === 0) {
                    allSubmissionsListDiv.innerHTML = '<p class="text-slate-600">Nenhum envio registrado ainda.</p>';
                } else {
                    let tableHtml = `
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white rounded-lg shadow-md">
                                <thead class="bg-slate-200">
                                    <tr>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700 rounded-tl-lg">Unidade</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Atividade</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Status</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Pontos</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Data Envio</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700 rounded-tr-lg">Data Validação</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    allSubmissions.forEach(sub => {
                        const statusClass = sub.status === 'pending' ? 'pending' : (sub.status === 'approved' ? 'approved' : 'rejected');
                        tableHtml += `
                            <tr class="border-b border-slate-200 last:border-b-0 hover:bg-slate-50">
                                <td class="py-3 px-4 text-sm">${sub.unitName}</td>
                                <td class="py-3 px-4 text-sm">${sub.activityName}</td>
                                <td class="py-3 px-4 text-sm">
                                    <span class="px-2 py-1 rounded-full text-xs font-semibold status-badge ${statusClass}">
                                        ${sub.status === 'pending' ? 'Pendente' : (sub.status === 'approved' ? 'Aprovado' : 'Rejeitado')}
                                    </span>
                                </td>
                                <td class="py-3 px-4 text-sm font-bold">${sub.pointsAwarded || 'N/A'}</td>
                                <td class="py-3 px-4 text-sm">
                                    ${sub.submittedAt ? new Date(sub.submittedAt.toDate()).toLocaleDateString('pt-BR') : 'N/A'}
                                </td>
                                <td class="py-3 px-4 text-sm">
                                    ${sub.validatedAt ? new Date(sub.validatedAt.toDate()).toLocaleDateString('pt-BR') : 'N/A'}
                                </td>
                            </tr>
                        `;
                    });
                    tableHtml += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    allSubmissionsListDiv.innerHTML = tableHtml;
                }
            }

            async function handleApproveSubmission(submissionId, unitId, points) {
                if (points === null || points < 0) {
                    showMessage("Por favor, insira uma pontuação válida.");
                    return;
                }

                showMessage(`Confirmar aprovação do envio com ${points} pontos?`, async (confirmed) => {
                    if (confirmed) {
                        try {
                            const submissionDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'submissions', submissionId);
                            await updateDoc(submissionDocRef, {
                                status: 'approved',
                                pointsAwarded: parseInt(points),
                                validatedAt: serverTimestamp(),
                            });

                            const unitDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'units', unitId);
                            const unitSnap = await getDoc(unitDocRef);
                            if (unitSnap.exists()) {
                                const currentScore = unitSnap.data().score || 0;
                                await updateDoc(unitDocRef, {
                                    score: currentScore + parseInt(points),
                                });
                            }
                            showMessage("Envio aprovado e pontuação da unidade atualizada!");
                        } catch (error) {
                            console.error("Erro ao aprovar envio:", error);
                            showMessage("Erro ao aprovar envio. Tente novamente.");
                        }
                    }
                }, true);
            }

            async function handleRejectSubmission(submissionId) {
                showMessage("Tem certeza que deseja rejeitar este envio?", async (confirmed) => {
                    if (confirmed) {
                        try {
                            const submissionDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'submissions', submissionId);
                            await updateDoc(submissionDocRef, {
                                status: 'rejected',
                                pointsAwarded: 0,
                                validatedAt: serverTimestamp(),
                            });
                            showMessage("Envio rejeitado com sucesso!");
                        } catch (error) {
                            console.error("Erro ao rejeitar envio:", error);
                            showMessage("Erro ao rejeitar envio. Tente novamente.");
                        }
                    }
                }, true);
            }
        }

        // --- Lógica da UI de Autenticação ---
        function setupAuthFormListeners() {
            const authForm = document.getElementById('auth-form');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const loginBtn = document.getElementById('login-btn');
            const registerBtn = document.getElementById('register-btn');
            const googleLoginBtn = document.getElementById('google-login-btn');
            const logoutBtn = document.getElementById('logout-btn');

            if (authForm && loginBtn && registerBtn && googleLoginBtn) {
                loginBtn.onclick = async (e) => {
                    e.preventDefault();
                    const email = emailInput.value;
                    const password = passwordInput.value;
                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                    } catch (error) {
                        console.error("Erro ao iniciar sessão:", error);
                        showMessage(`Erro ao iniciar sessão: ${error.message}`);
                    }
                };

                registerBtn.onclick = async (e) => {
                    e.preventDefault();
                    const email = emailInput.value;
                    const password = passwordInput.value;
                    try {
                        await createUserWithEmailAndPassword(auth, email, password);
                        showMessage("Registo bem-sucedido! A iniciar sessão...");
                    } catch (error) {
                        console.error("Erro ao registar:", error);
                        showMessage(`Erro ao registar: ${error.message}`);
                    }
                };

                googleLoginBtn.onclick = async () => {
                    try {
                        const provider = new GoogleAuthProvider();
                        await signInWithPopup(auth, provider);
                    } catch (error) {
                        console.error("Erro ao iniciar sessão com Google:", error);
                        showMessage(`Erro ao iniciar sessão com Google: ${error.message}`);
                    }
                };
            }

            if (logoutBtn) {
                logoutBtn.onclick = async () => {
                    try {
                        await signOut(auth);
                        showMessage("Sessão terminada com sucesso!");
                    } catch (error) {
                        console.error("Erro ao terminar sessão:", error);
                        showMessage(`Erro ao terminar sessão: ${error.message}`);
                    }
                };
            }
        }


        // --- INICIALIZAÇÃO PRINCIPAL DA APLICAÇÃO ---
        async function initApp() {
            // Atualiza informações do utilizador no cabeçalho
            if (currentUser) {
                document.getElementById('user-info').textContent = `Olá, ${userRole === 'secretary' ? 'Secretário(a)' : 'Líder de Unidade'} (ID: ${currentUser.uid})`;
                document.getElementById('logout-btn').classList.remove('hidden');
            } else {
                document.getElementById('user-info').textContent = `Não autenticado.`;
                document.getElementById('logout-btn').classList.add('hidden');
            }

            // Mostra/esconde a aba 'Gestão' com base no papel
            if (userRole === 'leader' || userRole === 'secretary') {
                document.querySelector('button[data-tab="gestao"]').classList.remove('hidden');
            } else {
                document.querySelector('button[data-tab="gestao"]').classList.add('hidden');
            }

            // Busca dados iniciais para todas as secções
            await Promise.all([getUnits(), getActivities(), getSubmissions()]);

            // Renderiza conteúdo estático
            renderCalendar();
            renderAbout();

            // Configura a exibição inicial da aba
            const tabs = document.querySelectorAll('.tab-button');
            const contentSections = document.querySelectorAll('.content-section');

            function switchTab(e) {
                const targetTab = e.currentTarget.dataset.tab;

                tabs.forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.tab === targetTab);
                });

                contentSections.forEach(section => {
                    section.classList.toggle('active', section.id === targetTab);
                });

                if (targetTab === 'inicio') {
                    renderDashboard();
                } else if (targetTab === 'gestao') {
                    if (userRole === 'secretary') {
                        renderSecretaryDashboard();
                    } else if (userRole === 'leader') {
                        renderUnitLeaderDashboard();
                    } else {
                        // Fallback se o utilizador de alguma forma aceder à aba de gestão sem papel
                        showMessage("Você não tem permissão para aceder a esta seção.");
                        document.querySelector('.tab-button[data-tab="inicio"]').click(); // Redireciona para o início
                    }
                }
            }

            tabs.forEach(tab => tab.addEventListener('click', switchTab));

            document.body.addEventListener('click', function (event) {
                if (event.target.matches('.accordion-button') || event.target.closest('.accordion-button')) {
                    const button = event.target.matches('.accordion-button') ? event.target : event.target.closest('.accordion-button');
                    const content = button.nextElementSibling;
                    const icon = button.querySelector('span:last-child');

                    button.classList.toggle('open');
                    icon.classList.toggle('rotate-180');

                    if (button.classList.contains('open')) {
                        content.style.maxHeight = content.scrollHeight + 'px';
                    } else {
                        content.style.maxHeight = null;
                    }
                }
            });

            // Define a aba inicial como 'inicio' e renderiza o dashboard
            document.querySelector('.tab-button[data-tab="inicio"]').classList.add('active');
            document.getElementById('inicio').classList.add('active');
            renderDashboard();
        }
    </script>
    </body>

</html>