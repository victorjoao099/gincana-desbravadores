<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gincana de Unidades: A Aventura do Desbravador</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .tab-button.active {
            border-bottom-color: #2563eb;
            /* theme-blue-600 */
            color: #2563eb;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }

        .accordion-button.open+.accordion-content {
            max-height: 1000px;
            /* Adjust as needed for content length */
        }

        .chart-container {
            position: relative;
            height: 40vh;
            /* Responsive height */
            width: 100%;
            max-width: 800px;
            /* Max width to prevent excessive stretching */
            margin: auto;
            /* Center horizontally */
            max-height: 400px;
            /* Max height to prevent vertical overflow */
        }

        @media (max-width: 768px) {
            .chart-container {
                height: 60vh;
                /* Taller on mobile for better readability */
            }

            /* Specific for mobile nav to ensure scroll works well */
            nav.overflow-x-auto {
                justify-content: flex-start;
                /* Align tabs to the start for better scroll */
            }
        }

        .list-disc-custom li::marker {
            color: #2563eb;
            /* Custom bullet color */
        }

        .list-decimal-custom li::marker {
            color: #2563eb;
            /* Custom number color */
        }

        /* Estilos para status de submiss√£o */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            /* pill shape */
            font-size: 0.75rem;
            /* text-xs */
            font-weight: 600;
            /* semibold */
            text-transform: capitalize;
        }

        .status-badge.pending {
            background-color: #fef9c3;
            /* yellow-100 */
            color: #ca8a04;
            /* yellow-700 */
        }

        .status-badge.approved {
            background-color: #dcfce7;
            /* green-100 */
            color: #16a34a;
            /* green-700 */
        }

        .status-badge.rejected {
            background-color: #fee2e2;
            /* red-100 */
            color: #dc2626;
            /* red-700 */
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay"
        class="fixed inset-0 bg-slate-100 bg-opacity-90 flex flex-col justify-center items-center z-50">
        <div class="animate-spin rounded-full h-20 w-20 border-t-2 border-b-2 border-blue-500"></div>
        <p class="mt-4 text-lg text-slate-700">A carregar aplica√ß√£o...</p>
    </div>

    <!-- Message Box -->
    <div id="messageBox" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 hidden">
        <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full text-center">
            <p id="messageText" class="text-lg font-semibold mb-4"></p>
            <div class="flex justify-center space-x-4">
                <button id="messageConfirmBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">OK</button>
                <button id="messageCancelBtn"
                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 hidden">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Authentication Section (visible by default, hidden by JS on auth) -->
    <section id="auth-section"
        class="flex items-center justify-center min-h-screen bg-gradient-to-br from-slate-100 to-blue-200 p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
            <h2 class="text-3xl font-bold text-blue-800 mb-6">Acesso √† Gincana</h2>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="email" class="sr-only">Email</label>
                    <input type="email" id="email" placeholder="Email"
                        class="w-full p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                        required>
                </div>
                <div>
                    <label for="password" class="sr-only">Palavra-passe</label>
                    <input type="password" id="password" placeholder="Palavra-passe"
                        class="w-full p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                        required>
                </div>
                <button type="submit" id="login-btn"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">Iniciar
                    Sess√£o</button>
                <button type="button" id="register-btn"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">Registar</button>
            </form>
            <p class="text-sm text-slate-500 mt-4">
                Se esta √© a sua primeira vez, registe-se. Ap√≥s o registo, o seu papel (L√≠der ou Secret√°rio) ser√°
                definido no sistema.
            </p>
        </div>
    </section>

    <!-- Main Application Content (hidden until authenticated) -->
    <div id="main-app-content" class="container mx-auto p-4 md:p-8 hidden">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-blue-800">Gincana de Unidades</h1>
            <h2 class="text-2xl md:text-3xl font-semibold text-slate-600">A Aventura do Desbravador</h2>
            <p class="mt-4 text-slate-500 italic max-w-3xl mx-auto">"N√£o to mandei eu? S√™ forte e corajoso; n√£o temas,
                nem te espantes, porque o Senhor teu Deus √© contigo, por onde quer que andares." ‚Äì Josu√© 1:9</p>
            <p id="user-info" class="mt-2 text-sm text-slate-500">Carregando informa√ß√µes do utilizador...</p>
            <button id="logout-btn"
                class="mt-4 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md hidden">Sair</button>
        </header>

        <!-- Navigation Tabs -->
        <!-- MODIFICA√á√ÉO: Removido justify-center para melhorar o scroll em mobile, adicionado md:justify-center para telas maiores -->
        <nav class="flex md:justify-center border-b-2 border-slate-200 mb-8 overflow-x-auto">
            <button data-tab="inicio"
                class="tab-button text-lg font-semibold p-4 border-b-4 border-transparent hover:text-blue-600 transition-colors duration-300 whitespace-nowrap">üèÅ
                In√≠cio</button>
            <button data-tab="calendario"
                class="tab-button text-lg font-semibold p-4 border-b-4 border-transparent hover:text-blue-600 transition-colors duration-300 whitespace-nowrap">üìÖ
                Calend√°rio</button>
            <button data-tab="regulamento"
                class="tab-button text-lg font-semibold p-4 border-b-4 border-transparent hover:text-blue-600 transition-colors duration-300 whitespace-nowrap">üìú
                Regulamento</button>
            <button data-tab="sobre"
                class="tab-button text-lg font-semibold p-4 border-b-4 border-transparent hover:text-blue-600 transition-colors duration-300 whitespace-nowrap">üõ°Ô∏è
                Sobre o Clube</button>
            <button data-tab="gestao"
                class="tab-button text-lg font-semibold p-4 border-b-4 border-transparent hover:text-blue-600 transition-colors duration-300 whitespace-nowrap hidden">‚öôÔ∏è
                Gest√£o</button>
        </nav>

        <!-- Content Area -->
        <main>
            <!-- In√≠cio / Dashboard Section -->
            <section id="inicio" class="content-section">
                <p class="mb-6 text-slate-700 text-center">Bem-vindo ao painel da Gincana de Unidades! Aqui voc√™
                    encontra um resumo r√°pido do progresso e o placar geral das unidades. Explore as outras abas para
                    detalhes sobre o calend√°rio, regulamento e informa√ß√µes do clube.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 text-center">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-slate-500 font-semibold text-lg">Unidade em Destaque</h3>
                        <p id="unidade-destaque" class="text-3xl font-bold text-blue-600 mt-2">Carregando...</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-slate-500 font-semibold text-lg">Total de Pontos Acumulados</h3>
                        <p id="total-pontos" class="text-3xl font-bold text-blue-600 mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-slate-500 font-semibold text-lg">Atividades Conclu√≠das</h3>
                        <p id="atividades-realizadas" class="text-3xl font-bold text-blue-600 mt-2">0 / 0</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-2xl font-bold text-slate-700 mb-4 text-center">Placar Geral da Gincana</h3>
                    <div class="chart-container">
                        <canvas id="scoreChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Calend√°rio Section -->
            <section id="calendario" class="content-section">
                <h2 class="text-3xl font-bold text-center mb-8 text-slate-700">Calend√°rio de Atividades</h2>
                <p class="mb-6 text-slate-700 text-center">Navegue pelas atividades di√°rias e semanais programadas para
                    cada m√™s. As atividades semanais ocorrem sempre aos domingos.</p>
                <div id="calendario-container" class="space-y-4">
                </div>
            </section>

            <!-- Regulamento Section -->
            <section id="regulamento" class="content-section">
                <h2 class="text-3xl font-bold text-center mb-8 text-slate-700">Regulamento Interno da Gincana</h2>
                <p class="mb-6 text-slate-700 text-center">Conhe√ßa as regras de pontua√ß√£o, crit√©rios de desempate,
                    conduta esperada e procedimentos para recursos, garantindo uma gincana justa e organizada.</p>
                <div class="space-y-4">
                    <div class="bg-white rounded-xl shadow-md">
                        <button
                            class="accordion-button w-full text-left p-6 font-bold text-xl text-blue-800 flex justify-between items-center">
                            <span>1. Sistema de Pontua√ß√£o</span>
                            <span class="transform transition-transform duration-300">‚ñº</span>
                        </button>
                        <div id="pontuacao-content" class="accordion-content px-6 pb-6 text-slate-600 space-y-4">
                            <h4 class="font-bold text-lg text-slate-700">Pontua√ß√£o Base por Atividade:</h4>
                            <ul class="list-disc list-inside list-disc-custom space-y-1">
                                <li><strong>Atividades Di√°rias:</strong> 5 pontos por Desbravador presente e ativo na
                                    atividade. 5-10 pontos extras por Desbravador que concluir ou acertar o desafio.
                                </li>
                                <li><strong>Atividades Semanais:</strong> 20 pontos por unidade que participar
                                    integralmente. 30-100 pontos por desempenho/conclus√£o. 10-50 pontos extras por
                                    qualidade/criatividade.</li>
                            </ul>
                            <h4 class="font-bold text-lg text-slate-700 mt-4">B√¥nus Especiais:</h4>
                            <ul class="list-disc list-inside list-disc-custom space-y-1">
                                <li><strong>"Esp√≠rito Desbravador" (Semanal):</strong> 50 pontos.</li>
                                <li><strong>"Unidade Nota 10" (Mensal):</strong> 100 pontos.</li>
                                <li><strong>"Uniforme Impec√°vel" (Semanal):</strong> 20 pontos.</li>
                                <li><strong>"Desafio Surpresa":</strong> Pontos vari√°veis.</li>
                            </ul>
                            <h4 class="font-bold text-lg text-slate-700 mt-4">Penalidades:</h4>
                            <ul class="list-disc list-inside list-disc-custom space-y-1">
                                <li><strong>Atraso na Entrega:</strong> -10 pontos por dia.</li>
                                <li><strong>Comportamento Antidesbravador:</strong> -20 a -50 pontos.</li>
                                <li><strong>Falta em Atividades Obrigat√≥rias:</strong> -10 pontos por membro.</li>
                            </ul>
                            <h4 class="font-bold text-lg text-slate-700 mt-4">Placar e Acompanhamento:</h4>
                            <p>Um Placar Geral vis√≠vel e atualizado semanalmente (online ou f√≠sico) com a pontua√ß√£o de
                                cada unidade. Um "Painel de Conquistas" registrar√° visualmente os progressos.</p>
                            <h4 class="font-bold text-lg text-slate-700 mt-4">Submiss√£o e Valida√ß√£o de Requisitos:</h4>
                            <p>Os l√≠deres de unidade registrar√£o a conclus√£o dos requisitos no "Cantinho da Unidade" (<a
                                    href="https://clubes.adventistas.org/br/unit-control/" target="_blank"
                                    class="text-blue-600 hover:underline">https://clubes.adventistas.org/br/unit-control/</a>).
                                A secret√°ria do clube validar√° os requisitos e atribuir√° a pontua√ß√£o via SGC (<a
                                    href="https://sg.sdasystems.org/cms/login.php?lang=pt_br" target="_blank"
                                    class="text-blue-600 hover:underline">https://sg.sdasystems.org/cms/login.php?lang=pt_br</a>).
                                Um PDF com o placar de pontos atualizado ser√° divulgado semanalmente.</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md">
                        <button
                            class="accordion-button w-full text-left p-6 font-bold text-xl text-blue-800 flex justify-between items-center">
                            <span>2. Crit√©rios de Desempate</span>
                            <span class="transform transition-transform duration-300">‚ñº</span>
                        </button>
                        <div id="desempate-content" class="accordion-content px-6 pb-6 text-slate-600 space-y-4">
                            <p>Em caso de empate na pontua√ß√£o final ou em qualquer etapa decisiva, os seguintes
                                crit√©rios ser√£o aplicados sequencialmente:</p>
                            <ol class="list-decimal list-inside list-decimal-custom space-y-1">
                                <li>Maior n√∫mero de B√¥nus "Esp√≠rito Desbravador" acumulados.</li>
                                <li>Maior n√∫mero de Atividades Semanais conclu√≠das com pontua√ß√£o m√°xima.</li>
                                <li>Menor n√∫mero de Penalidades registradas.</li>
                                <li>Sorteio: Em caso de persist√™ncia do empate, ser√° realizado um sorteio justo e
                                    transparente.</li>
                            </ol>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md">
                        <button
                            class="accordion-button w-full text-left p-6 font-bold text-xl text-blue-800 flex justify-between items-center">
                            <span>3. Conduta Esperada</span>
                            <span class="transform transition-transform duration-300">‚ñº</span>
                        </button>
                        <div id="conduta-content" class="accordion-content px-6 pb-6 text-slate-600 space-y-4">
                            <p>Todos os Desbravadores e l√≠deres devem aderir aos princ√≠pios de conduta do Clube:</p>
                            <ul class="list-disc list-inside list-disc-custom space-y-1">
                                <li><strong>Respeito:</strong> Tratar todos com respeito, cortesia e empatia.</li>
                                <li><strong>Coopera√ß√£o:</strong> Trabalhar em equipe, auxiliando os colegas e a unidade.
                                </li>
                                <li><strong>Disciplina:</strong> Seguir as instru√ß√µes dos l√≠deres e as regras do clube.
                                </li>
                                <li><strong>Integridade:</strong> Ser honesto em todas as atividades e submiss√µes.</li>
                                <li><strong>Esp√≠rito Esportivo:</strong> Aceitar vit√≥rias e derrotas com humildade e
                                    dignidade.</li>
                                <li><strong>Seguran√ßa:</strong> Priorizar a seguran√ßa pr√≥pria e alheia em todas as
                                    atividades.</li>
                            </ul>
                            <p class="mt-2">Comportamentos que contrariem os ideais do Desbravador ou que prejudiquem o
                                ambiente da gincana ser√£o pass√≠veis de penalidades.</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md">
                        <button
                            class="accordion-button w-full text-left p-6 font-bold text-xl text-blue-800 flex justify-between items-center">
                            <span>4. Procedimentos para Recursos (Apela√ß√µes)</span>
                            <span class="transform transition-transform duration-300">‚ñº</span>
                        </button>
                        <div id="recursos-content" class="accordion-content px-6 pb-6 text-slate-600 space-y-4">
                            <p>Caso uma unidade ou l√≠der discorde da pontua√ß√£o atribu√≠da ou de uma penalidade, poder√°
                                apresentar um recurso:</p>
                            <ol class="list-decimal list-inside list-decimal-custom space-y-1">
                                <li><strong>Comunica√ß√£o Inicial:</strong> O l√≠der da unidade deve comunicar formalmente
                                    a secret√°ria do clube, por escrito (e-mail ou mensagem oficial), no prazo m√°ximo de
                                    24 horas ap√≥s a divulga√ß√£o da pontua√ß√£o contestada.</li>
                                <li><strong>An√°lise Preliminar:</strong> A secret√°ria e o diretor associado respons√°vel
                                    pela gincana analisar√£o o recurso e as evid√™ncias.</li>
                                <li><strong>Decis√£o:</strong> A decis√£o ser√° comunicada ao l√≠der da unidade em at√© 48
                                    horas. A decis√£o da diretoria √© final e irrevog√°vel.</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sobre o Clube Section -->
            <section id="sobre" class="content-section">
                <h2 class="text-3xl font-bold text-center mb-8 text-slate-700">Sobre o Clube de Desbravadores</h2>
                <p class="mb-6 text-slate-700 text-center">Conhe√ßa os fundamentos, a hist√≥ria e a estrutura que guiam o
                    Clube de Desbravadores, um movimento mundial dedicado ao desenvolvimento integral de juvenis e
                    adolescentes.</p>
                <div class="space-y-4">
                    <div class="bg-white rounded-xl shadow-md">
                        <button
                            class="accordion-button w-full text-left p-6 font-bold text-xl text-blue-800 flex justify-between items-center">
                            <span>As Bases do Clube</span>
                            <span class="transform transition-transform duration-300">‚ñº</span>
                        </button>
                        <div id="bases-content" class="accordion-content px-6 pb-6 text-slate-600 space-y-4">
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md">
                        <button
                            class="accordion-button w-full text-left p-6 font-bold text-xl text-blue-800 flex justify-between items-center">
                            <span>Estrutura e Fun√ß√µes</span>
                            <span class="transform transition-transform duration-300">‚ñº</span>
                        </button>
                        <div id="funcoes-content" class="accordion-content px-6 pb-6 text-slate-600 space-y-4">
                        </div>
                    </div>
                </div>
            </section>

            <!-- Gest√£o Section -->
            <section id="gestao" class="content-section">
                <h2 id="gestao-title" class="text-3xl font-bold text-center mb-8 text-slate-700">
                    Carregando informa√ß√µes de gest√£o...
                </h2>
                <div id="gestao-content" class="space-y-6">
                    <!-- O conte√∫do espec√≠fico do papel (L√≠der ou Secret√°rio) ser√° carregado aqui pelo JavaScript -->
                </div>
            </section>
        </main>
    </div>

    <!-- Firebase SDKs e l√≥gica principal da aplica√ß√£o (como um m√≥dulo) -->
    <script type="module">
        console.log("Script de m√≥dulo a ser executado - Vers√£o: 2024-06-04_16:30_MOBILE_FIX");

        // Importa√ß√µes do Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        // Vari√°veis de estado do Firebase e da aplica√ß√£o (dentro do escopo do m√≥dulo)
        let firebaseApp = null;
        let db = null;
        let auth = null;
        let currentUser = null;
        let userRole = null;

        // =====================================================================================================
        // === ATEN√á√ÉO: CONFIGURA√á√ÉO DO FIREBASE ===
        // =====================================================================================================
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'gincana-de-unidade';

        const firebaseConfigFromGlobal = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

        const firebaseConfig = firebaseConfigFromGlobal || {
            apiKey: "AIzaSyBJI_Hrp1I5GJHt82UKo5xjr392Z4XTMS8",
            authDomain: "gincana-de-unidade.firebaseapp.com",
            projectId: "gincana-de-unidade",
            storageBucket: "gincana-de-unidade.appspot.com",
            messagingSenderId: "497226153394",
            appId: "1:497226153394:web:35d484f3737e3a3b4938ab"
        };
        // =====================================================================================================
        // === FIM DA CONFIGURA√á√ÉO DO FIREBASE ===
        // =====================================================================================================

        console.log("firebaseConfig a ser usado:", firebaseConfig);
        console.log("appId a ser usado:", appId);


        // MessageBox function
        const showMessage = (msg, callback, showCancel = false) => {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const confirmBtn = document.getElementById('messageConfirmBtn');
            const cancelBtn = document.getElementById('messageCancelBtn');

            if (!messageBox || !messageText || !confirmBtn || !cancelBtn) {
                console.error("Erro: Elementos da caixa de mensagem n√£o encontrados. N√£o √© poss√≠vel exibir a mensagem.");
                console.warn("Fallback para console.log:", msg);
                if (callback) callback(true);
                return;
            }

            messageText.textContent = msg;
            messageBox.classList.remove('hidden');

            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            const newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);


            newConfirmBtn.onclick = () => {
                messageBox.classList.add('hidden');
                if (callback) callback(true);
            };

            if (showCancel) {
                newCancelBtn.classList.remove('hidden');
                newCancelBtn.onclick = () => {
                    messageBox.classList.add('hidden');
                    if (callback) callback(false);
                };
            } else {
                newCancelBtn.classList.add('hidden');
            }
        };

        // Vari√°veis de estado da aplica√ß√£o
        let chartInstance = null;
        let currentUnits = [];
        let currentActivities = [];
        let currentSubmissions = [];
        let currentDemerits = [];

        // Dados est√°ticos da aplica√ß√£o
        const staticData = {
            calendar: {
                "Junho: M√™s do Pioneirismo e da Natureza": [
                    { date: "08/06/2025", title: "Constru√ß√£o de Abrigo Improvisado", desc: "Cada unidade deve construir um abrigo simples e funcional usando materiais naturais ou lona/corda, capaz de proteger minimamente de intemp√©ries. (Pioneirismo)" },
                    { date: "15/06/2025", title: "Trilha de Observa√ß√£o e Registro", desc: "Caminhada em trilha segura com uma lista de itens da natureza para encontrar, identificar e registrar (fotos, desenhos ou anota√ß√µes). (Natureza)" },
                    { date: "22/06/2025", title: "Cozinha Mateira Criativa", desc: "Preparar um lanche simples e saboroso ao ar livre utilizando t√©cnicas de fogueira segura. Criatividade na receita e seguran√ßa no manuseio do fogo ser√£o avaliadas. (Culin√°ria/Pioneirismo)" },
                    { date: "29/06/2025", title: "Ca√ßa ao Tesouro da Orienta√ß√£o", desc: "Utilizando b√∫ssola e um mapa simples, as unidades devem seguir pistas para encontrar um tesouro escondido. (Orienta√ß√£o)" }
                ],
                "Julho: M√™s da Sa√∫de e Bem-Estar": [
                    { date: "06/07/2025", title: "Circuito de Habilidades F√≠sicas", desc: "Montagem de um circuito com 5 a 7 esta√ß√µes que envolvam corrida, salto, agachamento, flex√£o, polichinelos (adaptadas √† idade e capacidade). As unidades competem para completar o circuito no menor tempo, com boa execu√ß√£o. (F√≠sico)" },
                    { date: "13/07/2025", title: "Oficina de Primeiros Socorros B√°sicos", desc: "Simula√ß√£o de situa√ß√µes de emerg√™ncia comuns (pequenos cortes, entorses, picadas de inseto). As unidades devem demonstrar como fazer curativos simples, imobilizar um bra√ßo, estancar sangramento e acionar ajuda. (Primeiros Socorros)" },
                    { date: "20/07/2025", title: "Gincana Esportiva L√∫dica", desc: "Competi√ß√µes de jogos populares e cooperativos como cabo de guerra, corrida de saco, queimada (com regras adaptadas para seguran√ßa e inclus√£o). O esp√≠rito esportivo e a divers√£o ser√£o valorizados. (F√≠sico/Integra√ß√£o)" },
                    { date: "27/07/2025", title: "Culin√°ria Saud√°vel Desbravador", desc: "Cada unidade prepara uma receita saud√°vel e saborosa (ex: salada de frutas criativa, sandu√≠ches naturais, sucos detox). A apresenta√ß√£o, o sabor e a explica√ß√£o dos benef√≠cios nutricionais ser√£o avaliadas. (Culin√°ria/Sa√∫de)" }
                ],
                "Agosto: M√™s da Comunica√ß√£o e Express√£o": [
                    { date: "03/08/2025", title: "Teatro de Fantoches/M√≠mica com Mensagem", desc: "Cada unidade cria e apresenta uma pequena pe√ßa de teatro de fantoches ou uma esquete de m√≠mica com uma mensagem positiva ou um ensinamento moral (ex: sobre honestidade, amizade, respeito). (Criatividade/Express√£o)" },
                    { date: "10/08/2025", title: "Campanha de Conscientiza√ß√£o Criativa", desc: "As unidades devem desenvolver uma pequena campanha de conscientiza√ß√£o sobre um tema relevante para a comunidade (ex: reciclagem, combate ao bullying, import√¢ncia da leitura). Podem ser cartazes, v√≠deos curtos (para exibi√ß√£o interna), jingles ou pequenas apresenta√ß√µes. (Servi√ßo/Comunica√ß√£o)" },
                    { date: "17/08/2025", title: "Roda de Conversa: Meus Sonhos e Talentos", desc: "Em um ambiente acolhedor, cada Desbravador compartilha um sonho pessoal ou um talento que possui/gostaria de desenvolver. A escuta ativa e o apoio m√∫tuo s√£o incentivados. (Espiritual/Social)" },
                    { date: "24/08/2025", title: "Visita e A√ß√£o de Doa√ß√£o a uma Institui√ß√£o", desc: "A unidade organiza e realiza uma visita a um asilo, orfanato ou institui√ß√£o de caridade (com permiss√£o e acompanhamento da diretoria), levando doa√ß√µes (arrecadadas previamente) e, se poss√≠vel, realizando uma pequena apresenta√ß√£o ou atividade interativa. (Servi√ßo Comunit√°rio)" },
                    { date: "31/08/2025", title: "Descanso/Prepara√ß√£o para Setembro", desc: "Dia livre para atividades de autocuidado e reflex√£o individual." }
                ],
                "Setembro: M√™s do Conhecimento e da Hist√≥ria": [
                    { date: "07/09/2025", title: "Gincana do Conhecimento Desbravador", desc: "Uma competi√ß√£o de perguntas e respostas sobre a hist√≥ria do clube, seus ideais (Voto e Lei), classes, especialidades e regulamentos b√°sicos. (Mental)" },
                    { date: "14/09/2025", title: "Estudo B√≠blico Aprofundado e Apresenta√ß√£o", desc: "Cada unidade escolhe um tema b√≠blico (ex: a cria√ß√£o, a hist√≥ria de Jos√©, os milagres de Jesus) e prepara um pequeno estudo para apresentar de forma criativa (com slides, desenhos, encena√ß√£o) para as outras unidades. (Espiritual/Mental)" },
                    { date: "21/09/2025", title: "Projeto de Civismo 'Minha P√°tria, Minha Hist√≥ria'", desc: "Pesquisar sobre um her√≥i nacional, um s√≠mbolo do pa√≠s (bandeira, hino) ou um evento hist√≥rico importante. As unidades devem apresentar suas descobertas de forma criativa (mural, jogral, v√≠deo). (C√≠vico/Mental)" },
                    { date: "28/09/2025", title: "Cria√ß√£o de um 'Museu' do Clube", desc: "Cada unidade monta um pequeno painel ou 'exposi√ß√£o' com fotos, objetos, distintivos e hist√≥rias que representem a trajet√≥ria da sua unidade e do clube. (Hist√≥ria/Criatividade)" }
                ],
                "Outubro: M√™s da Aventura e da Supera√ß√£o": [
                    { date: "05/10/2025", title: "Circuito de Aventura 'Desbravador Radical'", desc: "Montar um circuito com obst√°culos (rastejar sob cordas, pular pneus, passar por t√∫neis improvisados, escalar baixo em estruturas seguras) que exija coordena√ß√£o, agilidade e trabalho em equipe. (F√≠sico/Mental)" },
                    { date: "12/10/2025", title: "Desafio de Sobreviv√™ncia (Te√≥rico e Pr√°tico)", desc: "Simula√ß√£o de situa√ß√µes de sobreviv√™ncia. As unidades devem demonstrar habilidades como purificar √°gua (te√≥rico), fazer um sinal de socorro, montar uma pequena armadilha (segura e n√£o-letal), identificar plantas seguras para consumo (te√≥rico). (Pioneirismo/Mental)" },
                    { date: "19/10/2025", title: "Jogo Noturno 'Mist√©rio da Mata'", desc: "Um jogo de estrat√©gia ou ca√ßa ao tesouro em ambiente escuro (com lanternas e supervis√£o rigorosa), onde as unidades precisam usar a audi√ß√£o, tato e trabalho em equipe para cumprir objetivos. (Mental/F√≠sico)" },
                    { date: "26/10/2025", title: "Desafio de Resolu√ß√£o de Problemas 'A Ponte da Unidade'", desc: "Apresentar um problema complexo para as unidades, como 'construir uma ponte que suporte um peso X usando apenas materiais Y e Z'. A criatividade e a efic√°cia da solu√ß√£o ser√£o avaliadas. (Mental/Engenharia)" }
                ],
                "Novembro: M√™s da Gratid√£o e da Celebra√ß√£o": [
                    { date: "02/11/2025", title: "Prepara√ß√£o da C√°psula do Tempo da Gincana", desc: "Cada unidade re√∫ne objetos simb√≥licos, fotos, mensagens e relatos sobre suas experi√™ncias na gincana. A c√°psula ser√° lacrada e aberta em uma data futura (ex: daqui a 1 ano), para relembrar as conquistas. (Criatividade/Reflex√£o)" },
                    { date: "09/11/2025", title: "Dia da Gratid√£o e Servi√ßo Comunit√°rio", desc: "A√ß√µes de servi√ßo focadas em expressar gratid√£o √† comunidade ou √† igreja. Exemplos: limpeza e organiza√ß√£o do local do clube, ajuda em eventos da igreja, prepara√ß√£o de cestas b√°sicas para doa√ß√£o. (Servi√ßo/Espiritual)" },
                    { date: "16/11/2025", title: "Ensaio Geral para a Celebra√ß√£o Final", desc: "As unidades praticam quaisquer apresenta√ß√µes, cantos, jograis ou n√∫meros de Ordem Unida que desejam apresentar no evento de encerramento. Este √© um momento de integra√ß√£o e aprimoramento. (Integra√ß√£o)" },
                    { date: "23/11/2025", title: "Grande Jogo Final 'A Jornada do Desbravador'", desc: "Uma atividade abrangente que combina elementos de todos os meses, testando diversas habilidades (f√≠sicas, mentais, de pioneirismo, etc.) e o esp√≠rito de equipe. Pode ser um circuito de esta√ß√µes, um jogo de tabuleiro gigante ou uma grande ca√ßa ao tesouro com desafios variados. (Revis√£o/Integra√ß√£o)" },
                    { date: "30/11/2025", title: "√öltima revis√£o e prepara√ß√£o para a Celebra√ß√£o Final", desc: "Dia dedicado aos √∫ltimos preparativos para o grande evento de encerramento da gincana." }
                ],
                "Dezembro: Grande Celebra√ß√£o e Encerramento": [
                    { date: "01/12/2025", title: "Grande Celebra√ß√£o e Encerramento da Gincana", desc: "Um evento especial com a presen√ßa dos pais, familiares e da comunidade, para celebrar as conquistas da gincana. Incluir√° apresenta√ß√µes das unidades, reconhecimento, a revela√ß√£o do placar final e premia√ß√£o, uma mensagem final inspiradora dos l√≠deres e confraterniza√ß√£o." }
                ]
            },
            bases: [
                { title: "Origem Hist√≥rica", content: "O Clube de Desbravadores foi oficializado em n√≠vel mundial no ano de 1950 pela Associa√ß√£o Geral da Igreja Adventista do S√©timo Dia, nos Estados Unidos. Suas ra√≠zes, no entanto, remontam a iniciativas anteriores de clubes mission√°rios e de jovens que buscavam o desenvolvimento integral." },
                { title: "Filosofia", content: "A filosofia do Clube de Desbravadores baseia-se no desenvolvimento harmonioso das for√ßas f√≠sicas, mentais e espirituais dos juvenis e adolescentes. O programa busca preparar os jovens para a cidadania √∫til, o servi√ßo √† comunidade e o compromisso com Deus. Tudo o que o Desbravador faz tem um sentido, uma base, um alicerce de valores crist√£os e princ√≠pios de vida." },
                { title: "Objetivos Priorit√°rios", content: "Os objetivos do Clube s√£o amplos e visam o crescimento completo do indiv√≠duo: Desenvolvimento F√≠sico, Mental, Espiritual e Social." },
                { title: "S√≠mbolos do Clube", content: "Os s√≠mbolos do Desbravador s√£o elementos visuais e conceituais que representam seus princ√≠pios: Ideais (Voto e Lei), Hino, Emblemas, Bandeira, Bandeirim e o Uniforme." }
            ],
            funcoes: {
                "Cargos da Unidade": [
                    { title: "Conselheiro(a)", content: "√â a autoridade m√°xima dentro da unidade, respons√°vel pela ordem e andamento geral. Atua como elo entre a unidade e a dire√ß√£o do clube. Geralmente, deve ser batizado e ter mais de 18 anos (ou 16+ com supervis√£o de um diretor maior de idade em atividades externas)." },
                    { title: "Capit√£o(√£)", content: "Membro da unidade (10 a 15 anos) respons√°vel por animar o grupo a cumprir o programa, por meio do exemplo e influ√™ncia pessoal. Lidera a unidade em forma√ß√µes de Ordem Unida e a representa perante a dire√ß√£o. Deve ser organizado, ter lideran√ßa, disciplina, honestidade, fidelidade e humildade." },
                    { title: "Secret√°rio(a) de Unidade", content: "Respons√°vel por manter os registos da unidade atualizados, incluindo chamada de presen√ßa, pontualidade, assiduidade, uso do uniforme e higiene pessoal. Idade entre 10 e 15 anos." },
                    { title: "Tesoureiro(a) de Unidade", content: "Gerencia os pequenos recursos financeiros da unidade, mantendo registos precisos de despesas e receitas. Idade entre 10 e 15 anos." },
                    { title: "Padioleiro(a) de Unidade", content: "Atua como o 'enfermeiro' da unidade, respons√°vel por auxiliar em pequenos acidentes e aplicar primeiros socorros b√°sicos, sob supervis√£o. Idade entre 10 e 15 anos." },
                    { title: "Almoxarife de Unidade", content: "Respons√°vel pela guarda e organiza√ß√£o dos materiais e equipamentos da unidade. Idade entre 10 e 15 anos." },
                    { title: "Capel√£o(√£) de Unidade", content: "Mant√©m a ordem e harmonia espiritual da unidade, juntamente com o conselheiro, promovendo momentos de reflex√£o e estudo b√≠blico. Idade entre 10 e 15 anos, deve ser de boa √≠ndole e respeitador." }
                ],
                "Cargos da Dire√ß√£o do Clube": [
                    { title: "Diretor(a) do Clube", content: "√â a autoridade m√°xima do clube. Respons√°vel por planejar, organizar e supervisionar todas as atividades, manter a liga√ß√£o com o Pastor e a Associa√ß√£o, presidir as reuni√µes da comiss√£o executiva e docente, e assegurar um programa completo para o clube. Deve ser um l√≠der maduro, com boa reputa√ß√£o na Igreja e ter o treinamento para oficiais. Deve ser um exemplo de espiritualidade, prontid√£o, amabilidade, temperan√ßa, pontualidade e asseio pessoal, incluindo o uso adequado do uniforme." },
                    { title: "Diretores(as) Associados(as)", content: "S√£o o bra√ßo direito do diretor, respons√°veis pelo cumprimento do programa do clube. Coordenam as Classes, Especialidades e Unidades, gerenciando o trabalho dos instrutores e conselheiros. Geralmente h√° um diretor associado para a ala feminina e outro para a ala masculina. N√£o h√° limite para o n√∫mero de diretores associados, dependendo do tamanho do clube." },
                    { title: "Secret√°rio(a) do Clube", content: "Assume a responsabilidade pela documenta√ß√£o e registo das atividades do clube. Isso abrange a manuten√ß√£o de registos de membros, elabora√ß√£o de relat√≥rios de eventos e comunica√ß√£o de informa√ß√µes cruciais aos membros e suas fam√≠lias. Essencial para a organiza√ß√£o administrativa do clube." },
                    { title: "Tesoureiro(a) do Clube", content: "Gerencia as finan√ßas do clube, mantendo um registo preciso das despesas e receitas, elaborando or√ßamentos e assegurando o uso respons√°vel dos recursos financeiros dispon√≠veis. Respons√°vel pela sa√∫de financeira do clube." },
                    { title: "Capel√£o(√£) do Clube", content: "Encarregado da dimens√£o espiritual do clube, liderando estudos b√≠blicos, momentos de ora√ß√£o e promovendo os valores e princ√≠pios inerentes √† cren√ßa Adventista do S√©timo Dia. Essencial para o desenvolvimento espiritual dos Desbravadores." },
                    { title: "Conselheiros(as) (Gerais) e Instrutores(as)", content: "Os conselheiros supervisionam as unidades, enquanto os instrutores s√£o respons√°veis por ensinar as classes e especialidades. Ambos trabalham em estreita colabora√ß√£o com os diretores associados para garantir a execu√ß√£o do programa educativo do clube. A fun√ß√£o de conselheiro √© considerada uma das mais importantes, devido ao contato direto com os juvenis." }
                ]
            }
        };

        // Fun√ß√µes de busca de dados do Firebase
        async function getUnits() {
            const unitsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'units');
            return new Promise((resolve, reject) => {
                onSnapshot(query(unitsColRef), (snapshot) => {
                    currentUnits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    currentUnits.sort((a, b) => (b.score || 0) - (a.score || 0));
                    resolve(currentUnits);
                }, reject);
            });
        }

        async function getActivities() {
            const activitiesColRef = collection(db, 'artifacts', appId, 'public', 'data', 'activities');
            return new Promise((resolve, reject) => {
                onSnapshot(query(activitiesColRef), (snapshot) => {
                    currentActivities = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    currentActivities.sort((a, b) => a.name.localeCompare(b.name));
                    resolve(currentActivities);
                }, reject);
            });
        }

        async function getSubmissions() {
            const submissionsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'submissions');
            return new Promise((resolve, reject) => {
                onSnapshot(query(submissionsColRef), (snapshot) => {
                    currentSubmissions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    currentSubmissions.sort((a, b) => (b.submittedAt?.toDate() || 0) - (a.submittedAt?.toDate() || 0));
                    resolve(currentSubmissions);
                }, reject);
            });
        }

        async function getDemerits() {
            const demeritsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'demerits');
            return new Promise((resolve, reject) => {
                onSnapshot(query(demeritsColRef), (snapshot) => {
                    currentDemerits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    currentDemerits.sort((a, b) => (b.appliedAt?.toDate() || 0) - (a.appliedAt?.toDate() || 0));
                    resolve(currentDemerits);
                }, reject);
            });
        }

        // Fun√ß√µes de renderiza√ß√£o da UI
        function wrapLabel(label, maxLen) {
            if (!label) return '';
            if (label.length <= maxLen) return label;
            const lines = [];
            let currentLine = '';
            const words = label.split(' ');
            for (const word of words) {
                if ((currentLine + (currentLine ? ' ' : '') + word).length <= maxLen) {
                    currentLine += (currentLine ? ' ' : '') + word;
                } else {
                    if (currentLine) lines.push(currentLine);
                    currentLine = word;
                    while (currentLine.length > maxLen) {
                        lines.push(currentLine.substring(0, maxLen));
                        currentLine = currentLine.substring(maxLen);
                    }
                }
            }
            if (currentLine) lines.push(currentLine);
            return lines;
        }

        function renderDashboard() {
            const unidadeDestaqueEl = document.getElementById('unidade-destaque');
            const totalPontosEl = document.getElementById('total-pontos');
            const atividadesRealizadasEl = document.getElementById('atividades-realizadas');

            if (!unidadeDestaqueEl || !totalPontosEl || !atividadesRealizadasEl) return;

            const totalScore = currentUnits.reduce((sum, item) => sum + (item.score || 0), 0);
            const totalActivitiesDefined = Object.values(staticData.calendar).flat().length;
            const approvedSubmissionsCount = currentSubmissions.filter(sub => sub.status === 'approved').length;

            unidadeDestaqueEl.textContent = currentUnits.length > 0 && currentUnits[0].name ? currentUnits[0].name : 'N/A';
            totalPontosEl.textContent = totalScore;
            atividadesRealizadasEl.textContent = `${approvedSubmissionsCount} / ${totalActivitiesDefined}`;
            renderScoreChart(currentUnits);
        }

        function renderScoreChart(unitsData) {
            const scoreChartEl = document.getElementById('scoreChart');
            if (!scoreChartEl) return;
            const ctx = scoreChartEl.getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: unitsData.map(item => wrapLabel(item.name, 15)),
                    datasets: [{
                        label: 'Pontua√ß√£o da Unidade',
                        data: unitsData.map(item => item.score || 0),
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1,
                        borderRadius: 5,
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.raw} pontos` } } },
                    scales: { x: { beginAtZero: true, grid: { display: true, color: 'rgba(203, 213, 225, 0.5)' } }, y: { grid: { display: false }, ticks: { autoSkip: false } } }
                }
            });
        }

        function renderCalendar() {
            const container = document.getElementById('calendario-container');
            if (!container) return;
            container.innerHTML = '';
            Object.entries(staticData.calendar).forEach(([month, activities]) => {
                const monthDiv = document.createElement('div');
                monthDiv.className = 'bg-white rounded-xl shadow-md';
                const button = document.createElement('button');
                button.className = 'accordion-button w-full text-left p-6 font-bold text-xl text-blue-800 flex justify-between items-center';
                button.innerHTML = `<span>${month}</span><span class="transform transition-transform duration-300">‚ñº</span>`;
                const contentDiv = document.createElement('div');
                contentDiv.className = 'accordion-content px-6 pb-6 text-slate-600 space-y-4';
                activities.forEach(activity => {
                    contentDiv.innerHTML += `<div class="pt-4 border-t first:border-t-0 border-slate-200"><p class="font-semibold text-slate-700">${activity.date} - ${activity.title}</p><p class="text-sm">${activity.desc}</p></div>`;
                });
                monthDiv.appendChild(button);
                monthDiv.appendChild(contentDiv);
                container.appendChild(monthDiv);
            });
        }

        function renderAbout() {
            const basesContainer = document.getElementById('bases-content');
            const funcoesContainer = document.getElementById('funcoes-content');
            if (!basesContainer || !funcoesContainer) return;
            basesContainer.innerHTML = staticData.bases.map(item => `<div class="pt-4 border-t first:border-t-0 border-slate-200"><h4 class="font-bold text-lg text-slate-700">${item.title}</h4><p>${item.content}</p></div>`).join('');
            funcoesContainer.innerHTML = '';
            Object.entries(staticData.funcoes).forEach(([category, roles]) => {
                let catHtml = `<h4 class="font-bold text-lg text-slate-700 pt-4 border-t first:border-t-0 border-slate-200">${category}</h4><ul class="list-disc list-inside list-disc-custom space-y-2">`;
                roles.forEach(role => { catHtml += `<li><strong>${role.title}:</strong> ${role.content}</li>`; });
                catHtml += `</ul>`;
                funcoesContainer.innerHTML += catHtml;
            });
        }

        function renderUnitLeaderDashboard() {
            const gestaoTitleEl = document.getElementById('gestao-title');
            if (gestaoTitleEl) gestaoTitleEl.textContent = 'Dashboard do L√≠der de Unidade'; else return;
            const gestaoContent = document.getElementById('gestao-content');
            if (!gestaoContent) return;

            gestaoContent.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h3 class="text-xl font-semibold text-blue-600 mb-4">Enviar Atividade Conclu√≠da</h3>
                    <form id="submit-activity-form" class="space-y-4 mb-8">
                        <div><label for="unit-select-leader" class="block text-sm font-medium text-slate-700">Sua Unidade:</label><select id="unit-select-leader" class="mt-1 block w-full p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required><option value="">Selecione sua unidade</option></select><p id="no-units-message-leader" class="text-red-500 text-sm mt-2 hidden">Nenhuma unidade.</p></div>
                        <div><label for="activity-select-leader" class="block text-sm font-medium text-slate-700">Atividade:</label><select id="activity-select-leader" class="mt-1 block w-full p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required><option value="">Selecione uma atividade</option></select><p id="no-activities-message-leader" class="text-red-500 text-sm mt-2 hidden">Nenhuma atividade.</p></div>
                        <div><label for="details-leader" class="block text-sm font-medium text-slate-700">Detalhes da Conclus√£o:</label><textarea id="details-leader" rows="3" class="mt-1 block w-full p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required placeholder="Descreva..."></textarea></div>
                        <div><label for="photo-url-leader" class="block text-sm font-medium text-slate-700">URL da Foto (Opcional):</label><input type="url" id="photo-url-leader" class="mt-1 block w-full p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="https://..."></div>
                        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">Enviar</button>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md"><h3 class="text-xl font-semibold text-blue-600 mb-4">Meus Envios Recentes</h3><div id="leader-submissions-list"><p class="text-slate-600">Selecione uma unidade.</p></div></div>`;

            const unitSL = document.getElementById('unit-select-leader');
            const actSL = document.getElementById('activity-select-leader');
            const noUnitsMsgL = document.getElementById('no-units-message-leader');
            const noActsMsgL = document.getElementById('no-activities-message-leader');

            unitSL.innerHTML = currentUnits.length > 0 ? '<option value="">Selecione</option>' + currentUnits.map(u => `<option value="${u.id}">${u.name}</option>`).join('') : '<option value="">Nenhuma unidade</option>';
            if (noUnitsMsgL) noUnitsMsgL.classList.toggle('hidden', currentUnits.length > 0);

            actSL.innerHTML = currentActivities.length > 0 ? '<option value="">Selecione</option>' + currentActivities.map(a => `<option value="${a.id}">${a.name} (${a.type})</option>`).join('') : '<option value="">Nenhuma atividade</option>';
            if (noActsMsgL) noActsMsgL.classList.toggle('hidden', currentActivities.length > 0);

            document.getElementById('submit-activity-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const unitId = unitSL.value, actId = actSL.value, details = document.getElementById('details-leader').value, photoUrl = document.getElementById('photo-url-leader').value;
                if (!unitId || !actId || !details.trim()) { showMessage("Preencha todos os campos obrigat√≥rios."); return; }
                const activity = currentActivities.find(a => a.id === actId);
                if (!activity) { showMessage("Atividade inv√°lida."); return; }
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'submissions'), {
                        unitId, unitName: currentUnits.find(u => u.id === unitId)?.name || '?', activityId: actId, activityName: activity.name, details, photoUrl, status: 'pending', submittedBy: currentUser.uid, submittedAt: serverTimestamp()
                    });
                    showMessage("Enviado com sucesso!");
                    e.target.reset(); unitSL.value = ""; actSL.value = ""; updateLeaderSubmissionsList(""); // Clear list or show placeholder
                } catch (err) { console.error("Erro envio:", err); showMessage("Erro ao enviar."); }
            });

            unitSL.addEventListener('change', (e) => updateLeaderSubmissionsList(e.target.value));
            updateLeaderSubmissionsList(unitSL.value); // Initial call
        }

        function updateLeaderSubmissionsList(selectedUnitId) {
            const listEl = document.getElementById('leader-submissions-list');
            if (!listEl) return;
            if (!selectedUnitId) { listEl.innerHTML = '<p class="text-slate-600">Selecione uma unidade para ver os envios.</p>'; return; }
            const unitSubs = currentSubmissions.filter(s => s.unitId === selectedUnitId);
            if (unitSubs.length === 0) { listEl.innerHTML = '<p class="text-slate-600">Nenhum envio para esta unidade.</p>'; return; }
            listEl.innerHTML = `<div class="overflow-x-auto"><table class="min-w-full bg-white rounded-lg shadow-md"><thead class="bg-blue-100"><tr><th class="th-cell">Atividade</th><th class="th-cell">Detalhes</th><th class="th-cell">Status</th><th class="th-cell">Pontos</th><th class="th-cell rounded-tr-lg">Data</th></tr></thead><tbody>${unitSubs.map(s => `<tr><td class="td-cell">${s.activityName || '?'}</td><td class="td-cell truncate" title="${s.details}">${s.details || '?'}</td><td class="td-cell"><span class="status-badge ${s.status}">${s.status}</span></td><td class="td-cell font-bold">${s.pointsAwarded != null ? s.pointsAwarded : 'N/A'}</td><td class="td-cell">${s.submittedAt ? new Date(s.submittedAt.toDate()).toLocaleDateString('pt-BR') : 'N/A'}</td></tr>`).join('')}</tbody></table></div>`;
            // Helper for table cell classes (can be defined in style or added directly)
            listEl.querySelectorAll('.th-cell').forEach(th => th.classList.add('py-3', 'px-4', 'text-left', 'text-sm', 'font-semibold', 'text-slate-700'));
            listEl.querySelectorAll('.td-cell').forEach(td => td.classList.add('py-3', 'px-4', 'text-sm', 'border-b', 'border-slate-200'));
        }


        function renderSecretaryDashboard() {
            const gestaoTitleEl = document.getElementById('gestao-title');
            if (gestaoTitleEl) gestaoTitleEl.textContent = 'Dashboard do Secret√°rio'; else return;
            const gestaoContent = document.getElementById('gestao-content');
            if (!gestaoContent) return;

            gestaoContent.innerHTML = `
                <section class="admin-section"><h3 class="admin-h3 text-blue-600">Gerenciar Unidades</h3><div class="flex flex-col sm:flex-row gap-4 mb-4"><input type="text" id="new-unit-name" placeholder="Nome da unidade" class="admin-input"><button id="add-unit-btn" class="admin-btn bg-blue-600 hover:bg-blue-700">Adicionar</button></div><div class="table-container"><table class="admin-table"><thead class="bg-blue-100"><tr><th class="th-cell">Unidade</th><th class="th-cell">Pontos</th><th class="th-cell rounded-tr-lg">A√ß√µes</th></tr></thead><tbody id="units-table-body"></tbody></table></div></section>
                <section class="admin-section"><h3 class="admin-h3 text-green-600">Gerenciar Atividades</h3><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4"><input type="text" id="new-activity-name" placeholder="Nome" class="admin-input"><select id="new-activity-type" class="admin-input"><option value="">Tipo</option><option>F√≠sico</option><option>Mental</option><option>Espiritual</option><option>Social</option><option>Pioneirismo</option><option>Natureza</option><option>Servi√ßo</option><option>Culin√°ria</option><option>Geral</option></select><input type="number" id="new-activity-max-points" placeholder="Pontos M√°x." class="admin-input" min="0"></div><button id="add-activity-btn" class="admin-btn bg-green-600 hover:bg-green-700 w-full">Adicionar</button><div class="table-container mt-6"><table class="admin-table"><thead class="bg-green-100"><tr><th class="th-cell">Atividade</th><th class="th-cell">Tipo</th><th class="th-cell">Pontos M√°x.</th><th class="th-cell rounded-tr-lg">A√ß√µes</th></tr></thead><tbody id="activities-table-body"></tbody></table></div></section>
                <section class="admin-section"><h3 class="admin-h3 text-red-700">Gerenciar Dem√©ritos</h3><div class="space-y-4 mb-4"><div><label for="demerit-unit-select" class="admin-label">Unidade:</label><select id="demerit-unit-select" class="admin-input" required><option value="">Selecione</option></select></div><div><label for="demerit-points" class="admin-label">Pontos a Deduzir:</label><input type="number" id="demerit-points" min="1" class="admin-input" required placeholder="Ex: 10"></div><div><label for="demerit-reason" class="admin-label">Raz√£o:</label><textarea id="demerit-reason" rows="3" class="admin-input" required placeholder="Motivo..."></textarea></div><button id="apply-demerit-btn" class="admin-btn bg-red-600 hover:bg-red-700 w-full">Aplicar</button></div><div class="table-container mt-6"><table class="admin-table"><thead class="bg-red-100"><tr><th class="th-cell">Unidade</th><th class="th-cell">Pontos</th><th class="th-cell">Raz√£o</th><th class="th-cell rounded-tr-lg">Data</th></tr></thead><tbody id="demerits-table-body"></tbody></table></div></section>
                <section class="admin-section"><h3 class="admin-h3 text-yellow-800">Envios Pendentes (<span id="pending-submissions-count">0</span>)</h3><div id="pending-submissions-list" class="table-container"><p>Nenhum pendente.</p></div></section>
                <section class="admin-section !mb-0"><h3 class="admin-h3 text-slate-700">Hist√≥rico de Envios</h3><div id="all-submissions-list" class="table-container"><p>Nenhum registro.</p></div></section>`;

            // Aplicar classes comuns para simplificar o HTML injetado
            gestaoContent.querySelectorAll('.admin-section').forEach(el => el.classList.add('mb-8', 'p-4', 'rounded-xl', 'shadow-inner'));
            gestaoContent.querySelectorAll('.admin-h3').forEach(el => el.classList.add('text-xl', 'font-semibold', 'mb-4'));
            gestaoContent.querySelectorAll('.admin-input').forEach(el => el.classList.add('block', 'w-full', 'p-3', 'border', 'border-slate-300', 'rounded-lg', 'focus:ring-2'));
            gestaoContent.querySelectorAll('.admin-btn').forEach(el => el.classList.add('text-white', 'font-bold', 'py-3', 'px-4', 'rounded-lg', 'transition', 'duration-300', 'ease-in-out', 'transform', 'hover:scale-105', 'shadow-md'));
            gestaoContent.querySelectorAll('.admin-label').forEach(el => el.classList.add('block', 'text-sm', 'font-medium', 'text-slate-700', 'mb-1'));
            gestaoContent.querySelectorAll('.table-container').forEach(el => el.classList.add('overflow-x-auto'));
            gestaoContent.querySelectorAll('.admin-table').forEach(el => el.classList.add('min-w-full', 'bg-white', 'rounded-lg', 'shadow-md'));
            gestaoContent.querySelectorAll('.th-cell').forEach(th => th.classList.add('py-3', 'px-4', 'text-left', 'text-sm', 'font-semibold', 'text-slate-700'));
            // Note: td-cell classes will be applied dynamically in their respective update functions

            const demeritUnitSelect = document.getElementById('demerit-unit-select');
            demeritUnitSelect.innerHTML = currentUnits.length > 0 ? '<option value="">Selecione</option>' + currentUnits.map(u => `<option value="${u.id}">${u.name}</option>`).join('') : '<option value="">Nenhuma unidade</option>';

            document.getElementById('apply-demerit-btn').addEventListener('click', async () => {
                const unitId = demeritUnitSelect.value, points = parseInt(document.getElementById('demerit-points').value), reason = document.getElementById('demerit-reason').value.trim();
                if (!unitId || isNaN(points) || points <= 0 || !reason) { showMessage("Preencha os campos do dem√©rito."); return; }
                const unitName = currentUnits.find(u => u.id === unitId)?.name || '?';
                showMessage(`Aplicar ${points} dem√©ritos a "${unitName}" por "${reason}"?`, async (confirmed) => {
                    if (!confirmed) return;
                    try {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'demerits'), { unitId, unitName, points, reason, appliedBy: currentUser.uid, appliedAt: serverTimestamp() });
                        const unitDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'units', unitId);
                        const unitSnap = await getDoc(unitDocRef);
                        if (unitSnap.exists()) await updateDoc(unitDocRef, { score: (unitSnap.data().score || 0) - points });
                        showMessage("Dem√©rito aplicado!");
                        demeritUnitSelect.value = ""; document.getElementById('demerit-points').value = ""; document.getElementById('demerit-reason').value = "";
                    } catch (err) { console.error("Erro dem√©rito:", err); showMessage("Erro ao aplicar dem√©rito."); }
                }, true);
            });

            document.getElementById('add-unit-btn').addEventListener('click', async () => {
                const name = document.getElementById('new-unit-name').value.trim();
                if (!name) { showMessage("Nome da unidade vazio."); return; }
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'units'), { name, score: 0, createdAt: serverTimestamp() });
                    showMessage(`Unidade "${name}" adicionada!`); document.getElementById('new-unit-name').value = '';
                } catch (err) { console.error("Erro unidade:", err); showMessage("Erro ao adicionar unidade."); }
            });

            document.getElementById('add-activity-btn').addEventListener('click', async () => {
                const name = document.getElementById('new-activity-name').value.trim(), type = document.getElementById('new-activity-type').value, maxPoints = parseInt(document.getElementById('new-activity-max-points').value);
                if (!name || !type || isNaN(maxPoints) || maxPoints < 0) { showMessage("Preencha os campos da atividade."); return; }
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'activities'), { name, type, maxPoints, createdAt: serverTimestamp() });
                    showMessage(`Atividade "${name}" adicionada!`);
                    document.getElementById('new-activity-name').value = ''; document.getElementById('new-activity-type').value = ''; document.getElementById('new-activity-max-points').value = '';
                } catch (err) { console.error("Erro atividade:", err); showMessage("Erro ao adicionar atividade."); }
            });

            updateUnitsTable(); updateActivitiesTable(); updateDemeritsTable(); updateSubmissionsTables();
        }

        function applyTableStyles(tableBodyElement) {
            tableBodyElement.querySelectorAll('tr').forEach(tr => tr.classList.add('border-b', 'border-slate-200', 'last:border-b-0', 'hover:bg-slate-50'));
            tableBodyElement.querySelectorAll('td').forEach(td => td.classList.add('py-3', 'px-4', 'text-sm'));
        }

        function updateUnitsTable() {
            const tbody = document.getElementById('units-table-body');
            if (!tbody) return;
            tbody.innerHTML = currentUnits.length === 0 ? '<tr><td colspan="3" class="text-center p-4">Nenhuma unidade.</td></tr>' :
                currentUnits.map(u => `<tr><td>${u.name}</td><td class="font-bold">${u.score || 0}</td><td><button data-id="${u.id}" data-name="${u.name}" class="delete-unit-btn admin-btn-xs bg-red-500 hover:bg-red-600">Excluir</button></td></tr>`).join('');
            applyTableStyles(tbody);
            tbody.querySelectorAll('.delete-unit-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteUnit(e.target.dataset.id, e.target.dataset.name)));
            tbody.querySelectorAll('.admin-btn-xs').forEach(btn => btn.classList.add('text-white', 'font-bold', 'py-1', 'px-2', 'rounded', 'text-xs'));
        }

        async function handleDeleteUnit(unitId, unitName) {
            showMessage(`Excluir "${unitName}"?`, async (confirmed) => {
                if (!confirmed) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'units', unitId));
                    showMessage(`"${unitName}" exclu√≠da!`);
                } catch (err) { console.error("Erro excluir unidade:", err); showMessage("Erro ao excluir."); }
            }, true);
        }

        function updateActivitiesTable() {
            const tbody = document.getElementById('activities-table-body');
            if (!tbody) return;
            tbody.innerHTML = currentActivities.length === 0 ? '<tr><td colspan="4" class="text-center p-4">Nenhuma atividade.</td></tr>' :
                currentActivities.map(a => `<tr><td>${a.name}</td><td>${a.type}</td><td class="font-bold">${a.maxPoints}</td><td><button data-id="${a.id}" data-name="${a.name}" class="delete-activity-btn admin-btn-xs bg-red-500 hover:bg-red-600">Excluir</button></td></tr>`).join('');
            applyTableStyles(tbody);
            tbody.querySelectorAll('.delete-activity-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteActivity(e.target.dataset.id, e.target.dataset.name)));
            tbody.querySelectorAll('.admin-btn-xs').forEach(btn => btn.classList.add('text-white', 'font-bold', 'py-1', 'px-2', 'rounded', 'text-xs'));
        }

        async function handleDeleteActivity(activityId, activityName) {
            showMessage(`Excluir "${activityName}"?`, async (confirmed) => {
                if (!confirmed) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'activities', activityId));
                    showMessage(`"${activityName}" exclu√≠da!`);
                } catch (err) { console.error("Erro excluir atividade:", err); showMessage("Erro ao excluir."); }
            }, true);
        }

        function updateDemeritsTable() {
            const tbody = document.getElementById('demerits-table-body');
            if (!tbody) return;
            tbody.innerHTML = currentDemerits.length === 0 ? '<tr><td colspan="4" class="text-center p-4">Nenhum dem√©rito.</td></tr>' :
                currentDemerits.map(d => `<tr><td>${d.unitName}</td><td class="font-bold text-red-600">-${d.points}</td><td class="truncate max-w-xs" title="${d.reason}">${d.reason}</td><td>${d.appliedAt ? new Date(d.appliedAt.toDate()).toLocaleDateString('pt-BR') : 'N/A'}</td></tr>`).join('');
            applyTableStyles(tbody);
        }

        function updateSubmissionsTables() {
            const pendingSubs = currentSubmissions.filter(s => s.status === 'pending');
            const pendingCountEl = document.getElementById('pending-submissions-count');
            if (pendingCountEl) pendingCountEl.textContent = pendingSubs.length;

            const pendingListDiv = document.getElementById('pending-submissions-list');
            if (pendingListDiv) {
                pendingListDiv.innerHTML = pendingSubs.length === 0 ? '<p class="text-slate-600 p-4">Nenhum envio pendente.</p>' :
                    `<table class="admin-table"><thead class="bg-yellow-100"><tr><th class="th-cell">Unidade</th><th class="th-cell">Atividade</th><th class="th-cell">Detalhes</th><th class="th-cell">Evid√™ncia</th><th class="th-cell">Pontos</th><th class="th-cell rounded-tr-lg">A√ß√µes</th></tr></thead><tbody>${pendingSubs.map(s => {
                        const act = currentActivities.find(a => a.id === s.activityId);
                        const maxPts = act?.maxPoints || 0;
                        return `<tr><td>${s.unitName}</td><td>${s.activityName}</td><td class="truncate max-w-xs" title="${s.details}">${s.details}</td><td>${s.photoUrl ? `<a href="${s.photoUrl}" target="_blank" class="link">Ver</a>` : 'N/A'}</td><td><input type="number" value="${maxPts}" min="0" max="${maxPts}" class="points-input w-20"><span class="text-xs">/${maxPts}</span></td><td class="flex gap-1"><button data-id="${s.id}" data-unit-id="${s.unitId}" class="approve-btn admin-btn-xs bg-green-500">Aprovar</button><button data-id="${s.id}" class="reject-btn admin-btn-xs bg-red-500">Rejeitar</button></td></tr>`;
                    }).join('')}</tbody></table>`;
                if (pendingSubs.length > 0) {
                    applyTableStyles(pendingListDiv.querySelector('tbody'));
                    pendingListDiv.querySelectorAll('.admin-btn-xs').forEach(btn => btn.classList.add('text-white', 'font-bold', 'py-1', 'px-2', 'rounded', 'text-xs'));
                    pendingListDiv.querySelectorAll('.link').forEach(a => a.classList.add('text-blue-600', 'hover:underline'));
                    pendingListDiv.querySelectorAll('.points-input').forEach(input => input.classList.add('p-1', 'border', 'border-slate-300', 'rounded-md', 'text-center'));
                    pendingListDiv.querySelectorAll('.approve-btn').forEach(btn => btn.addEventListener('click', e => handleApproveSubmission(e.target.dataset.id, e.target.dataset.unitId, parseInt(e.target.closest('tr').querySelector('.points-input').value))));
                    pendingListDiv.querySelectorAll('.reject-btn').forEach(btn => btn.addEventListener('click', e => handleRejectSubmission(e.target.dataset.id)));
                }
            }

            const allSubsListDiv = document.getElementById('all-submissions-list');
            if (allSubsListDiv) {
                allSubsListDiv.innerHTML = currentSubmissions.length === 0 ? '<p class="text-slate-600 p-4">Nenhum envio.</p>' :
                    `<table class="admin-table"><thead class="bg-slate-200"><tr><th class="th-cell">Unidade</th><th class="th-cell">Atividade</th><th class="th-cell">Status</th><th class="th-cell">Pontos</th><th class="th-cell">Envio</th><th class="th-cell rounded-tr-lg">Valida√ß√£o</th></tr></thead><tbody>${currentSubmissions.map(s => `<tr><td>${s.unitName}</td><td>${s.activityName}</td><td><span class="status-badge ${s.status}">${s.status}</span></td><td class="font-bold">${s.pointsAwarded != null ? s.pointsAwarded : 'N/A'}</td><td>${s.submittedAt ? new Date(s.submittedAt.toDate()).toLocaleDateString('pt-BR') : 'N/A'}</td><td>${s.validatedAt ? new Date(s.validatedAt.toDate()).toLocaleDateString('pt-BR') : 'N/A'}</td></tr>`).join('')}</tbody></table>`;
                if (currentSubmissions.length > 0) applyTableStyles(allSubsListDiv.querySelector('tbody'));
            }
        }

        async function handleApproveSubmission(submissionId, unitId, points) {
            const sub = currentSubmissions.find(s => s.id === submissionId);
            if (!sub) { showMessage("Submiss√£o n√£o encontrada."); return; }
            const act = currentActivities.find(a => a.id === sub.activityId);
            const maxPts = act?.maxPoints || 0;
            if (isNaN(points) || points < 0 || points > maxPts) { showMessage(`Pontos inv√°lidos (0-${maxPts}).`); return; }
            showMessage(`Aprovar com ${points} pontos?`, async (confirmed) => {
                if (!confirmed) return;
                try {
                    const subDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'submissions', submissionId);
                    await updateDoc(subDocRef, { status: 'approved', pointsAwarded: points, validatedAt: serverTimestamp() });
                    const unitDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'units', unitId);
                    const unitSnap = await getDoc(unitDocRef);
                    if (unitSnap.exists()) await updateDoc(unitDocRef, { score: (unitSnap.data().score || 0) + points });
                    showMessage("Aprovado e pontuado!");
                } catch (err) { console.error("Erro aprovar:", err); showMessage("Erro ao aprovar."); }
            }, true);
        }

        async function handleRejectSubmission(submissionId) {
            showMessage("Rejeitar este envio?", async (confirmed) => {
                if (!confirmed) return;
                try {
                    const subDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'submissions', submissionId);
                    const subSnap = await getDoc(subDocRef);
                    if (subSnap.exists() && subSnap.data().status === 'approved' && subSnap.data().pointsAwarded > 0) {
                        const unitIdAdj = subSnap.data().unitId, ptsRev = subSnap.data().pointsAwarded;
                        const unitDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'units', unitIdAdj);
                        const unitSnap = await getDoc(unitDocRef);
                        if (unitSnap.exists()) await updateDoc(unitDocRef, { score: (unitSnap.data().score || 0) - ptsRev });
                    }
                    await updateDoc(subDocRef, { status: 'rejected', pointsAwarded: 0, validatedAt: serverTimestamp() });
                    showMessage("Envio rejeitado!");
                } catch (err) { console.error("Erro rejeitar:", err); showMessage("Erro ao rejeitar."); }
            }, true);
        }

        // Autentica√ß√£o e Inicializa√ß√£o
        function setupAuthFormListeners() {
            const authForm = document.getElementById('auth-form'), emailIn = document.getElementById('email'), passIn = document.getElementById('password'), loginBtn = document.getElementById('login-btn'), regBtn = document.getElementById('register-btn'), logoutBtn = document.getElementById('logout-btn');
            if (authForm && loginBtn && regBtn) {
                loginBtn.onclick = async (e) => {
                    e.preventDefault(); const email = emailIn.value, pass = passIn.value;
                    if (!email || !pass) { showMessage("Preencha email e palavra-passe."); return; }
                    try { await signInWithEmailAndPassword(auth, email, pass); }
                    catch (err) { console.error("Login erro:", err); showMessage(err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password' || err.code === 'auth/invalid-credential' ? "Email/passe incorretos." : "Erro ao iniciar sess√£o."); }
                };
                regBtn.onclick = async (e) => {
                    e.preventDefault(); const email = emailIn.value, pass = passIn.value;
                    if (!email || !pass) { showMessage("Preencha email e passe para registar."); return; }
                    if (pass.length < 6) { showMessage("Passe deve ter >= 6 caracteres."); return; }
                    try { await createUserWithEmailAndPassword(auth, email, pass); showMessage("Registo OK! A iniciar sess√£o..."); }
                    catch (err) { console.error("Registo erro:", err); showMessage(err.code === 'auth/email-already-in-use' ? "Email j√° registado." : err.code === 'auth/weak-password' ? "Passe fraca." : "Erro ao registar."); }
                };
            }
            if (logoutBtn) logoutBtn.onclick = async () => { try { await signOut(auth); showMessage("Sess√£o terminada!"); } catch (err) { console.error("Logout erro:", err); showMessage("Erro ao sair."); } };
        }

        let unsubscribers = [];
        function cleanupListeners() {
            unsubscribers.forEach(unsub => unsub());
            unsubscribers = [];
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const loadingOverlay = document.getElementById('loading-overlay');
            try {
                if (!firebaseConfig.apiKey || !firebaseConfig.projectId) throw new Error("Credenciais Firebase incompletas.");
                firebaseApp = initializeApp(firebaseConfig);
                db = getFirestore(firebaseApp);
                auth = getAuth(firebaseApp);
                if (loadingOverlay) loadingOverlay.classList.add('hidden');
                setupAuthFormListeners();

                onAuthStateChanged(auth, async (user) => {
                    const authSect = document.getElementById('auth-section'), mainContent = document.getElementById('main-app-content'), userP = document.getElementById('user-info'), logoutB = document.getElementById('logout-btn');
                    cleanupListeners(); // Limpa listeners antigos antes de reconfigurar
                    if (user) {
                        currentUser = user;
                        const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid);
                        const userDocSnap = await getDoc(userDocRef);
                        userRole = userDocSnap.exists() ? userDocSnap.data().role : 'leader';
                        if (!userDocSnap.exists()) await setDoc(userDocRef, { role: 'leader', uid: user.uid, email: user.email || '', createdAt: serverTimestamp() });

                        if (userP) userP.textContent = `Ol√°, ${userRole === 'secretary' ? 'Secret√°rio(a)' : 'L√≠der'} (${user.email || '?'})`;
                        if (logoutB) logoutB.classList.remove('hidden');
                        if (authSect) authSect.classList.add('hidden');
                        if (mainContent) mainContent.classList.remove('hidden');
                        initAppContent();
                    } else {
                        currentUser = null; userRole = null;
                        if (userP) userP.textContent = 'Carregando...';
                        if (logoutB) logoutB.classList.add('hidden');
                        if (authSect) authSect.classList.remove('hidden');
                        if (mainContent) mainContent.classList.add('hidden');
                    }
                });
            } catch (err) {
                console.error("Init Firebase erro:", err);
                showMessage(`Erro Firebase: ${err.message}. Verifique consola/config.`);
                if (loadingOverlay) loadingOverlay.classList.add('hidden');
            }
        });

        async function initAppContent() {
            const gestaoTabBtn = document.querySelector('button[data-tab="gestao"]');
            if (gestaoTabBtn) gestaoTabBtn.classList.toggle('hidden', !(userRole === 'leader' || userRole === 'secretary'));

            // Configura listeners onSnapshot e guarda as fun√ß√µes de unsubscribe
            unsubscribers.push(onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'units'), s => { currentUnits = s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (b.score || 0) - (a.score || 0)); renderDashboard(); if (isActiveTabSecretary()) updateUnitsTable(); if (isActiveTabLeader()) populateLeaderUnitSelect(); }));
            unsubscribers.push(onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'activities'), s => { currentActivities = s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => a.name.localeCompare(b.name)); if (isActiveTabSecretary()) updateActivitiesTable(); if (isActiveTabLeader()) populateLeaderActivitySelect(); }));
            unsubscribers.push(onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'submissions'), s => { currentSubmissions = s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (b.submittedAt?.toDate() || 0) - (a.submittedAt?.toDate() || 0)); renderDashboard(); if (isActiveTabSecretary()) updateSubmissionsTables(); if (isActiveTabLeader()) updateLeaderSubmissionsList(document.getElementById('unit-select-leader')?.value); }));
            unsubscribers.push(onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'demerits'), s => { currentDemerits = s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (b.appliedAt?.toDate() || 0) - (a.appliedAt?.toDate() || 0)); if (isActiveTabSecretary()) updateDemeritsTable(); }));

            renderCalendar(); renderAbout();

            const tabs = document.querySelectorAll('.tab-button');
            const contentSections = document.querySelectorAll('.content-section');

            function switchTab(targetTabId) {
                tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === targetTabId));
                contentSections.forEach(s => s.classList.toggle('active', s.id === targetTabId));
                if (targetTabId === 'inicio') renderDashboard();
                else if (targetTabId === 'gestao') {
                    if (userRole === 'secretary') renderSecretaryDashboard();
                    else if (userRole === 'leader') renderUnitLeaderDashboard();
                    else { showMessage("Sem permiss√£o."); switchTab('inicio'); }
                }
            }

            tabs.forEach(tab => {
                const newTab = tab.cloneNode(true); // Para limpar listeners antigos
                tab.parentNode.replaceChild(newTab, tab);
                newTab.addEventListener('click', () => switchTab(newTab.dataset.tab));
            });

            document.body.addEventListener('click', (event) => { // Delega√ß√£o de eventos para acorde√µes
                const button = event.target.closest('.accordion-button');
                if (button) {
                    const content = button.nextElementSibling, icon = button.querySelector('span:last-child');
                    if (!content || !icon) return;
                    button.classList.toggle('open'); icon.classList.toggle('rotate-180');
                    content.style.maxHeight = button.classList.contains('open') ? content.scrollHeight + 'px' : null;
                }
            });

            switchTab('inicio'); // Ativa a aba inicial
        }

        // Fun√ß√µes auxiliares para verificar abas ativas na gest√£o
        function isActiveTabSecretary() { return document.getElementById('gestao')?.classList.contains('active') && userRole === 'secretary'; }
        function isActiveTabLeader() { return document.getElementById('gestao')?.classList.contains('active') && userRole === 'leader'; }

        function populateLeaderUnitSelect() {
            const unitSL = document.getElementById('unit-select-leader');
            const noUnitsMsgL = document.getElementById('no-units-message-leader');
            if (unitSL) {
                unitSL.innerHTML = currentUnits.length > 0 ? '<option value="">Selecione sua unidade</option>' + currentUnits.map(u => `<option value="${u.id}">${u.name}</option>`).join('') : '<option value="">Nenhuma unidade cadastrada</option>';
                if (noUnitsMsgL) noUnitsMsgL.classList.toggle('hidden', currentUnits.length > 0);
            }
        }
        function populateLeaderActivitySelect() {
            const actSL = document.getElementById('activity-select-leader');
            const noActsMsgL = document.getElementById('no-activities-message-leader');
            if (actSL) {
                actSL.innerHTML = currentActivities.length > 0 ? '<option value="">Selecione uma atividade</option>' + currentActivities.map(a => `<option value="${a.id}">${a.name} (${a.type})</option>`).join('') : '<option value="">Nenhuma atividade cadastrada</option>';
                if (noActsMsgL) noActsMsgL.classList.toggle('hidden', currentActivities.length > 0);
            }
        }

    </script>
</body>

</html>