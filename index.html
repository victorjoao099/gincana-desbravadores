<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gincana de Unidades: A Aventura do Desbravador</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .tab-button.active {
            border-bottom-color: #2563eb;
            /* theme-blue-600 */
            color: #2563eb;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }

        .accordion-button.open+.accordion-content {
            max-height: 1000px;
            /* Adjust as needed for content length */
        }

        .chart-container {
            position: relative;
            height: 40vh;
            /* Responsive height */
            width: 100%;
            max-width: 800px;
            /* Max width to prevent excessive stretching */
            margin: auto;
            /* Center horizontally */
            max-height: 400px;
            /* Max height to prevent vertical overflow */
        }

        @media (max-width: 768px) {
            .chart-container {
                height: 60vh;
                /* Taller on mobile for better readability */
            }
        }

        .list-disc-custom li::marker {
            color: #2563eb;
            /* Custom bullet color */
        }

        .list-decimal-custom li::marker {
            color: #2563eb;
            /* Custom number color */
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay"
        class="fixed inset-0 bg-slate-100 bg-opacity-90 flex flex-col justify-center items-center z-50">
        <div class="animate-spin rounded-full h-20 w-20 border-t-2 border-b-2 border-blue-500"></div>
        <p class="mt-4 text-lg text-slate-700">A carregar aplica√ß√£o...</p>
    </div>

    <!-- Message Box -->
    <div id="messageBox" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 hidden">
        <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full text-center">
            <p id="messageText" class="text-lg font-semibold mb-4"></p>
            <div class="flex justify-center space-x-4">
                <button id="messageConfirmBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">OK</button>
                <button id="messageCancelBtn"
                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 hidden">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Authentication Section (visible by default, hidden by JS on auth) -->
    <section id="auth-section"
        class="flex items-center justify-center min-h-screen bg-gradient-to-br from-slate-100 to-blue-200 p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
            <h2 class="text-3xl font-bold text-blue-800 mb-6">Acesso √† Gincana</h2>
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="email" class="sr-only">Email</label>
                    <input type="email" id="email" placeholder="Email"
                        class="w-full p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                        required>
                </div>
                <div>
                    <label for="password" class="sr-only">Palavra-passe</label>
                    <input type="password" id="password" placeholder="Palavra-passe"
                        class="w-full p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                        required>
                </div>
                <button type="submit" id="login-btn"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">Iniciar
                    Sess√£o</button>
                <button type="button" id="register-btn"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">Registar</button>
            </form>
            <p class="text-sm text-slate-500 mt-4">
                Se esta √© a sua primeira vez, registe-se. Ap√≥s o registo, o seu papel (L√≠der ou Secret√°rio) ser√°
                definido no sistema.
            </p>
        </div>
    </section>

    <!-- Main Application Content (hidden until authenticated) -->
    <div id="main-app-content" class="container mx-auto p-4 md:p-8 hidden">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-blue-800">Gincana de Unidades</h1>
            <h2 class="text-2xl md:text-3xl font-semibold text-slate-600">A Aventura do Desbravador</h2>
            <p class="mt-4 text-slate-500 italic max-w-3xl mx-auto">"N√£o to mandei eu? S√™ forte e corajoso; n√£o temas,
                nem te espantes, porque o Senhor teu Deus √© contigo, por onde quer que andares." ‚Äì Josu√© 1:9</p>
            <p id="user-info" class="mt-2 text-sm text-slate-500">Carregando informa√ß√µes do utilizador...</p>
            <button id="logout-btn"
                class="mt-4 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">Sair</button>
        </header>

        <!-- Navigation Tabs -->
        <nav class="flex justify-center border-b-2 border-slate-200 mb-8 overflow-x-auto">
            <button data-tab="inicio"
                class="tab-button text-lg font-semibold p-4 border-b-4 border-transparent hover:text-blue-600 transition-colors duration-300 whitespace-nowrap">üèÅ
                In√≠cio</button>
            <button data-tab="calendario"
                class="tab-button text-lg font-semibold p-4 border-b-4 border-transparent hover:text-blue-600 transition-colors duration-300 whitespace-nowrap">üìÖ
                Calend√°rio</button>
            <button data-tab="regulamento"
                class="tab-button text-lg font-semibold p-4 border-b-4 border-transparent hover:text-blue-600 transition-colors duration-300 whitespace-nowrap">üìú
                Regulamento</button>
            <button data-tab="sobre"
                class="tab-button text-lg font-semibold p-4 border-b-4 border-transparent hover:text-blue-600 transition-colors duration-300 whitespace-nowrap">üõ°Ô∏è
                Sobre o Clube</button>
            <button data-tab="gestao"
                class="tab-button text-lg font-semibold p-4 border-b-4 border-transparent hover:text-blue-600 transition-colors duration-300 whitespace-nowrap">‚öôÔ∏è
                Gest√£o</button>
        </nav>

        <!-- Content Area -->
        <main>
            <!-- In√≠cio / Dashboard Section -->
            <section id="inicio" class="content-section">
                <p class="mb-6 text-slate-700 text-center">Bem-vindo ao painel da Gincana de Unidades! Aqui voc√™
                    encontra um resumo r√°pido do progresso e o placar geral das unidades. Explore as outras abas para
                    detalhes sobre o calend√°rio, regulamento e informa√ß√µes do clube.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 text-center">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-slate-500 font-semibold text-lg">Unidade em Destaque</h3>
                        <p id="unidade-destaque" class="text-3xl font-bold text-blue-600 mt-2">Carregando...</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-slate-500 font-semibold text-lg">Total de Pontos Acumulados</h3>
                        <p id="total-pontos" class="text-3xl font-bold text-blue-600 mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-slate-500 font-semibold text-lg">Atividades Conclu√≠das</h3>
                        <p id="atividades-realizadas" class="text-3xl font-bold text-blue-600 mt-2">0 / 0</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-2xl font-bold text-slate-700 mb-4 text-center">Placar Geral da Gincana</h3>
                    <div class="chart-container">
                        <canvas id="scoreChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- Calend√°rio Section -->
            <section id="calendario" class="content-section">
                <h2 class="text-3xl font-bold text-center mb-8 text-slate-700">Calend√°rio de Atividades</h2>
                <p class="mb-6 text-slate-700 text-center">Navegue pelas atividades di√°rias e semanais programadas para
                    cada m√™s. As atividades semanais ocorrem sempre aos domingos.</p>
                <div id="calendario-container" class="space-y-4">
                </div>
            </section>

            <!-- Regulamento Section -->
            <section id="regulamento" class="content-section">
                <h2 class="text-3xl font-bold text-center mb-8 text-slate-700">Regulamento Interno da Gincana</h2>
                <p class="mb-6 text-slate-700 text-center">Conhe√ßa as regras de pontua√ß√£o, crit√©rios de desempate,
                    conduta esperada e procedimentos para recursos, garantindo uma gincana justa e organizada.</p>
                <div class="space-y-4">
                    <div class="bg-white rounded-xl shadow-md">
                        <button
                            class="accordion-button w-full text-left p-6 font-bold text-xl text-blue-800 flex justify-between items-center">
                            <span>1. Sistema de Pontua√ß√£o</span>
                            <span class="transform transition-transform duration-300">‚ñº</span>
                        </button>
                        <div id="pontuacao-content" class="accordion-content px-6 pb-6 text-slate-600 space-y-4">
                            <h4 class="font-bold text-lg text-slate-700">Pontua√ß√£o Base por Atividade:</h4>
                            <ul class="list-disc list-inside list-disc-custom space-y-1">
                                <li><strong>Atividades Di√°rias:</strong> 5 pontos por Desbravador presente e ativo na
                                    atividade. 5-10 pontos extras por Desbravador que concluir ou acertar o desafio.
                                </li>
                                <li><strong>Atividades Semanais:</strong> 20 pontos por unidade que participar
                                    integralmente. 30-100 pontos por desempenho/conclus√£o. 10-50 pontos extras por
                                    qualidade/criatividade.</li>
                            </ul>
                            <h4 class="font-bold text-lg text-slate-700 mt-4">B√¥nus Especiais:</h4>
                            <ul class="list-disc list-inside list-disc-custom space-y-1">
                                <li><strong>"Esp√≠rito Desbravador" (Semanal):</strong> 50 pontos.</li>
                                <li><strong>"Unidade Nota 10" (Mensal):</strong> 100 pontos.</li>
                                <li><strong>"Uniforme Impec√°vel" (Semanal):</strong> 20 pontos.</li>
                                <li><strong>"Desafio Surpresa":</strong> Pontos vari√°veis.</li>
                            </ul>
                            <h4 class="font-bold text-lg text-slate-700 mt-4">Penalidades:</h4>
                            <ul class="list-disc list-inside list-disc-custom space-y-1">
                                <li><strong>Atraso na Entrega:</strong> -10 pontos por dia.</li>
                                <li><strong>Comportamento Antidesbravador:</strong> -20 a -50 pontos.</li>
                                <li><strong>Falta em Atividades Obrigat√≥rias:</strong> -10 pontos por membro.</li>
                            </ul>
                            <h4 class="font-bold text-lg text-slate-700 mt-4">Placar e Acompanhamento:</h4>
                            <p>Um Placar Geral vis√≠vel e atualizado semanalmente (online ou f√≠sico) com a pontua√ß√£o de
                                cada unidade. Um "Painel de Conquistas" registrar√° visualmente os progressos.</p>
                            <h4 class="font-bold text-lg text-slate-700 mt-4">Submiss√£o e Valida√ß√£o de Requisitos:</h4>
                            <p>Os l√≠deres de unidade registrar√£o a conclus√£o dos requisitos no "Cantinho da Unidade" (<a
                                    href="https://clubes.adventistas.org/br/unit-control/" target="_blank"
                                    class="text-blue-600 hover:underline">https://clubes.adventistas.org/br/unit-control/</a>).
                                A secret√°ria do clube validar√° os requisitos e atribuir√° a pontua√ß√£o via SGC (<a
                                    href="https://sg.sdasystems.org/cms/login.php?lang=pt_br" target="_blank"
                                    class="text-blue-600 hover:underline">https://sg.sdasystems.org/cms/login.php?lang=pt_br</a>).
                                Um PDF com o placar de pontos atualizado ser√° divulgado semanalmente.</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md">
                        <button
                            class="accordion-button w-full text-left p-6 font-bold text-xl text-blue-800 flex justify-between items-center">
                            <span>2. Crit√©rios de Desempate</span>
                            <span class="transform transition-transform duration-300">‚ñº</span>
                        </button>
                        <div id="desempate-content" class="accordion-content px-6 pb-6 text-slate-600 space-y-4">
                            <p>Em caso de empate na pontua√ß√£o final ou em qualquer etapa decisiva, os seguintes
                                crit√©rios ser√£o aplicados sequencialmente:</p>
                            <ol class="list-decimal list-inside list-decimal-custom space-y-1">
                                <li>Maior n√∫mero de B√¥nus "Esp√≠rito Desbravador" acumulados.</li>
                                <li>Maior n√∫mero de Atividades Semanais conclu√≠das com pontua√ß√£o m√°xima.</li>
                                <li>Menor n√∫mero de Penalidades registradas.</li>
                                <li>Sorteio: Em caso de persist√™ncia do empate, ser√° realizado um sorteio justo e
                                    transparente.</li>
                            </ol>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md">
                        <button
                            class="accordion-button w-full text-left p-6 font-bold text-xl text-blue-800 flex justify-between items-center">
                            <span>3. Conduta Esperada</span>
                            <span class="transform transition-transform duration-300">‚ñº</span>
                        </button>
                        <div id="conduta-content" class="accordion-content px-6 pb-6 text-slate-600 space-y-4">
                            <p>Todos os Desbravadores e l√≠deres devem aderir aos princ√≠pios de conduta do Clube:</p>
                            <ul class="list-disc list-inside list-disc-custom space-y-1">
                                <li><strong>Respeito:</strong> Tratar todos com respeito, cortesia e empatia.</li>
                                <li><strong>Coopera√ß√£o:</strong> Trabalhar em equipe, auxiliando os colegas e a unidade.
                                </li>
                                <li><strong>Disciplina:</strong> Seguir as instru√ß√µes dos l√≠deres e as regras do clube.
                                </li>
                                <li><strong>Integridade:</strong> Ser honesto em todas as atividades e submiss√µes.</li>
                                <li><strong>Esp√≠rito Esportivo:</strong> Aceitar vit√≥rias e derrotas com humildade e
                                    dignidade.</li>
                                <li><strong>Seguran√ßa:</strong> Priorizar a seguran√ßa pr√≥pria e alheia em todas as
                                    atividades.</li>
                            </ul>
                            <p class="mt-2">Comportamentos que contrariem os ideais do Desbravador ou que prejudiquem o
                                ambiente da gincana ser√£o pass√≠veis de penalidades.</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md">
                        <button
                            class="accordion-button w-full text-left p-6 font-bold text-xl text-blue-800 flex justify-between items-center">
                            <span>4. Procedimentos para Recursos (Apela√ß√µes)</span>
                            <span class="transform transition-transform duration-300">‚ñº</span>
                        </button>
                        <div id="recursos-content" class="accordion-content px-6 pb-6 text-slate-600 space-y-4">
                            <p>Caso uma unidade ou l√≠der discorde da pontua√ß√£o atribu√≠da ou de uma penalidade, poder√°
                                apresentar um recurso:</p>
                            <ol class="list-decimal list-inside list-decimal-custom space-y-1">
                                <li><strong>Comunica√ß√£o Inicial:</strong> O l√≠der da unidade deve comunicar formalmente
                                    a secret√°ria do clube, por escrito (e-mail ou mensagem oficial), no prazo m√°ximo de
                                    24 horas ap√≥s a divulga√ß√£o da pontua√ß√£o contestada.</li>
                                <li><strong>An√°lise Preliminar:</strong> A secret√°ria e o diretor associado respons√°vel
                                    pela gincana analisar√£o o recurso e as evid√™ncias.</li>
                                <li><strong>Decis√£o:</strong> A decis√£o ser√° comunicada ao l√≠der da unidade em at√© 48
                                    horas. A decis√£o da diretoria √© final e irrevog√°vel.</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </section>

            <section id="sobre" class="content-section">
                <h2 class="text-3xl font-bold text-center mb-8 text-slate-700">Sobre o Clube de Desbravadores</h2>
                <p class="mb-6 text-slate-700 text-center">Conhe√ßa os fundamentos, a hist√≥ria e a estrutura que guiam o
                    Clube de Desbravadores, um movimento mundial dedicado ao desenvolvimento integral de juvenis e
                    adolescentes.</p>
                <div class="space-y-4">
                    <div class="bg-white rounded-xl shadow-md">
                        <button
                            class="accordion-button w-full text-left p-6 font-bold text-xl text-blue-800 flex justify-between items-center">
                            <span>As Bases do Clube</span>
                            <span class="transform transition-transform duration-300">‚ñº</span>
                        </button>
                        <div id="bases-content" class="accordion-content px-6 pb-6 text-slate-600 space-y-4">
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md">
                        <button
                            class="accordion-button w-full text-left p-6 font-bold text-xl text-blue-800 flex justify-between items-center">
                            <span>Estrutura e Fun√ß√µes</span>
                            <span class="transform transition-transform duration-300">‚ñº</span>
                        </button>
                        <div id="funcoes-content" class="accordion-content px-6 pb-6 text-slate-600 space-y-4">
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Firebase SDKs e l√≥gica principal da aplica√ß√£o (como um m√≥dulo) -->
    <script type="module">
        console.log("Script de m√≥dulo a ser executado...");

        // Importa√ß√µes do Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        // Vari√°veis de estado do Firebase e da aplica√ß√£o (dentro do escopo do m√≥dulo)
        let firebaseApp = null;
        let db = null;
        let auth = null;
        let currentUser = null;
        let userRole = null;

        // =====================================================================================================
        // === ATEN√á√ÉO: CONFIGURA√á√ÉO DO FIREBASE  ===
        // =====================================================================================================

        const appId = 'gincana-de-unidade';

        const firebaseConfig = {
            apiKey: "AIzaSyBJI_Hrp1I5GJHt82UKo5xjr392Z4XTMS8",
            authDomain: "gincana-de-unidade.firebaseapp.com",
            projectId: "gincana-de-unidade",
            storageBucket: "gincana-de-unidade.firebasestorage.app",
            messagingSenderId: "497226153394",
            appId: "1:497226153394:web:35d484f3737e3a3b4938ab"
        };

        // initialAuthToken n√£o √© mais usado com autentica√ß√£o por e-mail/senha
        const initialAuthToken = null;
        // =====================================================================================================
        // === FIM DA CONFIGURA√á√ÉO DO FIREBASE ===
        // =====================================================================================================

        // Apenas para depura√ß√£o: Verifique o que est√° sendo lido na configura√ß√£o
        console.log("firebaseConfig lido:", firebaseConfig);
        console.log("appId lido:", appId);
        console.log("authDomain lido:", firebaseConfig.authDomain);


        // MessageBox function
        const showMessage = (msg, callback, showCancel = false) => {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const confirmBtn = document.getElementById('messageConfirmBtn');
            const cancelBtn = document.getElementById('messageCancelBtn');

            // Verifica se os elementos da caixa de mensagem existem antes de manipul√°-los
            if (!messageBox || !messageText || !confirmBtn || !cancelBtn) {
                console.error("Erro: Elementos da caixa de mensagem n√£o encontrados. N√£o √© poss√≠vel exibir a mensagem.");
                alert(msg); // Fallback para alert se a caixa de mensagem n√£o estiver pronta
                if (callback) callback(true); // Tenta chamar o callback mesmo no fallback
                return;
            }

            messageText.textContent = msg;
            messageBox.classList.remove('hidden');

            confirmBtn.onclick = () => {
                messageBox.classList.add('hidden');
                if (callback) callback(true);
            };

            if (showCancel) {
                cancelBtn.classList.remove('hidden');
                cancelBtn.onclick = () => {
                    messageBox.classList.add('hidden');
                    if (callback) callback(false);
                };
            } else {
                cancelBtn.classList.add('hidden');
            }
        };

        // Vari√°veis de estado da aplica√ß√£o (dados din√¢micos do Firestore)
        let chartInstance = null;
        let currentUnits = [];
        let currentActivities = [];
        let currentSubmissions = [];
        let currentDemerits = []; // Nova vari√°vel para dem√©ritos

        // Fun√ß√µes de opera√ß√£o de dados do Firebase (agora dentro do escopo do m√≥dulo)
        async function getUnits() {
            const unitsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'units');
            const q = query(unitsColRef);
            return new Promise((resolve, reject) => {
                onSnapshot(q, (snapshot) => {
                    currentUnits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    currentUnits.sort((a, b) => (b.score || 0) - (a.score || 0)); // Ordenar por pontua√ß√£o descendente
                    resolve(currentUnits);
                }, reject);
            });
        }

        async function getActivities() {
            const activitiesColRef = collection(db, 'artifacts', appId, 'public', 'data', 'activities');
            const q = query(activitiesColRef);
            return new Promise((resolve, reject) => {
                onSnapshot(q, (snapshot) => {
                    currentActivities = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    resolve(currentActivities);
                }, reject);
            });
        }

        async function getSubmissions() {
            const submissionsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'submissions');
            const q = query(submissionsColRef);
            return new Promise((resolve, reject) => {
                onSnapshot(q, (snapshot) => {
                    currentSubmissions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    currentSubmissions.sort((a, b) => b.submittedAt?.toDate() - a.submittedAt?.toDate()); // Ordenar por mais recente
                    resolve(currentSubmissions);
                }, reject);
            });
        }

        // Nova fun√ß√£o para obter dem√©ritos
        async function getDemerits() {
            const demeritsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'demerits');
            const q = query(demeritsColRef);
            return new Promise((resolve, reject) => {
                onSnapshot(q, (snapshot) => {
                    currentDemerits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    currentDemerits.sort((a, b) => b.appliedAt?.toDate() - a.appliedAt?.toDate()); // Ordenar por mais recente
                    resolve(currentDemerits);
                }, reject);
            });
        }


        function wrapLabel(label, maxLen) {
            if (label.length <= maxLen) return label;
            let wrappedLabel = '';
            let words = label.split(' ');
            let currentLine = '';
            for (let i = 0; i < words.length; i++) {
                let word = words[i];
                if ((currentLine + word).length <= maxLen) {
                    currentLine += (currentLine === '' ? '' : ' ') + word;
                } else {
                    wrappedLabel += currentLine + '\n';
                    currentLine = word;
                }
            }
            wrappedLabel += currentLine;
            return wrappedLabel;
        }

        function renderDashboard() {
            const totalScore = currentUnits.reduce((sum, item) => sum + (item.score || 0), 0);
            const totalActivitiesDefined = Object.values(staticData.calendar).flat().length;
            const approvedSubmissionsCount = currentSubmissions.filter(sub => sub.status === 'approved').length;

            document.getElementById('unidade-destaque').textContent = currentUnits.length > 0 ? currentUnits[0].name : 'N/A';
            document.getElementById('total-pontos').textContent = totalScore;
            document.getElementById('atividades-realizadas').textContent = `${approvedSubmissionsCount} / ${totalActivitiesDefined}`;

            renderScoreChart(currentUnits);
        }

        function renderScoreChart(unitsData) {
            const ctx = document.getElementById('scoreChart').getContext('2d');
            if (chartInstance) {
                chartInstance.destroy();
            }
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: unitsData.map(item => wrapLabel(item.name, 16)),
                    datasets: [{
                        label: 'Pontua√ß√£o da Unidade',
                        data: unitsData.map(item => item.score || 0),
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1,
                        borderRadius: 5,
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `${context.dataset.label}: ${context.raw} pontos`;
                                }
                            }
                        },
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                display: true,
                                color: 'rgba(203, 213, 225, 0.5)'
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                callback: function (value, index, ticks) {
                                    return wrapLabel(this.getLabelForValue(value), 16);
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderCalendar() {
            const container = document.getElementById('calendario-container');
            container.innerHTML = '';
            Object.entries(staticData.calendar).forEach(([month, activities]) => {
                const monthDiv = document.createElement('div');
                monthDiv.className = 'bg-white rounded-xl shadow-md';

                const button = document.createElement('button');
                button.className = 'accordion-button w-full text-left p-6 font-bold text-xl text-blue-800 flex justify-between items-center';
                button.innerHTML = `<span>${month}</span><span class="transform transition-transform duration-300">‚ñº</span>`;

                const contentDiv = document.createElement('div');
                contentDiv.className = 'accordion-content px-6 pb-6 text-slate-600 space-y-4';

                activities.forEach(activity => {
                    contentDiv.innerHTML += `
                        <div class="pt-4 border-t first:border-t-0 border-slate-200">
                            <p class="font-semibold text-slate-700">${activity.date} - ${activity.title}</p>
                            <p class="text-sm">${activity.desc}</p>
                        </div>
                    `;
                });

                monthDiv.appendChild(button);
                monthDiv.appendChild(contentDiv);
                container.appendChild(monthDiv);
            });
        }

        function renderAbout() {
            const basesContainer = document.getElementById('bases-content');
            basesContainer.innerHTML = staticData.bases.map(item => `<div class="pt-4 border-t first:border-t-0 border-slate-200"><h4 class="font-bold text-lg text-slate-700">${item.title}</h4><p>${item.content}</p></div>`).join('');

            const funcoesContainer = document.getElementById('funcoes-content');
            funcoesContainer.innerHTML = '';
            Object.entries(staticData.funcoes).forEach(([category, roles]) => {
                let categoryHtml = `<h4 class="font-bold text-lg text-slate-700 pt-4 border-t first:border-t-0 border-slate-200">${category}</h4><ul class="list-disc list-inside list-disc-custom space-y-2">`;
                roles.forEach(role => {
                    categoryHtml += `<li><strong>${role.title}:</strong> ${role.content}</li>`;
                });
                categoryHtml += `</ul>`;
                funcoesContainer.innerHTML += categoryHtml;
            });
        }

        function renderUnitLeaderDashboard() {
            document.getElementById('gestao-title').textContent = 'Dashboard do L√≠der de Unidade';
            const gestaoContent = document.getElementById('gestao-content');
            gestaoContent.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h3 class="text-xl font-semibold text-blue-600 mb-4">Enviar Atividade Conclu√≠da</h3>
                    <form id="submit-activity-form" class="space-y-4 mb-8">
                        <div>
                            <label for="unit-select-leader" class="block text-sm font-medium text-slate-700">Sua Unidade:</label>
                            <select id="unit-select-leader" class="mt-1 block w-full p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="">Selecione sua unidade</option>
                            </select>
                            <p id="no-units-message" class="text-red-500 text-sm mt-2 hidden">Nenhuma unidade encontrada. Pe√ßa ao secret√°rio para cadastrar as unidades.</p>
                        </div>
                        <div>
                            <label for="activity-select-leader" class="block text-sm font-medium text-slate-700">Atividade:</label>
                            <select id="activity-select-leader" class="mt-1 block w-full p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="">Selecione uma atividade</option>
                            </option>
                        </div>
                        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">Enviar para Valida√ß√£o</button>
                    </form>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-semibold text-blue-600 mb-4">Meus Envios Recentes</h3>
                    <div id="leader-submissions-list">
                        <p class="text-slate-600">Nenhum envio feito ainda para esta unidade.</p>
                    </div>
                </div>
            `;

            const unitSelectLeader = document.getElementById('unit-select-leader');
            const activitySelectLeader = document.getElementById('activity-select-leader');
            const noUnitsMessage = document.getElementById('no-units-message');
            const noActivitiesMessage = document.getElementById('no-activities-message');

            if (currentUnits.length > 0) {
                unitSelectLeader.innerHTML = currentUnits.map(unit => `<option value="${unit.id}">${unit.name}</option>`).join('');
                unitSelectLeader.value = currentUnits[0].id; // Select first unit by default
                noUnitsMessage.classList.add('hidden');
            } else {
                noUnitsMessage.classList.remove('hidden');
            }

            if (currentActivities.length > 0) {
                activitySelectLeader.innerHTML = '<option value="">Selecione uma atividade</option>' + currentActivities.map(activity => `<option value="${activity.id}">${activity.name} (${activity.type})</option>`).join('');
                noActivitiesMessage.classList.add('hidden');
            } else {
                noActivitiesMessage.classList.remove('hidden');
            }

            document.getElementById('submit-activity-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const selectedUnitId = unitSelectLeader.value;
                const activityId = activitySelectLeader.value;
                const details = document.getElementById('details-leader').value;
                const photoUrl = document.getElementById('photo-url-leader').value;

                if (!selectedUnitId || !activityId || !details.trim()) {
                    showMessage("Por favor, preencha todos os campos obrigat√≥rios (Unidade, Atividade e Detalhes).");
                    return;
                }

                const activity = currentActivities.find(act => act.id === activityId);
                if (!activity) {
                    showMessage("Atividade selecionada inv√°lida.");
                    return;
                }

                try {
                    const submissionsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'submissions');
                    await addDoc(submissionsColRef, {
                        unitId: selectedUnitId,
                        unitName: currentUnits.find(u => u.id === selectedUnitId)?.name || 'Unidade Desconhecida',
                        activityId: activityId,
                        activityName: activity.name,
                        details: details,
                        photoUrl: photoUrl,
                        status: 'pending',
                        submittedBy: currentUser.uid,
                        submittedAt: serverTimestamp(),
                    });
                    showMessage("Atividade enviada para valida√ß√£o com sucesso!");
                    document.getElementById('submit-activity-form').reset();
                } catch (error) {
                    console.error("Erro ao enviar atividade:", error);
                    showMessage("Erro ao enviar atividade. Tente novamente.");
                }
            });

            function updateLeaderSubmissionsList(selectedUnitId) {
                const leaderSubmissionsList = document.getElementById('leader-submissions-list');
                const unitSubmissions = currentSubmissions.filter(sub => sub.unitId === selectedUnitId);

                if (unitSubmissions.length === 0) {
                    leaderSubmissionsList.innerHTML = '<p class="text-slate-600">Nenhum envio feito ainda para esta unidade.</p>';
                    return;
                }

                let tableHtml = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead class="bg-blue-100">
                                <tr>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700 rounded-tl-lg">Atividade</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Detalhes</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Status</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Pontos</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Data</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                unitSubmissions.forEach(sub => {
                    const statusClass = sub.status === 'pending' ? 'pending' : (sub.status === 'approved' ? 'approved' : 'rejected');
                    tableHtml += `
                        <tr class="border-b border-slate-200 last:border-b-0 hover:bg-slate-50">
                            <td class="py-3 px-4 text-sm">${sub.activityName}</td>
                            <td class="py-3 px-4 text-sm max-w-xs truncate">${sub.details}</td>
                            <td class="py-3 px-4 text-sm">
                                <span class="px-2 py-1 rounded-full text-xs font-semibold status-badge ${statusClass}">
                                    ${sub.status === 'pending' ? 'Pendente' : (sub.status === 'approved' ? 'Aprovado' : 'Rejeitado')}
                                </span>
                            </td>
                            <td class="py-3 px-4 text-sm font-bold">${sub.pointsAwarded || 'N/A'}</td>
                            <td class="py-3 px-4 text-sm">
                                ${sub.submittedAt ? new Date(sub.submittedAt.toDate()).toLocaleDateString('pt-BR') : 'N/A'}
                            </td>
                        </tr>
                    `;
                });
                tableHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
                leaderSubmissionsList.innerHTML = tableHtml;
            }

            unitSelectLeader.addEventListener('change', (e) => {
                updateLeaderSubmissionsList(e.target.value);
            });

            if (unitSelectLeader.value) {
                updateLeaderSubmissionsList(unitSelectLeader.value);
            }
        }

        function renderSecretaryDashboard() {
            document.getElementById('gestao-title').textContent = 'Dashboard do Secret√°rio do Clube';
            const gestaoContent = document.getElementById('gestao-content');
            gestaoContent.innerHTML = `
                <section class="mb-8 p-4 bg-blue-50 rounded-xl shadow-inner">
                    <h3 class="text-xl font-semibold text-blue-600 mb-4">Gerenciar Unidades</h3>
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <input type="text" id="new-unit-name" placeholder="Nome da nova unidade" class="flex-grow p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <button id="add-unit-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">Adicionar Unidade</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead class="bg-blue-100">
                                <tr>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700 rounded-tl-lg">Unidade</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Pontua√ß√£o</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700 rounded-tr-lg">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="units-table-body">
                                <tr><td colspan="3" class="py-4 px-4 text-center text-slate-600">Nenhuma unidade cadastrada.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <section class="mb-8 p-4 bg-green-50 rounded-xl shadow-inner">
                    <h3 class="text-xl font-semibold text-green-600 mb-4">Gerenciar Atividades</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <input type="text" id="new-activity-name" placeholder="Nome da atividade" class="p-3 border border-slate-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                        <select id="new-activity-type" class="p-3 border border-slate-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                            <option value="">Tipo (F√≠sico, Mental, Espiritual, etc.)</option>
                            <option value="F√≠sico">F√≠sico</option>
                            <option value="Mental">Mental</option>
                            <option value="Espiritual">Espiritual</option>
                            <option value="Social">Social</option>
                            <option value="Pioneirismo">Pioneirismo</option>
                            <option value="Natureza">Natureza</option>
                            <option value="Servi√ßo">Servi√ßo Comunit√°rio</option>
                            <option value="Culin√°ria">Culin√°ria</option>
                            <option value="Geral">Geral</option>
                        </select>
                        <input type="number" id="new-activity-max-points" placeholder="Pontua√ß√£o M√°xima" class="p-3 border border-slate-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                    </div>
                    <button id="add-activity-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">Adicionar Atividade</button>
                    <div class="overflow-x-auto mt-6">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead class="bg-green-100">
                                <tr>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700 rounded-tl-lg">Atividade</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Tipo</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Pontos M√°x.</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700 rounded-tr-lg">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="activities-table-body">
                                <tr><td colspan="4" class="py-4 px-4 text-center text-slate-600">Nenhuma atividade cadastrada.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <section class="mb-8 p-4 bg-red-50 rounded-xl shadow-inner">
                    <h3 class="text-xl font-semibold text-red-700 mb-4">Gerenciar Dem√©ritos</h3>
                    <div class="space-y-4 mb-4">
                        <div>
                            <label for="demerit-unit-select" class="block text-sm font-medium text-slate-700">Unidade:</label>
                            <select id="demerit-unit-select" class="mt-1 block w-full p-3 border border-slate-300 rounded-lg focus:ring-red-500 focus:border-red-500" required>
                                <option value="">Selecione a unidade</option>
                            </option>
                        </div>
                        <button id="apply-demerit-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">Aplicar Dem√©rito</button>
                    </div>
                    <div class="overflow-x-auto mt-6">
                        <table class="min-w-full bg-white rounded-lg shadow-md">
                            <thead class="bg-red-100">
                                <tr>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Unidade</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Pontos</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Raz√£o</th>
                                    <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Data</th>
                                </tr>
                            </thead>
                            <tbody id="demerits-table-body">
                                <tr><td colspan="4" class="py-4 px-4 text-center text-slate-600">Nenhum dem√©rito registrado.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <section class="mb-8 p-4 bg-yellow-50 rounded-xl shadow-inner">
                    <h3 class="text-xl font-semibold text-yellow-800 mb-4">Envios Pendentes para Valida√ß√£o (<span id="pending-submissions-count">0</span>)</h3>
                    <div id="pending-submissions-list">
                        <p class="text-slate-600">Nenhum envio pendente no momento.</p>
                    </div>
                </section>

                <section class="mb-8 p-4 bg-slate-50 rounded-xl shadow-inner">
                    <h3 class="text-xl font-semibold text-slate-700 mb-4">Hist√≥rico de Todos os Envios</h3>
                    <div id="all-submissions-list">
                        <p class="text-slate-600">Nenhum envio registrado ainda.</p>
                    </div>
                </section>
            `;

            // Demerit Management
            const demeritUnitSelect = document.getElementById('demerit-unit-select');
            const demeritPointsInput = document.getElementById('demerit-points');
            const demeritReasonTextarea = document.getElementById('demerit-reason');
            const applyDemeritBtn = document.getElementById('apply-demerit-btn');

            // Populate demerit unit select
            if (currentUnits.length > 0) {
                demeritUnitSelect.innerHTML = '<option value="">Selecione a unidade</option>' + currentUnits.map(unit => `<option value="${unit.id}">${unit.name}</option>`).join('');
            } else {
                demeritUnitSelect.innerHTML = '<option value="">Nenhuma unidade cadastrada.</option>';
            }

            applyDemeritBtn.addEventListener('click', async () => {
                const unitId = demeritUnitSelect.value;
                const points = parseInt(demeritPointsInput.value);
                const reason = demeritReasonTextarea.value.trim();

                if (!unitId || isNaN(points) || points <= 0 || !reason) {
                    showMessage("Por favor, preencha todos os campos do dem√©rito corretamente (Unidade, Pontos > 0, Raz√£o).");
                    return;
                }

                showMessage(`Confirmar aplica√ß√£o de ${points} dem√©ritos √† unidade "${currentUnits.find(u => u.id === unitId)?.name}" por "${reason}"?`, async (confirmed) => {
                    if (confirmed) {
                        try {
                            // 1. Adicionar o dem√©rito na cole√ß√£o 'demerits'
                            const demeritsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'demerits');
                            await addDoc(demeritsColRef, {
                                unitId: unitId,
                                unitName: currentUnits.find(u => u.id === unitId)?.name || 'Unidade Desconhecida',
                                points: points, // Armazenar como positivo e subtrair ao aplicar
                                reason: reason,
                                appliedBy: currentUser.uid,
                                appliedAt: serverTimestamp(),
                            });

                            // 2. Atualizar a pontua√ß√£o da unidade na cole√ß√£o 'units'
                            const unitDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'units', unitId);
                            const unitSnap = await getDoc(unitDocRef);
                            if (unitSnap.exists()) {
                                const currentScore = unitSnap.data().score || 0;
                                await updateDoc(unitDocRef, {
                                    score: currentScore - points, // Subtrair os pontos do dem√©rito
                                });
                            }
                            showMessage(`Dem√©rito de ${points} pontos aplicado √† unidade!`);
                            demeritUnitSelect.value = '';
                            demeritPointsInput.value = '';
                            demeritReasonTextarea.value = '';
                        } catch (error) {
                            console.error("Erro ao aplicar dem√©rito:", error);
                            showMessage("Erro ao aplicar dem√©rito. Tente novamente.");
                        }
                    }
                }, true);
            });

            // Real-time update for Demerits table
            const unsubscribeDemerits = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'demerits'), (snapshot) => {
                currentDemerits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                currentDemerits.sort((a, b) => b.appliedAt?.toDate() - a.appliedAt?.toDate());
                updateDemeritsTable();
            }, (error) => console.error("Erro ao carregar dem√©ritos:", error));

            function updateDemeritsTable() {
                const tbody = document.getElementById('demerits-table-body');
                if (!tbody) return;
                if (currentDemerits.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="py-4 px-4 text-center text-slate-600">Nenhum dem√©rito registrado.</td></tr>';
                } else {
                    tbody.innerHTML = currentDemerits.map(demerit => `
                        <tr class="border-b border-slate-200 last:border-b-0 hover:bg-slate-50">
                            <td class="py-3 px-4 text-sm">${demerit.unitName}</td>
                            <td class="py-3 px-4 text-sm font-bold text-red-600">-${demerit.points}</td>
                            <td class="py-3 px-4 text-sm max-w-xs truncate">${demerit.reason}</td>
                            <td class="py-3 px-4 text-sm">
                                ${demerit.appliedAt ? new Date(demerit.appliedAt.toDate()).toLocaleDateString('pt-BR') : 'N/A'}
                            </td>
                        </tr>
                    `).join('');
                }
            }

            // Resto da l√≥gica do Secretary Dashboard (j√° existente)
            // Unit Management
            document.getElementById('add-unit-btn').addEventListener('click', async () => {
                const newUnitName = document.getElementById('new-unit-name').value.trim();
                if (!newUnitName) {
                    showMessage("O nome da unidade n√£o pode ser vazio.");
                    return;
                }
                try {
                    const unitsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'units');
                    await addDoc(unitsColRef, { name: newUnitName, score: 0, createdAt: serverTimestamp() });
                    showMessage(`Unidade "${newUnitName}" adicionada com sucesso!`);
                    document.getElementById('new-unit-name').value = '';
                } catch (error) {
                    console.error("Erro ao adicionar unidade:", error);
                    showMessage("Erro ao adicionar unidade. Tente novamente.");
                }
            });

            const unsubscribeUnits = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'units'), (snapshot) => {
                currentUnits = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                currentUnits.sort((a, b) => (b.score || 0) - (a.score || 0));
                updateUnitsTable();
                renderDashboard();
                // Atualizar select de unidades no gerenciamento de dem√©ritos
                if (demeritUnitSelect) { // Verifica se o elemento existe antes de manipular
                    demeritUnitSelect.innerHTML = '<option value="">Selecione a unidade</option>' + currentUnits.map(unit => `<option value="${unit.id}">${unit.name}</option>`).join('');
                }
            }, (error) => console.error("Erro ao carregar unidades (Secret√°rio):", error));


            function updateUnitsTable() {
                const tbody = document.getElementById('units-table-body');
                if (!tbody) return;
                if (currentUnits.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="py-4 px-4 text-center text-slate-600">Nenhuma unidade cadastrada.</td></tr>';
                } else {
                    tbody.innerHTML = currentUnits.map(unit => `
                        <tr class="border-b border-slate-200 last:border-b-0 hover:bg-slate-50">
                            <td class="py-3 px-4 text-sm">${unit.name}</td>
                            <td class="py-3 px-4 text-sm font-bold">${unit.score || 0}</td>
                            <td class="py-3 px-4 text-sm">
                                <button data-id="${unit.id}" data-name="${unit.name}" class="delete-unit-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-xs transition duration-300 ease-in-out transform hover:scale-105">Excluir</button>
                            </td>
                        </tr>
                    `).join('');
                    tbody.querySelectorAll('.delete-unit-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => handleDeleteUnit(e.target.dataset.id, e.target.dataset.name));
                    });
                }
            }

            async function handleDeleteUnit(unitId, unitName) {
                showMessage(`Tem certeza que deseja excluir a unidade "${unitName}"? Isso remover√° todos os seus dados.`, async (confirmed) => {
                    if (confirmed) {
                        try {
                            const unitDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'units', unitId);
                            await deleteDoc(unitDocRef);
                            showMessage(`Unidade "${unitName}" exclu√≠da com sucesso!`);
                        } catch (error) {
                            console.error("Erro ao excluir unidade:", error);
                            showMessage("Erro ao excluir unidade. Tente novamente.");
                        }
                    }
                }, true);
            }

            // Activity Management
            document.getElementById('add-activity-btn').addEventListener('click', async () => {
                const name = document.getElementById('new-activity-name').value.trim();
                const type = document.getElementById('new-activity-type').value;
                const maxPoints = parseInt(document.getElementById('new-activity-max-points').value);

                if (!name || !type || isNaN(maxPoints) || maxPoints < 0) {
                    showMessage("Por favor, preencha todos os campos da atividade corretamente.");
                    return;
                }
                try {
                    const activitiesColRef = collection(db, 'artifacts', appId, 'public', 'data', 'activities');
                    await addDoc(activitiesColRef, { name, type, maxPoints, createdAt: serverTimestamp() });
                    showMessage(`Atividade "${name}" adicionada com sucesso!`);
                    document.getElementById('new-activity-name').value = '';
                    document.getElementById('new-activity-type').value = '';
                    document.getElementById('new-activity-max-points').value = '';
                } catch (error) {
                    console.error("Erro ao adicionar atividade:", error);
                    showMessage("Erro ao adicionar atividade. Tente novamente.");
                }
            });

            const unsubscribeActivities = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'activities'), (snapshot) => {
                currentActivities = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateActivitiesTable();
            }, (error) => console.error("Erro ao carregar atividades (Secret√°rio):", error));

            function updateActivitiesTable() {
                const tbody = document.getElementById('activities-table-body');
                if (!tbody) return;
                if (currentActivities.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="py-4 px-4 text-center text-slate-600">Nenhuma atividade cadastrada.</td></tr>';
                } else {
                    tbody.innerHTML = currentActivities.map(activity => `
                        <tr class="border-b border-slate-200 last:border-b-0 hover:bg-slate-50">
                            <td class="py-3 px-4 text-sm">${activity.name}</td>
                            <td class="py-3 px-4 text-sm">${activity.type}</td>
                            <td class="py-3 px-4 text-sm font-bold">${activity.maxPoints}</td>
                            <td class="py-3 px-4 text-sm">
                                <button data-id="${activity.id}" data-name="${activity.name}" class="delete-activity-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-xs transition duration-300 ease-in-out transform hover:scale-105">Excluir</button>
                            </td>
                        </tr>
                    `).join('');
                    tbody.querySelectorAll('.delete-activity-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => handleDeleteActivity(e.target.dataset.id, e.target.dataset.name));
                    });
                }
            }

            async function handleDeleteActivity(activityId, activityName) {
                showMessage(`Tem certeza que deseja excluir a atividade "${activityName}"?`, async (confirmed) => {
                    if (confirmed) {
                        try {
                            const activityDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'activities', activityId);
                            await deleteDoc(activityDocRef);
                            showMessage(`Atividade "${activityName}" exclu√≠da com sucesso!`);
                        } catch (error) {
                            console.error("Erro ao excluir atividade:", error);
                            showMessage("Erro ao excluir atividade. Tente novamente.");
                        }
                    }
                }, true);
            }

            const unsubscribeSubmissions = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'submissions'), (snapshot) => {
                currentSubmissions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                currentSubmissions.sort((a, b) => b.submittedAt?.toDate() - a.submittedAt?.toDate());
                updateSubmissionsTables();
                renderDashboard();
            }, (error) => console.error("Erro ao carregar envios (Secret√°rio):", error));

            function updateSubmissionsTables() {
                const pendingSubmissions = currentSubmissions.filter(sub => sub.status === 'pending');
                const allSubmissions = currentSubmissions;

                document.getElementById('pending-submissions-count').textContent = pendingSubmissions.length;

                const pendingListDiv = document.getElementById('pending-submissions-list');
                if (!pendingListDiv) return;
                if (pendingSubmissions.length === 0) {
                    pendingListDiv.innerHTML = '<p class="text-slate-600">Nenhum envio pendente no momento.</p>';
                } else {
                    let tableHtml = `
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white rounded-lg shadow-md">
                                <thead class="bg-yellow-100">
                                    <tr>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700 rounded-tl-lg">Unidade</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Atividade</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Detalhes</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Evid√™ncia</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Pontos a Atribuir</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    pendingSubmissions.forEach(sub => {
                        const activityMaxPoints = currentActivities.find(act => act.id === sub.activityId)?.maxPoints || 0;
                        tableHtml += `
                            <tr class="border-b border-slate-200 last:border-b-0 hover:bg-slate-50">
                                <td class="py-3 px-4 text-sm">${sub.unitName}</td>
                                <td class="py-3 px-4 text-sm">${sub.activityName}</td>
                                <td class="py-3 px-4 text-sm max-w-xs truncate">${sub.details}</td>
                                <td class="py-3 px-4 text-sm">
                                    ${sub.photoUrl ? `<a href="${sub.photoUrl}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">Ver Foto</a>` : 'N/A'}
                                </td>
                                <td class="py-3 px-4 text-sm">
                                    <input type="number" value="${activityMaxPoints}" min="0" max="${activityMaxPoints}" data-submission-id="${sub.id}" class="points-input w-20 p-1 border border-slate-300 rounded-md text-center">
                                    <span class="ml-1 text-xs text-slate-500">/${activityMaxPoints}</span>
                                </td>
                                <td class="py-3 px-4 text-sm flex flex-col sm:flex-row gap-2">
                                    <button data-id="${sub.id}" data-unit-id="${sub.unitId}" class="approve-btn bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-lg text-xs transition duration-300 ease-in-out transform hover:scale-105">Aprovar</button>
                                    <button data-id="${sub.id}" class="reject-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-xs transition duration-300 ease-in-out transform hover:scale-105">Rejeitar</button>
                                </td>
                            </tr>
                        `;
                    });
                    tableHtml += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    pendingListDiv.innerHTML = tableHtml;

                    pendingListDiv.querySelectorAll('.approve-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const submissionId = e.target.dataset.id;
                            const unitId = e.target.dataset.unitId;
                            const pointsInput = e.target.closest('tr').querySelector('.points-input');
                            const points = parseInt(pointsInput.value);
                            handleApproveSubmission(submissionId, unitId, points);
                        });
                    });
                    pendingListDiv.querySelectorAll('.reject-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => handleRejectSubmission(e.target.dataset.id));
                    });
                }

                const allSubmissionsListDiv = document.getElementById('all-submissions-list');
                if (!allSubmissionsListDiv) return;
                if (allSubmissions.length === 0) {
                    allSubmissionsListDiv.innerHTML = '<p class="text-slate-600">Nenhum envio registrado ainda.</p>';
                } else {
                    let tableHtml = `
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white rounded-lg shadow-md">
                                <thead class="bg-slate-200">
                                    <tr>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700 rounded-tl-lg">Unidade</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Atividade</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Status</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Pontos</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Data Envio</th>
                                        <th class="py-3 px-4 text-left text-sm font-semibold text-slate-700">Data Valida√ß√£o</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    allSubmissions.forEach(sub => {
                        const statusClass = sub.status === 'pending' ? 'pending' : (sub.status === 'approved' ? 'approved' : 'rejected');
                        tableHtml += `
                            <tr class="border-b border-slate-200 last:border-b-0 hover:bg-slate-50">
                                <td class="py-3 px-4 text-sm">${sub.unitName}</td>
                                <td class="py-3 px-4 text-sm">${sub.activityName}</td>
                                <td class="py-3 px-4 text-sm">
                                    <span class="px-2 py-1 rounded-full text-xs font-semibold status-badge ${statusClass}">
                                        ${sub.status === 'pending' ? 'Pendente' : (sub.status === 'approved' ? 'Aprovado' : 'Rejeitado')}
                                    </span>
                                </td>
                                <td class="py-3 px-4 text-sm font-bold">${sub.pointsAwarded || 'N/A'}</td>
                                <td class="py-3 px-4 text-sm">
                                    ${sub.submittedAt ? new Date(sub.submittedAt.toDate()).toLocaleDateString('pt-BR') : 'N/A'}
                                </td>
                                <td class="py-3 px-4 text-sm">
                                    ${sub.validatedAt ? new Date(sub.validatedAt.toDate()).toLocaleDateString('pt-BR') : 'N/A'}
                                </td>
                            </tr>
                        `;
                    });
                    tableHtml += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    allSubmissionsListDiv.innerHTML = tableHtml;
                }
            }

            async function handleApproveSubmission(submissionId, unitId, points) {
                if (points === null || points < 0) {
                    showMessage("Por favor, insira uma pontua√ß√£o v√°lida.");
                    return;
                }

                showMessage(`Confirmar aprova√ß√£o do envio com ${points} pontos?`, async (confirmed) => {
                    if (confirmed) {
                        try {
                            const submissionDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'submissions', submissionId);
                            await updateDoc(submissionDocRef, {
                                status: 'approved',
                                pointsAwarded: parseInt(points),
                                validatedAt: serverTimestamp(),
                            });

                            const unitDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'units', unitId);
                            const unitSnap = await getDoc(unitDocRef);
                            if (unitSnap.exists()) {
                                const currentScore = unitSnap.data().score || 0;
                                await updateDoc(unitDocRef, {
                                    score: currentScore + parseInt(points),
                                });
                            }
                            showMessage(`Envio aprovado e pontua√ß√£o da unidade atualizada!`);
                        } catch (error) {
                            console.error("Erro ao aprovar envio:", error);
                            showMessage("Erro ao aprovar envio. Tente novamente.");
                        }
                    }
                }, true);
            }

            async function handleRejectSubmission(submissionId) {
                showMessage("Tem certeza que deseja rejeitar este envio?", async (confirmed) => {
                    if (confirmed) {
                        try {
                            const submissionDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'submissions', submissionId);
                            await updateDoc(submissionDocRef, {
                                status: 'rejected',
                                pointsAwarded: 0,
                                validatedAt: serverTimestamp(),
                            });
                            showMessage("Envio rejeitado com sucesso!");
                        } catch (error) {
                            console.error("Erro ao rejeitar envio:", error);
                            showMessage("Erro ao rejeitar envio. Tente novamente.");
                        }
                    }
                }, true);
            }
        }

        function setupAuthFormListeners() {
            const authForm = document.getElementById('auth-form');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const loginBtn = document.getElementById('login-btn');
            const registerBtn = document.getElementById('register-btn');
            const logoutBtn = document.getElementById('logout-btn');

            if (authForm && loginBtn && registerBtn) {
                loginBtn.onclick = async (e) => {
                    e.preventDefault();
                    const email = emailInput.value;
                    const password = passwordInput.value;
                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                    } catch (error) {
                        console.error("Erro ao iniciar sess√£o:", error);
                        showMessage(`Erro ao iniciar sess√£o: ${error.message}`);
                    }
                };

                registerBtn.onclick = async (e) => {
                    e.preventDefault();
                    const email = emailInput.value;
                    const password = passwordInput.value;
                    try {
                        await createUserWithEmailAndPassword(auth, email, password);
                        showMessage("Registo bem-sucedido! A iniciar sess√£o...");
                    } catch (error) {
                        console.error("Erro ao registar:", error);
                        showMessage(`Erro ao registar: ${error.message}`);
                    }
                };
            }

            if (logoutBtn) {
                logoutBtn.onclick = async () => {
                    try {
                        await signOut(auth);
                        showMessage("Sess√£o terminada com sucesso!");
                    } catch (error) {
                        console.error("Erro ao terminar sess√£o:", error);
                        showMessage(`Erro ao terminar sess√£o: ${error.message}`);
                    }
                };
            }
        }


        // --- INICIALIZA√á√ÉO PRINCIPAL DA APLICA√á√ÉO ---
        // Esta fun√ß√£o √© chamada quando o DOM est√° pronto e o Firebase √© inicializado.
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DOMContentLoaded: Iniciando...");

            // Tenta inicializar o Firebase
            try {
                if (!firebaseConfig.apiKey || !firebaseConfig.projectId || !firebaseConfig.authDomain) {
                    throw new Error("As credenciais do Firebase (apiKey, projectId, authDomain) n√£o foram preenchidas ou est√£o incompletas.");
                }
                firebaseApp = initializeApp(firebaseConfig);
                db = getFirestore(firebaseApp);
                auth = getAuth(firebaseApp);
                console.log("Firebase initialized.");

                // Oculta o overlay de carregamento
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.add('hidden');
                    console.log("Loading overlay hidden.");
                }

                // Configura os listeners de autentica√ß√£o
                setupAuthFormListeners();

                // Observa o estado de autentica√ß√£o para exibir a UI correta
                onAuthStateChanged(auth, async (user) => {
                    console.log("onAuthStateChanged: Estado do usu√°rio alterado. User:", user);
                    if (user) {
                        currentUser = user;
                        // Tenta buscar o papel do utilizador no Firestore
                        const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid);
                        const userDocSnap = await getDoc(userDocRef);

                        if (userDocSnap.exists()) {
                            userRole = userDocSnap.data().role;
                            console.log("User role from Firestore:", userRole);
                        } else {
                            // Se o utilizador n√£o tiver um papel, define como l√≠der por padr√£o
                            await setDoc(userDocRef, { role: 'leader', uid: user.uid, email: user.email || 'N/A' });
                            userRole = 'leader';
                            console.log("User role set to default 'leader'.");
                        }
                        // Esconde o formul√°rio de login e mostra o conte√∫do principal
                        document.getElementById('auth-section').classList.add('hidden');
                        document.getElementById('main-app-content').classList.remove('hidden');
                        initAppContent(); // Inicializa o conte√∫do principal da aplica√ß√£o
                    } else {
                        currentUser = null;
                        userRole = null;
                        // Mostra o formul√°rio de login e esconde o conte√∫do principal
                        document.getElementById('auth-section').classList.remove('hidden');
                        document.getElementById('main-app-content').classList.add('hidden');
                        console.log("User not authenticated. Showing auth section.");
                    }
                });

            } catch (error) {
                console.error("Erro cr√≠tico na inicializa√ß√£o do Firebase:", error);
                showMessage(`Erro cr√≠tico na inicializa√ß√£o do Firebase: ${error.message}. Por favor, verifique a sua consola e as configura√ß√µes do Firebase.`);
                // Garante que o overlay √© escondido mesmo em caso de erro cr√≠tico de inicializa√ß√£o
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.add('hidden');
                }
            }
        });

        // Fun√ß√£o para inicializar o conte√∫do da aplica√ß√£o (chamada ap√≥s autentica√ß√£o)
        async function initAppContent() {
            console.log("initAppContent: Iniciando conte√∫do da aplica√ß√£o.");
            // Atualiza informa√ß√µes do utilizador no cabe√ßalho
            document.getElementById('user-info').textContent = `Ol√°, ${userRole === 'secretary' ? 'Secret√°rio(a)' : 'L√≠der de Unidade'} (ID: ${currentUser.uid})`;
            document.getElementById('logout-btn').classList.remove('hidden');

            // Mostra/esconde a aba 'Gest√£o' com base no papel
            if (userRole === 'leader' || userRole === 'secretary') {
                document.querySelector('button[data-tab="gestao"]').classList.remove('hidden');
            } else {
                document.querySelector('button[data-tab="gestao"]').classList.add('hidden');
            }

            // Busca dados iniciais para todas as sec√ß√µes
            try {
                await Promise.all([getUnits(), getActivities(), getSubmissions(), getDemerits()]);
                console.log("initAppContent: Dados Firebase carregados com sucesso.");
            } catch (error) {
                console.error("initAppContent: Erro ao buscar dados Firebase:", error);
                showMessage("Erro ao carregar dados. Por favor, verifique as regras de seguran√ßa do Firestore.");
            }

            // Renderiza conte√∫do est√°tico
            renderCalendar();
            renderAbout();
            console.log("initAppContent: Conte√∫do est√°tico renderizado.");

            // Configura a exibi√ß√£o inicial da aba
            const tabs = document.querySelectorAll('.tab-button');
            const contentSections = document.querySelectorAll('.content-section');

            function switchTab(e) {
                const targetTab = e.currentTarget.dataset.tab;

                tabs.forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.tab === targetTab);
                });

                contentSections.forEach(section => {
                    section.classList.toggle('active', section.id === targetTab);
                });

                if (targetTab === 'inicio') {
                    renderDashboard();
                } else if (targetTab === 'gestao') {
                    if (userRole === 'secretary') {
                        renderSecretaryDashboard();
                    } else if (userRole === 'leader') {
                        renderUnitLeaderDashboard();
                    } else {
                        showMessage("Voc√™ n√£o tem permiss√£o para aceder a esta se√ß√£o.");
                        document.querySelector('.tab-button[data-tab="inicio"]').click();
                    }
                }
            }

            tabs.forEach(tab => tab.addEventListener('click', switchTab));

            document.body.addEventListener('click', function (event) {
                if (event.target.matches('.accordion-button') || event.target.closest('.accordion-button')) {
                    const button = event.target.matches('.accordion-button') ? event.target : event.target.closest('.accordion-button');
                    const content = button.nextElementSibling;
                    const icon = button.querySelector('span:last-child');

                    button.classList.toggle('open');
                    icon.classList.toggle('rotate-180');

                    if (button.classList.contains('open')) {
                        content.style.maxHeight = content.scrollHeight + 'px';
                    } else {
                        content.style.maxHeight = null;
                    }
                }
            });

            document.querySelector('.tab-button[data-tab="inicio"]').classList.add('active');
            document.getElementById('inicio').classList.add('active');
            renderDashboard();
            console.log("initAppContent: Inicializa√ß√£o completa da UI.");
        }
    </script>
</body>

</html>