<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gincana de Unidades: Edição 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .tab-button.active {
            border-bottom-color: #2563eb;
            color: #2563eb;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }

        .accordion-button.open+.accordion-content {
            max-height: 1000px;
        }

        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
            max-width: 800px;
            margin: auto;
            max-height: 400px;
        }

        #scoreChart {
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .chart-container {
                height: 60vh;
            }

            nav.overflow-x-auto {
                justify-content: flex-start;
            }
        }

        .list-disc-custom li::marker {
            color: #2563eb;
        }

        .list-decimal-custom li::marker {
            color: #2563eb;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: capitalize;
        }

        .status-badge.pending {
            background-color: #fef9c3;
            color: #ca8a04;
        }

        .status-badge.approved {
            background-color: #dcfce7;
            color: #16a34a;
        }

        .status-badge.rejected {
            background-color: #fee2e2;
            color: #dc2626;
        }

        #surprise-challenge-banner {
            animation: slideDown 0.5s ease-in-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800">

    <div id="loading-overlay"
        class="fixed inset-0 bg-slate-100 bg-opacity-90 flex flex-col justify-center items-center z-50">
        <div class="animate-spin rounded-full h-20 w-20 border-t-2 border-b-2 border-blue-500"></div>
        <p class="mt-4 text-lg text-slate-700">A carregar aplicação...</p>
    </div>

    <div id="messageBox" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 hidden">
        <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full text-center">
            <p id="messageText" class="text-lg font-semibold mb-4"></p>
            <div class="flex justify-center space-x-4">
                <button id="messageConfirmBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">OK</button>
                <button id="messageCancelBtn"
                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 hidden">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 hidden">
        <div class="bg-white rounded-lg p-6 shadow-xl max-w-lg w-full">
            <h3 id="editModalTitle" class="text-2xl font-bold mb-4 text-slate-800"></h3>
            <div id="editModalContent" class="space-y-4"></div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="editModalCancelBtn"
                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="editModalSaveBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Salvar
                    Alterações</button>
            </div>
        </div>
    </div>

    <section id="auth-section"
        class="flex items-center justify-center min-h-screen bg-gradient-to-br from-slate-100 to-blue-200 p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
            <h2 class="text-3xl font-bold text-blue-800 mb-6">Acesso à Gincana</h2>
            <form id="auth-form" class="space-y-4">
                <div><label for="email" class="sr-only">Email</label><input type="email" id="email" placeholder="Email"
                        class="w-full p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                        required></div>
                <div><label for="password" class="sr-only">senha</label><input type="password" id="password"
                        placeholder="senha"
                        class="w-full p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                        required></div>
                <button type="submit" id="login-btn"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">Iniciar
                    Sessão</button>
                <button type="button" id="register-btn"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">Registar</button>
            </form>
            <p class="text-sm text-slate-500 mt-4">Após o registo, a sua conta terá acesso de visualização. Contacte a
                diretoria para obter permissões de Líder ou Secretário.</p>
        </div>
    </section>

    <div id="main-app-content" class="container mx-auto p-4 md:p-8 hidden">
        <div id="surprise-challenge-banner"
            class="hidden mb-8 p-6 bg-gradient-to-r from-amber-400 to-yellow-500 text-white rounded-xl shadow-2xl">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                <h3 class="text-2xl font-bold">⚡ Desafio Surpresa Ativo!</h3>
                <div id="challenge-timer" class="text-3xl font-bold bg-white text-yellow-500 rounded-lg px-4 py-2">00:00
                </div>
            </div>
            <h4 id="challenge-title" class="text-xl font-semibold"></h4>
            <p id="challenge-description" class="mt-2"></p>
            <p class="mt-2 font-bold">Vale: <span id="challenge-points"></span> pontos!</p>
            <form id="challenge-submission-form" class="mt-4 flex flex-col md:flex-row gap-4">
                <select id="challenge-unit-select" class="admin-input !text-slate-800 w-full md:w-auto"
                    required></select>
                <input type="text" id="challenge-answer-input" placeholder="Digite sua resposta aqui"
                    class="admin-input !text-slate-800 flex-grow" required>
                <button type="submit" class="admin-btn bg-white hover:bg-yellow-100 !text-yellow-600 font-bold">Enviar
                    Resposta</button>
            </form>
        </div>

        <header class="mb-8">
            <div class="flex flex-col md:flex-row justify-between md:items-start text-center md:text-left">
                <div>
                    <h1 class="text-3xl md:text-5xl font-bold text-blue-800">Gincana de Unidades</h1>
                    <h2 class="text-xl md:text-3xl font-semibold text-slate-600">Edição 2025</h2>
                </div>
                <div class="flex items-center justify-center space-x-4 mt-4 md:mt-0">
                    <div id="notifications-bell-container" class="relative hidden">
                        <button id="notifications-bell-btn" class="text-slate-500 hover:text-blue-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                            </svg>
                            <span id="notifications-count"
                                class="absolute -top-1 -right-1 bg-red-600 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                        </button>
                    </div>
                    <button id="logout-btn"
                        class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md hidden">Sair</button>
                </div>
            </div>
            <div class="text-center mt-4">
                <p class="text-slate-500 italic max-w-3xl mx-auto">"Não to mandei eu? Sê forte e corajoso; não temas, nem te
                    espantes, porque o Senhor teu Deus é contigo, por onde quer que andares." – Josué 1:9</p>
                <p id="user-info" class="mt-2 text-sm text-slate-500">Carregando...</p>
            </div>
        </header>

        <nav id="main-nav" class="flex md:justify-center border-b-2 border-slate-200 mb-8 overflow-x-auto"></nav>
        <main id="main-content"></main>
    </div>

    <div id="notifications-panel"
        class="hidden fixed top-16 right-4 md:right-8 w-80 bg-white rounded-lg shadow-xl border border-slate-200 z-50">
        <div class="p-3 border-b font-bold text-slate-700">Notificações</div>
        <div id="notifications-list" class="max-h-96 overflow-y-auto"></div>
        <div class="p-2 border-t text-center">
            <button id="mark-all-read-btn" class="text-sm text-blue-600 hover:underline">Marcar todas como
                lidas</button>
        </div>
    </div>
    </div>
    <button id="logout-btn"
        class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md hidden">Sair</button>
    </div>
    </div>
    </header>

    <nav id="main-nav" class="flex md:justify-center border-b-2 border-slate-200 mb-8 overflow-x-auto">
        <button data-tab="inicio"
            class="tab-button text-lg font-semibold p-4 border-b-4 border-transparent hover:text-blue-600 transition-colors duration-300 whitespace-nowrap">🏁
            Início</button>
        <button data-tab="conquistas"
            class="tab-button text-lg font-semibold p-4 border-b-4 border-transparent hover:text-blue-600 transition-colors duration-300 whitespace-nowrap">🏆
            Conquistas</button>
        <button data-tab="calendario"
            class="tab-button text-lg font-semibold p-4 border-b-4 border-transparent hover:text-blue-600 transition-colors duration-300 whitespace-nowrap">📅
            Calendário</button>
        <button data-tab="regulamento"
            class="tab-button text-lg font-semibold p-4 border-b-4 border-transparent hover:text-blue-600 transition-colors duration-300 whitespace-nowrap">📜
            Regulamento</button>
        <button data-tab="sobre"
            class="tab-button text-lg font-semibold p-4 border-b-4 border-transparent hover:text-blue-600 transition-colors duration-300 whitespace-nowrap">🛡️
            Sobre o Clube</button>
        <button data-tab="gestao"
            class="tab-button text-lg font-semibold p-4 border-b-4 border-transparent hover:text-blue-600 transition-colors duration-300 whitespace-nowrap hidden">⚙️
            Gestão</button>
    </nav>

    <main>
        <section id="inicio" class="content-section">
            <div id="inicio-empty-state" class="hidden text-center p-8 bg-white rounded-lg shadow-md">
                <h3 class="text-2xl font-bold text-slate-700">Bem-vindo(a) à Gincana!</h3>
                <p id="inicio-empty-state-secretary" class="hidden mt-4 text-slate-600">Ainda não há unidades
                    cadastradas. Para começar, vá para a aba <strong class="text-blue-600">⚙️ Gestão</strong> e
                    adicione sua primeira unidade.</p>
                <p id="inicio-empty-state-leader" class="hidden mt-2 text-slate-500">Aguarde até que o secretário do
                    clube configure as unidades e atividades.</p>
            </div>

            <div id="dashboard-main-content">
                <p class="mb-6 text-slate-700 text-center">Bem-vindo ao painel da Gincana de Unidades! Aqui você
                    encontra um resumo rápido do progresso e o placar geral das unidades.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 text-center">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-slate-500 font-semibold text-base md:text-lg">Unidade em Destaque</h3>
                        <p id="unidade-destaque" class="text-2xl md:text-3xl font-bold text-blue-600 mt-2">
                            Carregando...</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-slate-500 font-semibold text-base md:text-lg">Total de Pontos Acumulados pelo Clube
                        </h3>
                        <p id="total-pontos" class="text-2xl md:text-3xl font-bold text-blue-600 mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-slate-500 font-semibold text-base md:text-lg">Atividades Concluídas pelo clube</h3>
                        <p id="atividades-realizadas" class="text-2xl md:text-3xl font-bold text-blue-600 mt-2">0
                        </p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h3 class="text-2xl font-bold text-slate-700 mb-4 text-center">Placar Geral da Gincana</h3>
                    <div class="chart-container">
                        <canvas id="scoreChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <section id="conquistas" class="content-section">
            <h2 class="text-3xl font-bold text-center mb-8 text-slate-700">Mural de Honra: Conquistas</h2>
            <p class="mb-6 text-slate-700 text-center">Aqui são exibidas todas as medalhas e conquistas especiais
                concedidas às unidades por feitos notáveis durante a gincana.</p>
            <div id="achievements-feed" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            </div>
        </section>

        <section id="unit-page" class="content-section">
            <button id="back-to-main-btn"
                class="mb-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd"
                        d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                        clip-rule="evenodd" />
                </svg>
                Voltar
            </button>
            <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
                <div class="text-center border-b pb-4 mb-6">
                    <h2 id="unit-page-name" class="text-3xl md:text-4xl font-bold text-blue-800">Nome da Unidade
                    </h2>
                    <p class="text-xl md:text-2xl font-semibold text-slate-600 mt-2">Pontuação: <span
                            id="unit-page-score" class="text-blue-600">0</span></p>
                </div>

                <div class="mb-8">
                    <h3 class="text-2xl font-bold text-slate-700 mb-4">🏆 Conquistas da Unidade</h3>
                    <div id="unit-page-achievements"
                        class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 text-center">
                    </div>
                </div>

                <div>
                    <h3 class="text-2xl font-bold text-slate-700 mb-4">📜 Histórico de Envios</h3>
                    <div id="unit-page-submissions" class="overflow-x-auto">
                    </div>
                </div>
            </div>
        </section>

        <section id="calendario" class="content-section">
            <h2 class="text-3xl font-bold text-center mb-8 text-slate-700">Calendário de Atividades</h2>
            <p class="mb-6 text-slate-700 text-center">Navegue pelas atividades diárias e semanais programadas para
                cada mês. As atividades semanais ocorrem sempre aos domingos.</p>
            <div id="calendario-container" class="space-y-4">
            </div>
        </section>

        <section id="regulamento" class="content-section">
            <h2 class="text-3xl font-bold text-center mb-8 text-slate-700">Regulamento Interno da Gincana</h2>
            <p class="mb-6 text-slate-700 text-center">Conheça as regras de pontuação, critérios de desempate,
                conduta esperada e procedimentos para recursos, garantindo uma gincana justa e organizada.</p>
            <div class="space-y-4">
                <div class="bg-white rounded-xl shadow-md">
                        <button
                            class="accordion-button w-full text-left p-6 font-bold text-xl text-blue-800 flex justify-between items-center">
                            <span>1. Sistema de Pontuação</span>
                            <span class="transform transition-transform duration-300">▼</span>
                        </button>
                        <div id="pontuacao-content" class="accordion-content px-6 pb-6 text-slate-600 space-y-4">
                            <h4 class="font-bold text-lg text-slate-700">Pontuação Base por Atividade:</h4>
                            <ul class="list-disc list-inside list-disc-custom space-y-1">
                                <li><strong>Atividades Diárias:</strong> 5 pontos por Desbravador presente e ativo na
                                    atividade. 5-10 pontos extras por Desbravador que concluir ou acertar o desafio.
                                </li>
                                <li><strong>Atividades Semanais:</strong> 20 pontos por unidade que participar
                                    integralmente. 30-100 pontos por desempenho/conclusão. 10-50 pontos extras por
                                    qualidade/criatividade.</li>
                            </ul>
                            <h4 class="font-bold text-lg text-slate-700 mt-4">Bônus Especiais:</h4>
                            <ul class="list-disc list-inside list-disc-custom space-y-1">
                                <li><strong>"Espírito Desbravador" (Semanal):</strong> 50 pontos.</li>
                                <li><strong>"Unidade Nota 10" (Mensal):</strong> 100 pontos.</li>
                                <li><strong>"Uniforme Impecável" (Semanal):</strong> 20 pontos.</li>
                                <li><strong>"Desafio Surpresa":</strong> Pontos variáveis.</li>
                            </ul>
                            <h4 class="font-bold text-lg text-slate-700 mt-4">Penalidades:</h4>
                            <ul class="list-disc list-inside list-disc-custom space-y-1">
                                <li><strong>Atraso na Entrega:</strong> -10 pontos por dia.</li>
                                <li><strong>Comportamento Antidesbravador:</strong> -20 a -50 pontos.</li>
                                <li><strong>Falta em Atividades Obrigatórias:</strong> -10 pontos por membro.</li>
                            </ul>
                            <h4 class="font-bold text-lg text-slate-700 mt-4">Placar e Acompanhamento:</h4>
                            <p>Um Placar Geral visível e atualizado semanalmente (online ou físico) com a pontuação de
                                cada unidade. Um "Painel de Conquistas" registrará visualmente os progressos.</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md">
                        <button
                            class="accordion-button w-full text-left p-6 font-bold text-xl text-blue-800 flex justify-between items-center">
                            <span>2. Critérios de Desempate</span>
                            <span class="transform transition-transform duration-300">▼</span>
                        </button>
                        <div id="desempate-content" class="accordion-content px-6 pb-6 text-slate-600 space-y-4">
                            <p>Em caso de empate na pontuação final ou em qualquer etapa decisiva, os seguintes
                                critérios serão aplicados sequencialmente:</p>
                            <ol class="list-decimal list-inside list-decimal-custom space-y-1">
                                <li>Maior número de Bônus "Espírito Desbravador" acumulados.</li>
                                <li>Maior número de Atividades Semanais concluídas com pontuação máxima.</li>
                                <li>Menor número de Penalidades registradas.</li>
                                <li>Sorteio: Em caso de persistência do empate, será realizado um sorteio justo e
                                    transparente.</li>
                            </ol>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md">
                        <button
                            class="accordion-button w-full text-left p-6 font-bold text-xl text-blue-800 flex justify-between items-center">
                            <span>3. Conduta Esperada</span>
                            <span class="transform transition-transform duration-300">▼</span>
                        </button>
                        <div id="conduta-content" class="accordion-content px-6 pb-6 text-slate-600 space-y-4">
                            <p>Todos os Desbravadores e líderes devem aderir aos princípios de conduta do Clube:</p>
                            <ul class="list-disc list-inside list-disc-custom space-y-1">
                                <li><strong>Respeito:</strong> Tratar todos com respeito, cortesia e empatia.</li>
                                <li><strong>Cooperação:</strong> Trabalhar em equipe, auxiliando os colegas e a unidade.
                                </li>
                                <li><strong>Disciplina:</strong> Seguir as instruções dos líderes e as regras do clube.
                                </li>
                                <li><strong>Integridade:</strong> Ser honesto em todas as atividades e submissões.</li>
                                <li><strong>Espírito Esportivo:</strong> Aceitar vitórias e derrotas com humildade e
                                    dignidade.</li>
                                <li><strong>Segurança:</strong> Priorizar a segurança própria e alheia em todas as
                                    atividades.</li>
                            </ul>
                            <p class="mt-2">Comportamentos que contrariem os ideais do Desbravador ou que prejudiquem o
                                ambiente da gincana serão passíveis de penalidades.</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md">
                        <button
                            class="accordion-button w-full text-left p-6 font-bold text-xl text-blue-800 flex justify-between items-center">
                            <span>4. Procedimentos para Recursos (Apelações)</span>
                            <span class="transform transition-transform duration-300">▼</span>
                        </button>
                        <div id="recursos-content" class="accordion-content px-6 pb-6 text-slate-600 space-y-4">
                            <p>Caso uma unidade ou líder discorde da pontuação atribuída ou de uma penalidade, poderá
                                apresentar um recurso:</p>
                            <ol class="list-decimal list-inside list-decimal-custom space-y-1">
                                <li><strong>Comunicação Inicial:</strong> O líder da unidade deve comunicar formalmente
                                    a secretária do clube, por escrito (e-mail ou mensagem oficial), no prazo máximo de
                                    24 horas após a divulgação da pontuação contestada.</li>
                                <li><strong>Análise Preliminar:</strong> A secretária e o diretor associado responsável
                                    pela gincana analisarão o recurso e as evidências.</li>
                                <li><strong>Decisão:</strong> A decisão será comunicada ao Conselheiro da unidade em até 48
                                    horas. A decisão da diretoria é final e irrevogável.</li>
                            </ol>
                        </div>
                    </div>
            </div>
        </section>

        <section id="sobre" class="content-section">
            <h2 class="text-3xl font-bold text-center mb-8 text-slate-700">Sobre o Clube de Desbravadores</h2>
            <p class="mb-6 text-slate-700 text-center">Conheça os fundamentos, a história e a estrutura que guiam o
                Clube de Desbravadores, um movimento mundial dedicado ao desenvolvimento integral de juvenis e
                adolescentes.</p>
            <div class="space-y-4">
                <div class="bg-white rounded-xl shadow-md">
                    <button
                        class="accordion-button w-full text-left p-6 font-bold text-xl text-blue-800 flex justify-between items-center">
                        <span>As Bases do Clube</span>
                        <span class="transform transition-transform duration-300">▼</span>
                    </button>
                    <div id="bases-content" class="accordion-content px-6 pb-6 text-slate-600 space-y-4">
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md">
                    <button
                        class="accordion-button w-full text-left p-6 font-bold text-xl text-blue-800 flex justify-between items-center">
                        <span>Estrutura e Funções</span>
                        <span class="transform transition-transform duration-300">▼</span>
                    </button>
                    <div id="funcoes-content" class="accordion-content px-6 pb-6 text-slate-600 space-y-4">
                    </div>
                </div>
            </div>
        </section>

        <section id="gestao" class="content-section">
            <h2 id="gestao-title" class="text-3xl font-bold text-center mb-8 text-slate-700">
                Carregando informações de gestão...
            </h2>
            <div id="gestao-content" class="space-y-6">
            </div>
        </section>
    </main>
    </div>

    <script type="module">
        console.log("Script de módulo a ser executado - Versão: 2024-06-08_RELATORIO_FALTAS");

        // Importações do Firebase SDK (com getDocs e where adicionados)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        // Variáveis de estado do Firebase e da aplicação
        let firebaseApp = null;
        let db = null;
        let auth = null;
        let currentUser = null;
        let userRole = null;

        // --- NOVA CONSTANTE ---
        // Define quais cargos são considerados Liderança para a chamada e relatórios
        const LEADERSHIP_ROLES = [
            'Diretor(a)', 
            'Diretor(a) Associado(a)', 
            'Secretário(a) do Clube', 
            'Tesoureiro(a) do Clube', 
            'Capelão(ã) do Clube',
            'Instrutor(a)',
            'Conselheiro'
        ];

        // Configuração do Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'gincana-de-unidade';
        const firebaseConfigFromGlobal = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const firebaseConfig = firebaseConfigFromGlobal || {
            apiKey: "AIzaSyBJI_Hrp1I5GJHt82UKo5xjr392Z4XTMS8",
            authDomain: "gincana-de-unidade.firebaseapp.com",
            projectId: "gincana-de-unidade",
            storageBucket: "gincana-de-unidade.firebasestorage.app",
            messagingSenderId: "497226153394",
            appId: "1:497226153394:web:35d484f3737e3a3b4938ab"
        };
        console.log("AppId a ser usado:", appId);

        // MessageBox function
        const showMessage = (msg, callback, showCancel = false) => {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const confirmBtn = document.getElementById('messageConfirmBtn');
            const cancelBtn = document.getElementById('messageCancelBtn');
            if (!messageBox || !messageText || !confirmBtn || !cancelBtn) return;
            messageText.textContent = msg;
            messageBox.classList.remove('hidden');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            const newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
            newConfirmBtn.onclick = () => {
                messageBox.classList.add('hidden');
                if (callback) callback(true);
            };
            if (showCancel) {
                newCancelBtn.classList.remove('hidden');
                newCancelBtn.onclick = () => {
                    messageBox.classList.add('hidden');
                    if (callback) callback(false);
                };
            } else {
                newCancelBtn.classList.add('hidden');
            }
        };

        // Função do Modal de Edição Genérico
        function showEditModal(title, contentHtml, onSaveCallback) {
            const modal = document.getElementById('editModal'), modalTitle = document.getElementById('editModalTitle'), modalContent = document.getElementById('editModalContent'), saveBtn = document.getElementById('editModalSaveBtn'), cancelBtn = document.getElementById('editModalCancelBtn');
            if (!modal || !modalTitle || !modalContent || !saveBtn || !cancelBtn) return;
            modalTitle.textContent = title; modalContent.innerHTML = contentHtml; modal.classList.remove('hidden');
            const newSaveBtn = saveBtn.cloneNode(true); saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
            const newCancelBtn = cancelBtn.cloneNode(true); cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
            newSaveBtn.onclick = () => { if (onSaveCallback) onSaveCallback(); modal.classList.add('hidden'); };
            newCancelBtn.onclick = () => modal.classList.add('hidden');
        }

        // Variáveis de estado da aplicação
        let chartInstance = null;
        let currentUnits = [];
        let currentActivities = [];
        let currentSubmissions = [];
        let currentDemerits = [];
        let currentUsers = [];
        let currentAchievementDefs = [];
        let currentAwardedAchievements = [];
        let currentMembers = []; 
        let allNotifications = [];
        let activeChallengeUnsub = null;
        let countdownInterval = null;

        // Dados estáticos da aplicação
        const staticData = {
            calendar: { "Junho: Atividades": [{ date: "15/06/2025", title: "Amigo estou aqui...", desc: "<b>Objetivo Específico:</b> Estimular a criatividade e a representação simbólica da unidade. <br><b>Materiais Necessários:</b> Mascote previamente pela unidade.<br> <b>Número de Participantes:</b> Um ou dois representantes para apresentar; toda a unidade para confeccionar.<br> <b>Desenvolvimento e Regras Específicas:</b> Cada unidade apresentará seu mascote, explicando seu nome, significado e relação com a identidade da unidade. O mascote deve ser original e confeccionado pelos membros da unidade.<br> <b>Critérios de Avaliação:</b> Originalidade do mascote, criatividade na confecção, relação com a unidade, clareza na apresentação e explicação." }, { date: "15/06/2025", title: "#GritoChallenge", desc: "<b>Objetivo Específico:</b> Avaliar a criatividade, originalidade, animação, clareza da mensagem e representação da identidade da unidade e dos ideais Desbravadores. <br> <b>Materiais Necessários:</b> Seus próprios recursos vocais e corporais. <br> <b>Número de Participantes:</b> Toda a unidade. <br> <b>Desenvolvimento e Regras Específicas:</b> Cada unidade terá um tempo máximo de 2 minutos para apresentar seu Grito de Guerra. O Grito de Guerra deve ser original e não conter palavras ou gestos ofensivos ou contrários aos princípios cristãos. A apresentação pode incluir a bandeira da unidade. <br> <b>Critérios de Avaliação:</b> Originalidade, criatividade, entusiasmo, clareza da dicção, postura, sincronia, mensagem transmitida, respeito ao tempo." } ], },
            bases: [{ title: "Origem Histórica", content: "O Clube de Desbravadores foi oficializado em nível mundial no ano de 1950 pela Associação Geral da Igreja Adventista do Sétimo Dia, nos Estados Unidos. Suas raízes, no entanto, remontam a iniciativas anteriores de clubes missionários e de jovens que buscavam o desenvolvimento integral." }, { title: "Filosofia", content: "A filosofia do Clube de Desbravadores baseia-se no desenvolvimento harmonioso das forças físicas, mentais e espirituais dos juvenis e adolescentes. O programa busca preparar os jovens para a cidadania útil, o serviço à comunidade e o compromisso com Deus. Tudo o que o Desbravador faz tem um sentido, uma base, um alicerce de valores cristãos e princípios de vida." }, { title: "Objetivos Prioritários", content: "Os objetivos do Clube são amplos e visam o crescimento completo do indivíduo: Desenvolvimento Físico, Mental, Espiritual e Social." }, { title: "Símbolos do Clube", content: "Os símbolos do Desbravador são elementos visuais e conceituais que representam seus princípios: Ideais (Voto e Lei), Hino, Emblemas, Bandeira, Bandeirim e o Uniforme." }],
            funcoes: {
                "Cargos da Unidade": [{ title: "Conselheiro(a)", content: "É a autoridade máxima dentro da unidade, responsável pela ordem e andamento geral. Atua como elo entre a unidade e a direção do clube. Geralmente, deve ser batizado e ter mais de 18 anos (ou 16+ com supervisão de um diretor maior de idade em atividades externas)." }, { title: "Capitão(ã)", content: "Membro da unidade (10 a 15 anos) responsável por animar o grupo a cumprir o programa, por meio do exemplo e influência pessoal. Lidera a unidade em formações de Ordem Unida e a representa perante a direção. Deve ser organizado, ter liderança, disciplina, honestidade, fidelidade e humildade." }, { title: "Secretário(a) de Unidade", content: "Responsável por manter os registos da unidade atualizados, incluindo chamada de presença, pontualidade, assiduidade, uso do uniforme e higiene pessoal. Idade entre 10 e 15 anos." }, { title: "Tesoureiro(a) de Unidade", content: "Gerencia os pequenos recursos financeiros da unidade, mantendo registos precisos de despesas e receitas. Idade entre 10 e 15 anos." }, { title: "Padioleiro(a) de Unidade", content: "Atua como o 'enfermeiro' da unidade, responsável por auxiliar em pequenos acidentes e aplicar primeiros socorros básicos, sob supervisão. Idade entre 10 e 15 anos." }, { title: "Almoxarife de Unidade", content: "Responsável pela guarda e organização dos materiais e equipamentos da unidade. Idade entre 10 e 15 anos." }, { title: "Capelão(ã) de Unidade", content: "Mantém a ordem e harmonia espiritual da unidade, juntamente com o conselheiro, promovendo momentos de reflexão e estudo bíblico. Idade entre 10 e 15 anos, deve ser de boa índole e respeitador." }],
                "Cargos da Direção do Clube": [{ title: "Diretor(a) do Clube", content: "É a autoridade máxima do clube. Responsável por planejar, organizar e supervisionar todas as atividades, manter a ligação com o Pastor e a Associação, presidir as reuniões da comissão executiva e docente, e assegurar um programa completo para o clube. Deve ser um líder maduro, com boa reputação na Igreja e ter o treinamento para oficiais. Deve ser um exemplo de espiritualidade, prontidão, amabilidade, temperança, pontualidade e asseio pessoal, incluindo o uso adequado do uniforme." }, { title: "Diretores(as) Associados(as)", content: "São o braço direito do diretor, responsáveis pelo cumprimento do programa do clube. Coordenam as Classes, Especialidades e Unidades, gerenciando o trabalho dos instrutores e conselheiros. Geralmente há um diretor associado para a ala feminina e outro para a ala masculina. Não há limite para o número de diretores associados, dependendo do tamanho do clube." }, { title: "Secretário(a) do Clube", content: "Assume a responsabilidade pela documentação e registo das atividades do clube. Isso abrange a manutenção de registos de membros, elaboração de relatórios de eventos e comunicação de informações cruciais aos membros e suas famílias. Essencial para a organização administrativa do clube." }, { title: "Tesoureiro(a) do Clube", content: "Gerencia as finanças do clube, mantendo um registo preciso das despesas e receitas, elaborando orçamentos e assegurando o uso responsável dos recursos financeiros disponíveis. Responsável pela saúde financeira do clube." }, { title: "Capelão(ã) do Clube", content: "Encarregado da dimensão espiritual do clube, liderando estudos bíblicos, momentos de oração e promovendo os valores e princípios inerentes à crença Adventista do Sétimo Dia. Essencial para o desenvolvimento espiritual dos Desbravadores." }, { title: "Conselheiros(as) (Gerais) e Instrutores(as)", content: "Os conselheiros supervisionam as unidades, enquanto os instrutores são responsáveis por ensinar as classes e especialidades. Ambos trabalham em estreita colaboração com os diretores associados para garantir a execução do programa educativo do clube. A função de conselheiro é considerada uma das mais importantes, devido ao contato direto com os juvenis." }]
            }
        };

        // Funções de utilidade e de manipulação de dados definidas antes de serem chamadas.
        function wrapLabel(label, maxLen) {
            if (!label || label.length <= maxLen) return label;
            const lines = []; let currentLine = ''; const words = label.split(' ');
            for (const word of words) {
                if ((currentLine + (currentLine ? ' ' : '') + word).length <= maxLen) { currentLine += (currentLine ? ' ' : '') + word; } else {
                    if (currentLine) lines.push(currentLine);
                    currentLine = word;
                    while (currentLine.length > maxLen) { lines.push(currentLine.substring(0, maxLen)); currentLine = currentLine.substring(maxLen); }
                }
            }
            if (currentLine) lines.push(currentLine);
            return lines;
        }

        function applyTableStyles(tableBodyElement) {
            if (!tableBodyElement) return;
            tableBodyElement.querySelectorAll('tr').forEach(tr => tr.classList.add('border-b', 'border-slate-200', 'last:border-b-0', 'hover:bg-slate-50'));
            tableBodyElement.querySelectorAll('td').forEach(td => td.classList.add('py-3', 'px-4', 'text-sm'));
        }

        const handleAddUnit = async () => { const name = document.getElementById('new-unit-name').value.trim(); if (!name) { showMessage("O nome da unidade não pode estar vazio."); return; } try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'units'), { name, score: 0, createdAt: serverTimestamp() }); showMessage(`Unidade "${name}" adicionada com sucesso!`); document.getElementById('new-unit-name').value = ''; } catch (err) { console.error("Erro ao adicionar unidade:", err); showMessage("Ocorreu um erro ao adicionar a unidade."); } };
        const handleAddActivity = async () => { const name = document.getElementById('new-activity-name').value.trim(), type = document.getElementById('new-activity-type').value, maxPoints = parseInt(document.getElementById('new-activity-max-points').value), deadlineValue = document.getElementById('new-activity-deadline').value; if (!name || !type || isNaN(maxPoints) || maxPoints < 0) { showMessage("Por favor, preencha nome, tipo e pontos da atividade corretamente."); return; } const activityData = { name, type, maxPoints, createdAt: serverTimestamp() }; if (deadlineValue) activityData.deadline = new Date(deadlineValue); try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'activities'), activityData); showMessage(`Atividade "${name}" adicionada com sucesso!`); document.getElementById('new-activity-name').value = ''; document.getElementById('new-activity-type').value = ''; document.getElementById('new-activity-max-points').value = ''; document.getElementById('new-activity-deadline').value = ''; await createNotification({ title: "Nova Atividade!", message: `Uma nova atividade foi adicionada: ${name}`, icon: '📝', link: 'calendario' }); } catch (err) { console.error("Erro ao adicionar atividade:", err); showMessage("Ocorreu um erro ao adicionar a atividade."); } };
        const handleApplyDemerit = async () => { const unitId = document.getElementById('demerit-unit-select').value, points = parseInt(document.getElementById('demerit-points').value), reason = document.getElementById('demerit-reason').value.trim(); if (!unitId || isNaN(points) || points <= 0 || !reason) { showMessage("Por favor, preencha todos os campos do demérito."); return; } const unitName = currentUnits.find(u => u.id === unitId)?.name || '?'; showMessage(`Aplicar ${points} pontos de demérito a "${unitName}" pelo motivo: "${reason}"?`, async (confirmed) => { if (!confirmed) return; try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'demerits'), { unitId, unitName, points, reason, appliedBy: currentUser.uid, appliedAt: serverTimestamp() }); const unitDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'units', unitId); const unitSnap = await getDoc(unitDocRef); if (unitSnap.exists()) await updateDoc(unitDocRef, { score: (unitSnap.data().score || 0) - points }); showMessage("Demérito aplicado com sucesso!"); await createNotification({ title: "Demérito Aplicado", message: `A unidade ${unitName} recebeu ${points} pontos de demérito.`, icon: '📉', targetUnitId: unitId, link: 'regulamento' }); document.getElementById('demerit-unit-select').value = ""; document.getElementById('demerit-points').value = ""; document.getElementById('demerit-reason').value = ""; } catch (err) { console.error("Erro ao aplicar demérito:", err); showMessage("Ocorreu um erro ao aplicar o demérito."); } }, true); };
        const handleSendAnnouncement = async () => { const message = document.getElementById('new-announcement-message').value.trim(); if (!message) { showMessage("A mensagem do anúncio não pode estar vazia."); return; } await createNotification({ title: "Anúncio da Diretoria", message: message, icon: '📢' }); showMessage("Anúncio enviado com sucesso!"); document.getElementById('new-announcement-message').value = ''; };
        const handleLaunchChallenge = async () => {
            const title = document.getElementById('challenge-title-input').value.trim();
            const description = document.getElementById('challenge-desc-input').value.trim();
            const points = parseInt(document.getElementById('challenge-points-input').value, 10);
            const duration = parseInt(document.getElementById('challenge-duration-input').value, 10);
            const answer = document.getElementById('challenge-answer-input-admin').value.trim().toLowerCase();
            if (!title || !description || isNaN(points) || isNaN(duration) || !answer) {
                showMessage("Preencha todos os campos do desafio corretamente.");
                return;
            }
            const now = new Date();
            const endTime = new Date(now.getTime() + duration * 60000);
            const challengeData = { title, description, points, answer, startTime: now, endTime, completedBy: {} };
            const challengeRef = doc(db, 'artifacts', appId, 'public', 'data', 'surprise_challenges', 'active');
            try {
                await setDoc(challengeRef, challengeData);
                showMessage("Desafio Surpresa lançado com sucesso!");
                await createNotification({ title: "Desafio Surpresa!", message: `Um novo desafio foi lançado: ${title}`, icon: '⚡' });
            } catch (e) { console.error("Erro ao lançar desafio:", e); showMessage("Ocorreu um erro ao lançar o desafio."); }
        };
        const handleEndChallenge = async () => {
            const challengeRef = doc(db, 'artifacts', appId, 'public', 'data', 'surprise_challenges', 'active');
            showMessage("Tem certeza que deseja encerrar o desafio atual?", async (confirmed) => {
                if (!confirmed) return;
                try { await deleteDoc(challengeRef); showMessage("Desafio encerrado com sucesso."); } catch (e) { console.error("Erro ao encerrar desafio:", e); }
            }, true);
        };
        const handleAddAchievementDef = async () => { const name = document.getElementById('new-achievement-name').value.trim(), description = document.getElementById('new-achievement-desc').value.trim(), icon = document.getElementById('new-achievement-icon').value.trim(); if (!name || !icon) { showMessage("Nome e Ícone da conquista são obrigatórios."); return; } try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'achievements'), { name, description, icon, createdAt: serverTimestamp() }); showMessage("Tipo de conquista criado com sucesso!"); document.getElementById('new-achievement-name').value = ''; document.getElementById('new-achievement-desc').value = ''; document.getElementById('new-achievement-icon').value = ''; } catch (e) { console.error("Erro ao criar conquista:", e); showMessage("Erro ao criar conquista."); } };
        const handleAwardAchievement = async () => { const unitId = document.getElementById('award-ach-unit-select').value, achievementId = document.getElementById('award-ach-select').value; if (!unitId || !achievementId) { showMessage("Selecione uma unidade e uma conquista para conceder."); return; } const unit = currentUnits.find(u => u.id === unitId); const achDef = currentAchievementDefs.find(a => a.id === achievementId); if (!unit || !achDef) { showMessage("Unidade ou conquista inválida."); return; } showMessage(`Conceder a conquista "${achDef.name}" para a unidade "${unit.name}"?`, async (confirmed) => { if (!confirmed) return; try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'awarded_achievements'), { unitId: unit.id, unitName: unit.name, achievementId: achDef.id, achievementName: achDef.name, achievementIcon: achDef.icon, awardedAt: serverTimestamp(), awardedBy: currentUser.uid, }); await createNotification({ title: "Nova Conquista!", message: `A unidade ${unit.name} ganhou a conquista: ${achDef.name}!`, icon: achDef.icon, targetUnitId: unit.id, link: 'conquistas' }); showMessage("Conquista concedida com sucesso!"); } catch (e) { console.error("Erro ao conceder conquista:", e); showMessage("Erro ao conceder conquista."); } }, true); };
        const handleDeleteAchievementDef = async (defId) => { showMessage("Tem certeza que deseja excluir este tipo de conquista? Isso não afetará as que já foram concedidas.", async (confirmed) => { if (!confirmed) return; try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'achievements', defId)); showMessage("Tipo de conquista excluído."); } catch (e) { console.error("Erro ao excluir tipo de conquista:", e); showMessage("Erro ao excluir tipo de conquista."); } }, true); };

        // --- Funções de Notificação ---
        async function createNotification(data) {
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'notifications'), {
                    title: data.title,
                    message: data.message,
                    icon: data.icon,
                    link: data.link || null,
                    targetUnitId: data.targetUnitId || null,
                    isRead: {},
                    timestamp: serverTimestamp()
                });
            } catch (e) { console.error("Erro ao criar notificação:", e); }
        }

        function renderNotifications() {
            if (!currentUser) return;
            const listEl = document.getElementById('notifications-list');
            const countEl = document.getElementById('notifications-count');
            if (!listEl || !countEl) return;

            let unreadCount = 0;
            const relevantNotifications = allNotifications.filter(notif => {
                if (userRole === 'secretary') return true;
                if (notif.targetUnitId) { return userRole === 'leader'; }
                return true;
            });

            if (relevantNotifications.length === 0) {
                listEl.innerHTML = '<p class="p-4 text-sm text-slate-500 text-center">Nenhuma notificação.</p>';
            } else {
                listEl.innerHTML = relevantNotifications.slice(0, 20).map(notif => {
                    const isRead = notif.isRead[currentUser.uid];
                    if (!isRead) unreadCount++;
                    return `
                        <div data-id="${notif.id}" data-link="${notif.link || ''}" class="notification-item p-3 border-b border-slate-100 hover:bg-slate-50 cursor-pointer flex items-start space-x-3">
                            ${!isRead ? '<div class="w-2 h-2 bg-blue-500 rounded-full mt-2 flex-shrink-0"></div>' : '<div class="w-2 h-2 flex-shrink-0"></div>'}
                            <div class="text-2xl flex-shrink-0">${notif.icon}</div>
                            <div class="flex-grow">
                                <p class="font-semibold text-slate-800 text-sm">${notif.title}</p>
                                <p class="text-slate-600 text-sm">${notif.message}</p>
                                <p class="text-xs text-slate-400 mt-1">${notif.timestamp ? timeAgo(notif.timestamp.toDate()) : ''}</p>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            countEl.textContent = unreadCount;
            countEl.classList.toggle('hidden', unreadCount === 0);
        }

        async function handleNotificationClick(e) {
            const item = e.target.closest('.notification-item');
            if (!item) return;

            const notifId = item.dataset.id;
            const link = item.dataset.link;
            const notif = allNotifications.find(n => n.id === notifId);

            if (notif && !notif.isRead[currentUser.uid]) {
                try {
                    const notifRef = doc(db, 'artifacts', appId, 'public', 'data', 'notifications', notifId);
                    await updateDoc(notifRef, { [`isRead.${currentUser.uid}`]: true });
                } catch (e) { console.error("Erro ao marcar notificação como lida:", e); }
            }

            if (link) { switchTab(link); }
            document.getElementById('notifications-panel').classList.add('hidden');
        }

        async function handleMarkAllAsRead() {
            const unreadNotifications = allNotifications.filter(n => !n.isRead[currentUser.uid]);
            if (unreadNotifications.length === 0) return;

            showMessage(`Marcar ${unreadNotifications.length} notificações como lidas?`, async (confirmed) => {
                if (!confirmed) return;
                const batch = writeBatch(db);
                unreadNotifications.forEach(notif => {
                    const notifRef = doc(db, 'artifacts', appId, 'public', 'data', 'notifications', notif.id);
                    batch.update(notifRef, { [`isRead.${currentUser.uid}`]: true });
                });
                try { await batch.commit(); } catch (e) { console.error("Erro ao marcar todas como lidas:", e); }
            }, true);
        }

        function timeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 5) return "agora mesmo";
            let interval = seconds / 31536000;
            if (interval > 1) return `há ${Math.floor(interval)} anos`;
            interval = seconds / 2592000;
            if (interval > 1) return `há ${Math.floor(interval)} meses`;
            interval = seconds / 86400;
            if (interval > 1) return `há ${Math.floor(interval)} dias`;
            interval = seconds / 3600;
            if (interval > 1) return `há ${Math.floor(interval)} horas`;
            interval = seconds / 60;
            if (interval > 1) return `há ${Math.floor(interval)} minutos`;
            return `há ${Math.floor(seconds)} segundos`;
        }

        // --- Funções do Desafio Surpresa ---
        function handleActiveChallengeUpdate(challengeDoc) {
            const banner = document.getElementById('surprise-challenge-banner');
            const form = document.getElementById('challenge-submission-form');
            if (countdownInterval) clearInterval(countdownInterval);

            if (challengeDoc.exists()) {
                const data = challengeDoc.data();
                document.getElementById('challenge-title').textContent = data.title;
                document.getElementById('challenge-description').textContent = data.description;
                document.getElementById('challenge-points').textContent = data.points;
                const unitSelect = document.getElementById('challenge-unit-select');
                unitSelect.innerHTML = currentUnits.map(u => `<option value="${u.id}">${u.name}</option>`).join('');

                form.classList.toggle('hidden', userRole === 'viewer'); // Oculta formulário para visualizadores
                banner.classList.remove('hidden');

                const timerEl = document.getElementById('challenge-timer');
                countdownInterval = setInterval(() => {
                    const now = new Date();
                    const end = data.endTime.toDate();
                    const diff = end - now;

                    if (diff <= 0) {
                        clearInterval(countdownInterval);
                        timerEl.textContent = "00:00";
                        banner.classList.add('hidden');
                        return;
                    }

                    const minutes = Math.floor((diff / 1000 / 60) % 60);
                    const seconds = Math.floor((diff / 1000) % 60);
                    timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);

            } else {
                banner.classList.add('hidden');
            }
        }

        async function handleSubmitChallengeAnswer(e) {
            e.preventDefault();
            const unitId = document.getElementById('challenge-unit-select').value;
            const answer = document.getElementById('challenge-answer-input').value.trim().toLowerCase();
            if (!unitId || !answer) {
                showMessage("Selecione sua unidade e digite uma resposta.");
                return;
            }

            const challengeRef = doc(db, 'artifacts', appId, 'public', 'data', 'surprise_challenges', 'active');
            const challengeSnap = await getDoc(challengeRef);

            if (!challengeSnap.exists()) { showMessage("O desafio já terminou!"); return; }

            const challengeData = challengeSnap.data();
            if (challengeData.completedBy && challengeData.completedBy[unitId]) {
                showMessage("Sua unidade já completou este desafio!");
                return;
            }

            if (challengeData.answer === answer) {
                const points = challengeData.points;
                const unitRef = doc(db, 'artifacts', appId, 'public', 'data', 'units', unitId);
                const unitSnap = await getDoc(unitRef);
                if (unitSnap.exists()) {
                    await updateDoc(unitRef, { score: (unitSnap.data().score || 0) + points });
                }

                await updateDoc(challengeRef, { [`completedBy.${unitId}`]: serverTimestamp() });

                showMessage(`Parabéns! Resposta correta! Sua unidade ganhou ${points} pontos!`);
                await createNotification({ title: 'Desafio Concluído!', message: `A Unidade ${unitSnap.data().name} concluiu o desafio surpresa e ganhou ${points} pontos!`, icon: '🎉', targetUnitId: unitId });
                document.getElementById('challenge-answer-input').value = '';
            } else {
                showMessage("Resposta incorreta. Tente novamente!");
            }
        }

        // --- Funções de Renderização da UI ---
        function renderDashboard() {
            const emptyState = document.getElementById('inicio-empty-state');
            const mainContent = document.getElementById('dashboard-main-content');
            const emptyStateSecretary = document.getElementById('inicio-empty-state-secretary');
            const emptyStateLeader = document.getElementById('inicio-empty-state-leader');

            if (currentUnits.length === 0) {
                mainContent.classList.add('hidden');
                emptyState.classList.remove('hidden');
                if (userRole === 'secretary') {
                    emptyStateSecretary.classList.remove('hidden');
                    emptyStateLeader.classList.add('hidden');
                } else {
                    emptyStateSecretary.classList.add('hidden');
                    emptyStateLeader.classList.remove('hidden');
                }
                return;
            }

            mainContent.classList.remove('hidden');
            emptyState.classList.add('hidden');

            const unidadeDestaqueEl = document.getElementById('unidade-destaque'), totalPontosEl = document.getElementById('total-pontos'), atividadesRealizadasEl = document.getElementById('atividades-realizadas');
            if (!unidadeDestaqueEl || !totalPontosEl || !atividadesRealizadasEl) return;
            const totalScore = currentUnits.reduce((sum, item) => sum + (item.score || 0), 0);
            const approvedSubmissionsCount = currentSubmissions.filter(sub => sub.status === 'approved').length;
            unidadeDestaqueEl.textContent = currentUnits.length > 0 ? currentUnits[0].name : "N/A";
            totalPontosEl.textContent = totalScore;
            atividadesRealizadasEl.textContent = `${approvedSubmissionsCount}`;
            renderScoreChart(currentUnits);
        }

        function renderScoreChart(unitsData) {
            const scoreChartEl = document.getElementById('scoreChart'); if (!scoreChartEl) return;
            const ctx = scoreChartEl.getContext('2d'); if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar', data: { labels: unitsData.map(item => wrapLabel(item.name, 15)), datasets: [{ label: 'Pontuação da Unidade', data: unitsData.map(item => item.score || 0), backgroundColor: 'rgba(59, 130, 246, 0.7)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1, borderRadius: 5, }] },
                options: {
                    indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.raw} pontos` } } },
                    scales: { x: { beginAtZero: true, grid: { display: true, color: 'rgba(203, 213, 225, 0.5)' } }, y: { grid: { display: false }, ticks: { autoSkip: false } } },
                    onClick: (e) => {
                        const points = chartInstance.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
                        if (points.length) {
                            const firstPoint = points[0];
                            const unitId = currentUnits[firstPoint.index].id;
                            showUnitPage(unitId);
                        }
                    }
                }
            });
        }

        function renderCalendar() {
            const container = document.getElementById('calendario-container'); if (!container) return; container.innerHTML = '';
            Object.entries(staticData.calendar).forEach(([month, activities]) => {
                const monthDiv = document.createElement('div'); monthDiv.className = 'bg-white rounded-xl shadow-md';
                const button = document.createElement('button'); button.className = 'accordion-button w-full text-left p-6 font-bold text-xl text-blue-800 flex justify-between items-center'; button.innerHTML = `<span>${month}</span><span class="transform transition-transform duration-300">▼</span>`;
                const contentDiv = document.createElement('div'); contentDiv.className = 'accordion-content px-6 pb-6 text-slate-600 space-y-4';
                activities.forEach(activity => { contentDiv.innerHTML += `<div class="pt-4 border-t first:border-t-0 border-slate-200"><p class="font-semibold text-slate-700">${activity.date} - ${activity.title}</p><p class="text-sm">${activity.desc}</p></div>`; });
                monthDiv.appendChild(button); monthDiv.appendChild(contentDiv); container.appendChild(monthDiv);
            });
        }

        function renderAchievementsTab() {
            const feed = document.getElementById('achievements-feed'); if (!feed) return;
            if (currentAwardedAchievements.length === 0) {
                feed.innerHTML = '<p class="text-slate-500 col-span-full text-center">Nenhuma conquista concedida ainda.</p>';
                return;
            }
            feed.innerHTML = currentAwardedAchievements.map(award => `
                <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col items-center text-center transform hover:scale-105 transition-transform duration-300">
                    <span class="text-6xl mb-4">${award.achievementIcon || '⭐'}</span>
                    <h4 class="text-xl font-bold text-yellow-500">${award.achievementName}</h4>
                    <p class="text-lg font-semibold text-slate-700 mt-2">Concedida à Unidade ${award.unitName}</p>
                    <p class="text-sm text-slate-500 mt-1">${new Date(award.awardedAt.toDate()).toLocaleDateString('pt-BR', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                </div>
            `).join('');
        }

        function renderAbout() {
            const basesContainer = document.getElementById('bases-content'), funcoesContainer = document.getElementById('funcoes-content');
            if (!basesContainer || !funcoesContainer) return;
            basesContainer.innerHTML = staticData.bases.map(item => `<div class="pt-4 border-t first:border-t-0 border-slate-200"><h4 class="font-bold text-lg text-slate-700">${item.title}</h4><p>${item.content}</p></div>`).join(''); funcoesContainer.innerHTML = '';
            Object.entries(staticData.funcoes).forEach(([category, roles]) => {
                let catHtml = `<h4 class="font-bold text-lg text-slate-700 pt-4 border-t first:border-t-0 border-slate-200">${category}</h4><ul class="list-disc list-inside list-disc-custom space-y-2">`;
                roles.forEach(role => { catHtml += `<li><strong>${role.title}:</strong> ${role.content}</li>`; });
                catHtml += `</ul>`; funcoesContainer.innerHTML += catHtml;
            });
        }

        function renderUnitLeaderDashboard() {
            const gestaoTitleEl = document.getElementById('gestao-title'); if (gestaoTitleEl) gestaoTitleEl.textContent = 'Dashboard do Líder de Unidade'; else return;
            const gestaoContent = document.getElementById('gestao-content'); if (!gestaoContent) return;
            gestaoContent.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-md mb-8"><h3 class="text-xl font-semibold text-blue-600 mb-4">Enviar Atividade Concluída</h3><form id="submit-activity-form" class="space-y-4 mb-8"><div><label for="unit-select-leader" class="block text-sm font-medium text-slate-700">Sua Unidade:</label><select id="unit-select-leader" class="mt-1 block w-full p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required><option value="">Selecione sua unidade</option></select><p id="no-units-message-leader" class="text-red-500 text-sm mt-2 hidden">Nenhuma unidade.</p></div><div><label for="activity-select-leader" class="block text-sm font-medium text-slate-700">Atividade:</label><select id="activity-select-leader" class="mt-1 block w-full p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required><option value="">Selecione uma atividade</option></select><p id="no-activities-message-leader" class="text-red-500 text-sm mt-2 hidden">Nenhuma atividade.</p></div><div><label for="details-leader" class="block text-sm font-medium text-slate-700">Detalhes da Conclusão:</label><textarea id="details-leader" rows="3" class="mt-1 block w-full p-3 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required placeholder="Descreva..."></textarea></div><button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg flex justify-center items-center">Enviar</button></form></div><div class="bg-white p-6 rounded-xl shadow-md"><h3 class="text-xl font-semibold text-blue-600 mb-4">Meus Envios Recentes</h3><div id="leader-submissions-list"><p class="text-slate-600">Selecione uma unidade.</p></div></div>`;
            populateLeaderUnitSelect(); populateLeaderActivitySelect();
            document.getElementById('submit-activity-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = e.target.querySelector('button[type="submit"]'); const originalBtnText = submitBtn.innerHTML; submitBtn.disabled = true; submitBtn.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white"></div>`;
                const unitId = document.getElementById('unit-select-leader').value, actId = document.getElementById('activity-select-leader').value, details = document.getElementById('details-leader').value;
                if (!unitId || !actId || !details.trim()) { showMessage("Preencha todos os campos obrigatórios."); submitBtn.disabled = false; submitBtn.innerHTML = originalBtnText; return; }
                const selectedActivity = currentActivities.find(a => a.id === actId);
                if (selectedActivity && selectedActivity.deadline) {
                    const deadlineDate = selectedActivity.deadline.toDate(); const now = new Date();
                    if (now > deadlineDate) { showMessage("O prazo para enviar esta atividade já terminou."); submitBtn.disabled = false; submitBtn.innerHTML = originalBtnText; return; }
                }
                try {
                    if (!selectedActivity) { showMessage("Atividade inválida."); throw new Error("Atividade selecionada é inválida"); }
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'submissions'), { unitId, unitName: currentUnits.find(u => u.id === unitId)?.name || '?', activityId: actId, activityName: selectedActivity.name, details, status: 'pending', submittedBy: currentUser.uid, submittedAt: serverTimestamp() });
                    showMessage("Atividade enviada para avaliação com sucesso!"); e.target.reset(); document.getElementById('unit-select-leader').value = ""; document.getElementById('activity-select-leader').value = ""; updateLeaderSubmissionsList("");
                } catch (err) { console.error("Erro no envio:", err); showMessage("Ocorreu um erro ao enviar a atividade. Verifique o console para mais detalhes."); } finally { submitBtn.disabled = false; submitBtn.innerHTML = originalBtnText; }
            });
            document.getElementById('unit-select-leader').addEventListener('change', (e) => updateLeaderSubmissionsList(e.target.value));
            updateLeaderSubmissionsList(document.getElementById('unit-select-leader').value);
        }

        function updateLeaderSubmissionsList(selectedUnitId) {
            const listEl = document.getElementById('leader-submissions-list'); if (!listEl) return;
            if (!selectedUnitId) { listEl.innerHTML = '<p class="text-slate-600">Selecione uma unidade para ver os envios.</p>'; return; }
            const unitSubs = currentSubmissions.filter(s => s.unitId === selectedUnitId);
            if (unitSubs.length === 0) { listEl.innerHTML = '<p class="text-slate-600">Nenhum envio para esta unidade.</p>'; return; }
            listEl.innerHTML = `<div class="overflow-x-auto"><table class="min-w-full bg-white rounded-lg shadow-md"><thead class="bg-blue-100"><tr><th class="th-cell">Atividade</th><th class="th-cell">Detalhes</th><th class="th-cell">Status</th><th class="th-cell">Pontos</th><th class="th-cell rounded-tr-lg">Data</th></tr></thead><tbody>${unitSubs.map(s => {
                let statusCellHtml = `<span class="status-badge ${s.status}">${s.status}</span>`;
                if (s.status === 'rejected' && s.rejectionReason) {
                    statusCellHtml += `<p class="text-xs text-red-600 italic mt-1" title="Motivo da Rejeição">${s.rejectionReason}</p>`;
                }
                return `<tr><td class="td-cell">${s.activityName || '?'}</td><td class="td-cell truncate" title="${s.details}">${s.details || '?'}</td><td class="td-cell">${statusCellHtml}</td><td class="td-cell font-bold">${s.pointsAwarded != null ? s.pointsAwarded : 'N/A'}</td><td class="td-cell">${s.submittedAt ? new Date(s.submittedAt.toDate()).toLocaleDateString('pt-BR') : 'N/A'}</td></tr>`;
            }).join('')}</tbody></table></div>`;
            listEl.querySelectorAll('.th-cell').forEach(th => th.classList.add('py-3', 'px-4', 'text-left', 'text-sm', 'font-semibold', 'text-slate-700'));
            listEl.querySelectorAll('.td-cell').forEach(td => td.classList.add('py-3', 'px-4', 'text-sm', 'border-b', 'border-slate-200'));
        }

        function renderSecretaryDashboard() {
            const gestaoTitleEl = document.getElementById('gestao-title'); if (gestaoTitleEl) gestaoTitleEl.textContent = 'Dashboard do Secretário'; else return;
            const gestaoContent = document.getElementById('gestao-content'); if (!gestaoContent) return;
            // --- HTML DO PAINEL DO SECRETÁRIO ATUALIZADO ---
            gestaoContent.innerHTML = `
                <section class="admin-section"><h3 class="admin-h3 text-orange-600">Lançar Desafio Surpresa</h3><div class="space-y-4"> <input type="text" id="challenge-title-input" placeholder="Título do Desafio" class="admin-input"> <textarea id="challenge-desc-input" placeholder="Descrição do Desafio" class="admin-input" rows="2"></textarea><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><input type="number" id="challenge-points-input" placeholder="Pontos" class="admin-input"><input type="number" id="challenge-duration-input" placeholder="Duração (minutos)" class="admin-input"><input type="text" id="challenge-answer-input-admin" placeholder="Resposta Correta" class="admin-input"></div> <div class="flex gap-4"> <button id="launch-challenge-btn" class="admin-btn bg-orange-500 hover:bg-orange-600 w-full">⚡ Lançar Desafio!</button> <button id="end-challenge-btn" class="admin-btn bg-gray-500 hover:bg-gray-600 w-full">Encerrar Desafio Atual</button></div></div></section>
                <section class="admin-section"><h3 class="admin-h3 text-indigo-600">Enviar Anúncio Global</h3><div class="space-y-4"> <textarea id="new-announcement-message" placeholder="Escreva sua mensagem aqui..." class="admin-input" rows="3"></textarea> <button id="send-announcement-btn" class="admin-btn bg-indigo-500 hover:bg-indigo-600 w-full">📢 Enviar Anúncio</button> </div></section>
                <section class="admin-section"><h3 class="admin-h3 text-blue-600">Gerenciar Unidades</h3><div class="flex flex-col sm:flex-row gap-4 mb-4"><input type="text" id="new-unit-name" placeholder="Nome da unidade" class="admin-input"><button id="add-unit-btn" class="admin-btn bg-blue-600 hover:bg-blue-700">Adicionar</button></div><div class="table-container"><table class="admin-table"><thead class="bg-blue-100"><tr><th class="th-cell">Unidade</th><th class="th-cell">Pontos</th><th class="th-cell rounded-tr-lg">Ações</th></tr></thead><tbody id="units-table-body"></tbody></table></div></section>
                <section class="admin-section"><h3 class="admin-h3 text-yellow-600">Gerenciar Conquistas</h3><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div id="create-achievement-section"> <h4 class="text-lg font-semibold mb-2 text-yellow-800">1. Criar Tipo de Conquista</h4> <div class="space-y-4"> <input type="text" id="new-achievement-name" placeholder="Nome da Conquista (Ex: Pioneirismo)" class="admin-input"> <textarea id="new-achievement-desc" placeholder="Descrição da Conquista" class="admin-input" rows="2"></textarea> <input type="text" id="new-achievement-icon" placeholder="Ícone (Ex: 🏆)" class="admin-input"> <button id="add-achievement-def-btn" class="admin-btn bg-yellow-500 hover:bg-yellow-600 w-full">Criar Conquista</button> </div> <div class="table-container mt-4"> <table class="admin-table"> <thead class="bg-yellow-100"> <tr> <th class="th-cell">Ícone</th> <th class="th-cell">Nome</th> <th class="th-cell rounded-tr-lg">Ação</th> </tr> </thead> <tbody id="achievements-defs-table-body"></tbody> </table> </div> </div><div id="award-achievement-section"> <h4 class="text-lg font-semibold mb-2 text-yellow-800">2. Conceder Conquista</h4> <div class="space-y-4"> <div> <label for="award-ach-unit-select" class="admin-label">Unidade Premiada:</label> <select id="award-ach-unit-select" class="admin-input"></select> </div> <div> <label for="award-ach-select" class="admin-label">Conquista a Conceder:</label> <select id="award-ach-select" class="admin-input"></select> </div> <button id="award-achievement-btn" class="admin-btn bg-yellow-600 hover:bg-yellow-700 w-full">Conceder Conquista</button> </div> </div></div></section>
                <section class="admin-section"><h3 class="admin-h3 text-green-600">Gerenciar Atividades</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4"><input type="text" id="new-activity-name" placeholder="Nome da Atividade" class="admin-input"><select id="new-activity-type" class="admin-input"><option value="">Tipo</option><option>Físico</option><option>Mental</option><option>Espiritual</option><option>Social</option><option>Pioneirismo</option><option>Natureza</option><option>Serviço</option><option>Culinária</option><option>Geral</option></select><input type="number" id="new-activity-max-points" placeholder="Pontos Máx." class="admin-input" min="0"><input type="datetime-local" id="new-activity-deadline" class="admin-input" title="Prazo Limite (opcional)"></div><button id="add-activity-btn" class="admin-btn bg-green-600 hover:bg-green-700 w-full">Adicionar Atividade</button><div class="table-container mt-6"><table class="admin-table"><thead class="bg-green-100"><tr><th class="th-cell">Atividade</th><th class="th-cell">Tipo</th><th class="th-cell">Pontos Máx.</th><th class="th-cell">Prazo Limite</th><th class="th-cell rounded-tr-lg">Ações</th></tr></thead><tbody id="activities-table-body"></tbody></table></div></section>
                
                <section class="admin-section">
                    <h3 class="admin-h3 text-teal-600">Gerenciar Membros</h3>
                    <div class="space-y-4 mb-4">
                        <input type="text" id="new-member-name" placeholder="Nome completo do membro" class="admin-input">
                        <select id="new-member-unit-select" class="admin-input"></select>
                        <select id="new-member-role-select" class="admin-input">
                            <option value="Desbravador">Desbravador</option>
                            <optgroup label="Liderança de Unidade">
                                <option value="Conselheiro">Conselheiro</option>
                                <option value="Capitão">Capitão</option>
                                <option value="Secretário de Unidade">Secretário de Unidade</option>
                            </optgroup>
                            <optgroup label="Direção do Clube">
                                <option value="Diretor(a)">Diretor(a)</option>
                                <option value="Diretor(a) Associado(a)">Diretor(a) Associado(a)</option>
                                <option value="Secretário(a) do Clube">Secretário(a) do Clube</option>
                                <option value="Tesoureiro(a) do Clube">Tesoureiro(a) do Clube</option>
                                <option value="Capelão(ã) do Clube">Capelão(ã) do Clube</option>
                                <option value="Instrutor">Instrutor</option>
                            </optgroup>
                        </select>
                        <button id="add-member-btn" class="admin-btn bg-teal-600 hover:bg-teal-700 w-full">Adicionar Membro</button>
                    </div>
                    <div class="table-container mt-6">
                        <table class="admin-table"><thead class="bg-teal-100"><tr><th class="th-cell">Nome</th><th class="th-cell">Unidade/Clube</th><th class="th-cell">Função</th><th class="th-cell rounded-tr-lg">Ações</th></tr></thead><tbody id="members-table-body"></tbody></table>
                    </div>
                </section>
                
                <section class="admin-section">
                    <h3 class="admin-h3 text-cyan-600">Registo de Presença da Liderança</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="attendance-date" class="admin-label">Data da Reunião:</label>
                            <input type="date" id="attendance-date" class="admin-input">
                        </div>
                        <div id="counselors-attendance-list" class="space-y-3 p-4 bg-slate-100 rounded-lg">
                            <p>Selecione uma data para carregar a lista da liderança.</p>
                        </div>
                        <button id="save-attendance-btn" class="admin-btn bg-cyan-600 hover:bg-cyan-700 w-full hidden">Salvar Chamada</button>
                    </div>
                </section>

                <section class="admin-section">
                    <h3 class="admin-h3 text-rose-600">Relatório de Faltas da Direção</h3>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div>
                                <label for="report-start-date" class="admin-label">Data Início:</label>
                                <input type="date" id="report-start-date" class="admin-input">
                            </div>
                            <div>
                                <label for="report-end-date" class="admin-label">Data Fim:</label>
                                <input type="date" id="report-end-date" class="admin-input">
                            </div>
                            <button id="generate-absence-report-btn" class="admin-btn bg-rose-600 hover:bg-rose-700 self-end">Gerar Relatório</button>
                        </div>
                        <div id="leadership-absence-report" class="table-container mt-4">
                             <p class="text-slate-500 text-center p-4">Selecione um período e clique em "Gerar Relatório".</p>
                        </div>
                    </div>
                </section>

                <section class="admin-section"><h3 class="admin-h3 text-red-700">Gerenciar Deméritos</h3><div class="space-y-4 mb-4"><div><label for="demerit-unit-select" class="admin-label">Unidade:</label><select id="demerit-unit-select" class="admin-input" required><option value="">Selecione</option></select></div><div><label for="demerit-points" class="admin-label">Pontos a Deduzir:</label><input type="number" id="demerit-points" min="1" class="admin-input" required placeholder="Ex: 10"></div><div><label for="demerit-reason" class="admin-label">Razão:</label><textarea id="demerit-reason" rows="3" class="admin-input" required placeholder="Motivo..."></textarea></div><button id="apply-demerit-btn" class="admin-btn bg-red-600 hover:bg-red-700 w-full">Aplicar</button></div><div class="table-container mt-6"><table class="admin-table"><thead class="bg-red-100"><tr><th class="th-cell">Unidade</th><th class="th-cell">Pontos</th><th class="th-cell">Razão</th><th class="th-cell rounded-tr-lg">Data</th></tr></thead><tbody id="demerits-table-body"></tbody></table></div></section>
                <section class="admin-section"><h3 class="admin-h3 text-purple-600">Gerenciar Usuários</h3><div id="users-management-list" class="table-container"><p>Carregando usuários...</p></div></section>
                <section class="admin-section"><h3 class="admin-h3 text-yellow-800">Envios Pendentes (<span id="pending-submissions-count">0</span>)</h3><div id="pending-submissions-list" class="table-container"><p>Nenhum pendente.</p></div></section>
                <section class="admin-section !mb-0"><h3 class="admin-h3 text-slate-700">Histórico de Envios</h3><div id="all-submissions-list" class="table-container"><p>Nenhum registro.</p></div></section>`;

            gestaoContent.querySelectorAll('.admin-section').forEach(el => el.classList.add('mb-8', 'p-4', 'rounded-xl', 'shadow-inner')); gestaoContent.querySelectorAll('.admin-h3').forEach(el => el.classList.add('text-xl', 'font-semibold', 'mb-4')); gestaoContent.querySelectorAll('.admin-input').forEach(el => el.classList.add('block', 'w-full', 'p-3', 'border', 'border-slate-300', 'rounded-lg', 'focus:ring-2')); gestaoContent.querySelectorAll('.admin-btn').forEach(el => el.classList.add('text-white', 'font-bold', 'py-3', 'px-4', 'rounded-lg', 'transition', 'duration-300', 'ease-in-out', 'transform', 'hover:scale-105', 'shadow-md')); gestaoContent.querySelectorAll('.admin-label').forEach(el => el.classList.add('block', 'text-sm', 'font-medium', 'text-slate-700', 'mb-1')); gestaoContent.querySelectorAll('.table-container').forEach(el => el.classList.add('overflow-x-auto')); gestaoContent.querySelectorAll('.admin-table').forEach(el => el.classList.add('min-w-full', 'bg-white', 'rounded-lg', 'shadow-md')); gestaoContent.querySelectorAll('.th-cell').forEach(th => th.classList.add('py-3', 'px-4', 'text-left', 'text-sm', 'font-semibold', 'text-slate-700'));

            // Setup listeners
            document.getElementById('add-unit-btn').addEventListener('click', handleAddUnit);
            document.getElementById('add-activity-btn').addEventListener('click', handleAddActivity);
            document.getElementById('apply-demerit-btn').addEventListener('click', handleApplyDemerit);
            document.getElementById('add-achievement-def-btn').addEventListener('click', handleAddAchievementDef);
            document.getElementById('award-achievement-btn').addEventListener('click', handleAwardAchievement);
            document.getElementById('send-announcement-btn').addEventListener('click', handleSendAnnouncement);
            document.getElementById('launch-challenge-btn').addEventListener('click', handleLaunchChallenge);
            document.getElementById('end-challenge-btn').addEventListener('click', handleEndChallenge);
            document.getElementById('add-member-btn').addEventListener('click', handleAddMember);
            document.getElementById('attendance-date').addEventListener('change', (e) => renderAttendanceSheet(e.target.value));
            document.getElementById('save-attendance-btn').addEventListener('click', handleSaveAttendance);
            // Listener para o novo botão de relatório
            document.getElementById('generate-absence-report-btn').addEventListener('click', generateLeadershipAbsenceReport);


            // Populate initial data
            const demeritUnitSelect = document.getElementById('demerit-unit-select'); demeritUnitSelect.innerHTML = currentUnits.length > 0 ? '<option value="">Selecione</option>' + currentUnits.map(u => `<option value="${u.id}">${u.name}</option>`).join('') : '<option value="">Nenhuma unidade</option>';
            updateUnitsTable(); 
            updateActivitiesTable(); 
            updateDemeritsTable(); 
            updateSubmissionsTables(); 
            updateUsersTable(); 
            updateAchievementDefsTable(); 
            updateAwardAchievementDropdowns();
            updateMembersTable(); 
        }

        function updateUnitsTable() {
            const tbody = document.getElementById('units-table-body'); if (!tbody) return;
            tbody.innerHTML = currentUnits.length === 0 ? '<tr><td colspan="3" class="text-center p-4">Nenhuma unidade cadastrada.</td></tr>' : currentUnits.map(u => `<tr><td><button class="unit-link text-blue-600 hover:underline" data-unit-id="${u.id}">${u.name}</button></td><td class="font-bold">${u.score || 0}</td><td class="whitespace-nowrap"><button data-id="${u.id}" class="edit-unit-btn admin-btn-xs bg-yellow-500 hover:bg-yellow-600 mr-1">Editar</button><button data-id="${u.id}" data-name="${u.name}" class="delete-unit-btn admin-btn-xs bg-red-500 hover:bg-red-600">Excluir</button></td></tr>`).join('');
            applyTableStyles(tbody);
            tbody.querySelectorAll('.admin-btn-xs').forEach(btn => btn.classList.add('text-white', 'font-bold', 'py-1', 'px-2', 'rounded', 'text-xs'));
            tbody.querySelectorAll('.delete-unit-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteUnit(e.target.dataset.id, e.target.dataset.name)));
            tbody.querySelectorAll('.edit-unit-btn').forEach(btn => btn.addEventListener('click', (e) => handleEditUnit(e.target.dataset.id)));
            tbody.querySelectorAll('.unit-link').forEach(btn => btn.addEventListener('click', (e) => showUnitPage(e.target.dataset.unitId)));
        }

        async function handleEditUnit(unitId) {
            const unit = currentUnits.find(u => u.id === unitId); if (!unit) { showMessage("Unidade não encontrada."); return; }
            const contentHtml = `<div><label for="edit-unit-name" class="block text-sm font-medium text-slate-700">Nome da Unidade:</label><input type="text" id="edit-unit-name" value="${unit.name}" class="admin-input mt-1"></div><div><label for="edit-unit-score" class="block text-sm font-medium text-slate-700">Pontuação:</label><input type="number" id="edit-unit-score" value="${unit.score || 0}" class="admin-input mt-1"></div>`;
            showEditModal(`Editar Unidade: ${unit.name}`, contentHtml, async () => {
                const newName = document.getElementById('edit-unit-name').value.trim(); const newScore = parseInt(document.getElementById('edit-unit-score').value, 10);
                if (!newName || isNaN(newScore)) { showMessage("Nome e pontuação são obrigatórios e a pontuação deve ser um número."); return; }
                try { const unitDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'units', unitId); await updateDoc(unitDocRef, { name: newName, score: newScore }); showMessage("Unidade atualizada com sucesso!"); } catch (err) { console.error("Erro ao atualizar unidade:", err); showMessage("Ocorreu um erro ao atualizar a unidade."); }
            });
            document.querySelectorAll('#editModal .admin-input').forEach(el => el.classList.add('block', 'w-full', 'p-3', 'border', 'border-slate-300', 'rounded-lg', 'focus:ring-2'));
        }

        async function handleDeleteUnit(unitId, unitName) { showMessage(`Tem certeza que deseja excluir a unidade "${unitName}"? Esta ação não pode ser desfeita.`, async (confirmed) => { if (!confirmed) return; try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'units', unitId)); showMessage(`Unidade "${unitName}" excluída com sucesso!`); } catch (err) { console.error("Erro ao excluir unidade:", err); showMessage("Ocorreu um erro ao excluir a unidade."); } }, true); }

        function updateActivitiesTable() {
            const tbody = document.getElementById('activities-table-body'); if (!tbody) return;
            tbody.innerHTML = currentActivities.length === 0 ? '<tr><td colspan="5" class="text-center p-4">Nenhuma atividade cadastrada.</td></tr>' : currentActivities.map(a => { const deadlineFormatted = a.deadline ? new Date(a.deadline.toDate()).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'N/A'; return `<tr><td>${a.name}</td><td>${a.type}</td><td class="font-bold">${a.maxPoints}</td><td>${deadlineFormatted}</td><td class="whitespace-nowrap"><button data-id="${a.id}" class="edit-activity-btn admin-btn-xs bg-yellow-500 hover:bg-yellow-600 mr-1">Editar</button><button data-id="${a.id}" data-name="${a.name}" class="delete-activity-btn admin-btn-xs bg-red-500 hover:bg-red-600">Excluir</button></td></tr>`; }).join('');
            applyTableStyles(tbody);
            tbody.querySelectorAll('.admin-btn-xs').forEach(btn => btn.classList.add('text-white', 'font-bold', 'py-1', 'px-2', 'rounded', 'text-xs'));
            tbody.querySelectorAll('.delete-activity-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteActivity(e.target.dataset.id, e.target.dataset.name)));
            tbody.querySelectorAll('.edit-activity-btn').forEach(btn => btn.addEventListener('click', (e) => handleEditActivity(e.target.dataset.id)));
        }

        async function handleEditActivity(activityId) {
            const activity = currentActivities.find(a => a.id === activityId); if (!activity) { showMessage("Atividade não encontrada."); return; }
            const deadlineValue = activity.deadline ? activity.deadline.toDate().toISOString().substring(0, 16) : '';
            const contentHtml = `<div><label for="edit-activity-name" class="block text-sm font-medium text-slate-700">Nome:</label><input type="text" id="edit-activity-name" value="${activity.name}" class="admin-input mt-1"></div><div><label for="edit-activity-type" class="block text-sm font-medium text-slate-700">Tipo:</label><select id="edit-activity-type" class="admin-input mt-1"><option>Físico</option><option>Mental</option><option>Espiritual</option><option>Social</option><option>Pioneirismo</option><option>Natureza</option><option>Serviço</option><option>Culinária</option><option>Geral</option></select></div><div><label for="edit-activity-max-points" class="block text-sm font-medium text-slate-700">Pontos Máx.:</label><input type="number" id="edit-activity-max-points" value="${activity.maxPoints || 0}" class="admin-input mt-1" min="0"></div><div><label for="edit-activity-deadline" class="block text-sm font-medium text-slate-700">Prazo Limite:</label><input type="datetime-local" id="edit-activity-deadline" value="${deadlineValue}" class="admin-input mt-1"></div>`;
            showEditModal(`Editar Atividade: ${activity.name}`, contentHtml, async () => {
                const name = document.getElementById('edit-activity-name').value.trim(), type = document.getElementById('edit-activity-type').value, maxPoints = parseInt(document.getElementById('edit-activity-max-points').value, 10), deadlineValue = document.getElementById('edit-activity-deadline').value;
                if (!name || !type || isNaN(maxPoints)) { showMessage("Preencha todos os campos corretamente."); return; }
                const updatedData = { name, type, maxPoints }; if (deadlineValue) updatedData.deadline = new Date(deadlineValue);
                try { const activityDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'activities', activityId); await updateDoc(activityDocRef, updatedData); showMessage("Atividade atualizada com sucesso!"); } catch (err) { console.error("Erro ao atualizar atividade:", err); showMessage("Ocorreu um erro ao atualizar a atividade."); }
            });
            document.getElementById('edit-activity-type').value = activity.type;
            document.querySelectorAll('#editModal .admin-input').forEach(el => el.classList.add('block', 'w-full', 'p-3', 'border', 'border-slate-300', 'rounded-lg', 'focus:ring-2'));
        }

        async function handleDeleteActivity(activityId, activityName) { showMessage(`Tem certeza que deseja excluir a atividade "${activityName}"?`, async (confirmed) => { if (!confirmed) return; try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'activities', activityId)); showMessage(`Atividade "${activityName}" excluída com sucesso!`); } catch (err) { console.error("Erro ao excluir atividade:", err); showMessage("Ocorreu um erro ao excluir a atividade."); } }, true); }

        function updateDemeritsTable() {
            const tbody = document.getElementById('demerits-table-body'); if (!tbody) return;
            tbody.innerHTML = currentDemerits.length === 0 ? '<tr><td colspan="4" class="text-center p-4">Nenhum demérito aplicado.</td></tr>' : currentDemerits.map(d => `<tr><td>${d.unitName}</td><td class="font-bold text-red-600">-${d.points}</td><td class="truncate max-w-xs" title="${d.reason}">${d.reason}</td><td>${d.appliedAt ? new Date(d.appliedAt.toDate()).toLocaleDateString('pt-BR') : 'N/A'}</td></tr>`).join('');
            applyTableStyles(tbody);
        }

        function updateSubmissionsTables() {
            const pendingSubs = currentSubmissions.filter(s => s.status === 'pending');
            const pendingCountEl = document.getElementById('pending-submissions-count'); if (pendingCountEl) pendingCountEl.textContent = pendingSubs.length;
            const pendingListDiv = document.getElementById('pending-submissions-list');
            if (pendingListDiv) {
                pendingListDiv.innerHTML = pendingSubs.length === 0 ? '<p class="text-slate-600 p-4">Nenhum envio pendente.</p>' : `<table class="admin-table"><thead class="bg-yellow-100"><tr><th class="th-cell">Unidade</th><th class="th-cell">Atividade</th><th class="th-cell">Detalhes</th><th class="th-cell">Pontos</th><th class="th-cell rounded-tr-lg">Ações</th></tr></thead><tbody>${pendingSubs.map(s => { const act = currentActivities.find(a => a.id === s.activityId); const maxPts = act?.maxPoints || 0; return `<tr><td class="align-middle">${s.unitName}</td><td class="align-middle">${s.activityName}</td><td class="align-middle truncate max-w-xs" title="${s.details}">${s.details}</td><td class="align-middle"><input type="number" value="${maxPts}" min="0" max="${maxPts}" class="points-input w-20"><span class="text-xs">/${maxPts}</span></td><td class="align-middle"><div class="flex flex-col sm:flex-row gap-1"><button data-id="${s.id}" data-unit-id="${s.unitId}" class="approve-btn admin-btn-xs bg-green-500">Aprovar</button><button data-id="${s.id}" class="reject-btn admin-btn-xs bg-red-500">Rejeitar</button></div></td></tr>`; }).join('')}</tbody></table>`;
                if (pendingSubs.length > 0) {
                    applyTableStyles(pendingListDiv.querySelector('tbody'));
                    pendingListDiv.querySelectorAll('.admin-btn-xs').forEach(btn => btn.classList.add('text-white', 'font-bold', 'py-1', 'px-2', 'rounded', 'text-xs'));
                    pendingListDiv.querySelectorAll('.points-input').forEach(input => input.classList.add('p-1', 'border', 'border-slate-300', 'rounded-md', 'text-center'));
                    pendingListDiv.querySelectorAll('.approve-btn').forEach(btn => btn.addEventListener('click', e => handleApproveSubmission(e.target.dataset.id, e.target.dataset.unitId, parseInt(e.target.closest('tr').querySelector('.points-input').value))));
                    pendingListDiv.querySelectorAll('.reject-btn').forEach(btn => btn.addEventListener('click', e => handleRejectSubmission(e.target.dataset.id)));
                }
            }
            const allSubsListDiv = document.getElementById('all-submissions-list');
            if (allSubsListDiv) {
                allSubsListDiv.innerHTML = currentSubmissions.length === 0 ? '<p class="text-slate-600 p-4">Nenhum envio.</p>' : `<table class="admin-table"><thead class="bg-slate-200"><tr><th class="th-cell">Unidade</th><th class="th-cell">Atividade</th><th class="th-cell">Status</th><th class="th-cell">Pontos</th><th class="th-cell">Envio</th><th class="th-cell rounded-tr-lg">Validação</th></tr></thead><tbody>${currentSubmissions.map(s => {
                    let statusCellHtml = `<span class="status-badge ${s.status}">${s.status}</span>`;
                    if (s.status === 'rejected' && s.rejectionReason) {
                        statusCellHtml += `<p class="text-xs text-red-600 italic mt-1" title="Motivo da Rejeição">${s.rejectionReason}</p>`;
                    }
                    return `<tr><td>${s.unitName}</td><td>${s.activityName}</td><td>${statusCellHtml}</td><td class="font-bold">${s.pointsAwarded != null ? s.pointsAwarded : 'N/A'}</td><td>${s.submittedAt ? new Date(s.submittedAt.toDate()).toLocaleDateString('pt-BR') : 'N/A'}</td><td>${s.validatedAt ? new Date(s.validatedAt.toDate()).toLocaleDateString('pt-BR') : 'N/A'}</td></tr>`;
                }).join('')}</tbody></table>`;
                if (currentSubmissions.length > 0) applyTableStyles(allSubsListDiv.querySelector('tbody'));
            }
        }

        function updateUsersTable() {
            const container = document.getElementById('users-management-list'); if (!container) return;
            if (currentUsers.length === 0) { container.innerHTML = '<p>Nenhum usuário registrado.</p>'; return; }
            const tableHtml = `<table class="admin-table"><thead class="bg-purple-100"><tr><th class="th-cell">Email</th><th class="th-cell">Função</th><th class="th-cell rounded-tr-lg">Data de Registro</th></tr></thead><tbody>${currentUsers.map(user => `<tr><td>${user.email || 'N/A'}</td><td><select data-uid="${user.uid}" class="user-role-select admin-input !p-2 !text-sm"><option value="viewer" ${user.role === 'viewer' ? 'selected' : ''}>Visualizador</option><option value="leader" ${user.role === 'leader' ? 'selected' : ''}>Conselheiro</option><option value="secretary" ${user.role === 'secretary' ? 'selected' : ''}>Secretário</option></select></td><td>${user.createdAt ? new Date(user.createdAt.toDate()).toLocaleDateString('pt-BR') : 'N/A'}</td></tr>`).join('')}</tbody></table>`;
            container.innerHTML = tableHtml; applyTableStyles(container.querySelector('tbody'));
            container.querySelectorAll('.user-role-select').forEach(select => {
                select.addEventListener('change', async (e) => {
                    const userId = e.target.dataset.uid, newRole = e.target.value, userEmail = currentUsers.find(u => u.uid === userId)?.email || 'este usuário';
                    showMessage(`Tem certeza que deseja alterar a função de ${userEmail} para "${newRole}"?`, async (confirmed) => {
                        if (confirmed) {
                            try { const userDocRef = doc(db, 'artifacts', appId, 'users', userId); await updateDoc(userDocRef, { role: newRole }); showMessage("Função do usuário atualizada com sucesso!"); } catch (err) { console.error("Erro ao atualizar função:", err); showMessage("Ocorreu um erro ao atualizar a função do usuário."); e.target.value = currentUsers.find(u => u.uid === userId)?.role; }
                        } else { e.target.value = currentUsers.find(u => u.uid === userId)?.role; }
                    }, true);
                });
            });
        }

        function updateAchievementDefsTable() { const tbody = document.getElementById('achievements-defs-table-body'); if (!tbody) return; tbody.innerHTML = currentAchievementDefs.map(def => `<tr> <td class="text-2xl">${def.icon}</td> <td>${def.name}</td> <td><button data-id="${def.id}" class="delete-unit-btn admin-btn-xs bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded text-xs">Excluir</button></td> </tr>`).join(''); applyTableStyles(tbody); tbody.querySelectorAll('.delete-unit-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteAchievementDef(e.target.dataset.id))); }
        function updateAwardAchievementDropdowns() { const unitSelect = document.getElementById('award-ach-unit-select'), achSelect = document.getElementById('award-ach-select'); if (!unitSelect || !achSelect) return; unitSelect.innerHTML = currentUnits.length > 0 ? `<option value="">Selecione...</option>${currentUnits.map(u => `<option value="${u.id}">${u.name}</option>`).join('')}` : '<option>Nenhuma unidade</option>'; achSelect.innerHTML = currentAchievementDefs.length > 0 ? `<option value="">Selecione...</option>${currentAchievementDefs.map(a => `<option value="${a.id}">${a.icon} ${a.name}</option>`).join('')}` : '<option>Nenhuma conquista</option>'; }

        async function handleApproveSubmission(submissionId, unitId, points) {
            const sub = currentSubmissions.find(s => s.id === submissionId); if (!sub) { showMessage("Erro: Submissão não encontrada."); return; }
            const act = currentActivities.find(a => a.id === sub.activityId); const maxPts = act?.maxPoints || 0;
            if (isNaN(points) || points < 0 || points > maxPts) { showMessage(`Pontuação inválida. O valor deve estar entre 0 e ${maxPts}.`); return; }
            showMessage(`Aprovar este envio com ${points} pontos?`, async (confirmed) => {
                if (!confirmed) return;
                try {
                    const subDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'submissions', submissionId); await updateDoc(subDocRef, { status: 'approved', pointsAwarded: points, validatedAt: serverTimestamp(), validatedBy: currentUser.uid });
                    const unitDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'units', unitId); const unitSnap = await getDoc(unitDocRef);
                    if (unitSnap.exists()) { const currentScore = unitSnap.data().score || 0; await updateDoc(unitDocRef, { score: currentScore + points }); }
                    showMessage("Atividade aprovada e pontuação atribuída!");
                    await createNotification({ title: "Atividade Aprovada", message: `O envio para '${sub.activityName}' foi aprovado com ${points} pontos.`, icon: '✅', targetUnitId: unitId, link: 'gestao' });
                } catch (err) { console.error("Erro ao aprovar submissão:", err); showMessage("Ocorreu um erro ao aprovar a submissão."); }
            }, true);
        }

        async function handleRejectSubmission(submissionId) {
            const reason = prompt("Por favor, insira o motivo da rejeição:");
            if (reason === null || reason.trim() === "") { showMessage("A rejeição foi cancelada pois nenhum motivo foi fornecido.", () => { }, false); return; }
            try {
                const subDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'submissions', submissionId);
                const subSnap = await getDoc(subDocRef);
                if (subSnap.exists()) {
                    const subData = subSnap.data();
                    if (subData.status === 'approved' && subData.pointsAwarded > 0) { const unitIdAdj = subData.unitId, ptsRev = subData.pointsAwarded, unitDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'units', unitIdAdj), unitSnap = await getDoc(unitDocRef); if (unitSnap.exists()) { await updateDoc(unitDocRef, { score: (unitSnap.data().score || 0) - ptsRev }); } }
                    await updateDoc(subDocRef, { status: 'rejected', pointsAwarded: 0, rejectionReason: reason.trim(), validatedAt: serverTimestamp(), validatedBy: currentUser.uid });
                    showMessage("Envio rejeitado com sucesso!");
                    await createNotification({ title: "Atividade Rejeitada", message: `O envio para '${subData.activityName}' foi rejeitado. Motivo: ${reason.trim()}`, icon: '❌', targetUnitId: subData.unitId, link: 'gestao' });
                }
            } catch (err) { console.error("Erro ao rejeitar submissão:", err); showMessage("Ocorreu um erro ao rejeitar a submissão."); }
        }

        // --- INÍCIO: FUNÇÕES PARA MEMBROS E CHAMADA (COM SISTEMA DE ALERTA DE FALTAS E RELATÓRIO) ---

        const handleAddMember = async () => {
            const name = document.getElementById('new-member-name').value.trim();
            const unitId = document.getElementById('new-member-unit-select').value;
            const role = document.getElementById('new-member-role-select').value;

            if (!name || !role) {
                showMessage("Nome e Função são campos obrigatórios.");
                return;
            }
             // Para cargos de diretoria, a unidade não é obrigatória.
            if (!unitId && !LEADERSHIP_ROLES.includes(role)) {
                showMessage("Por favor, selecione uma unidade para este membro.");
                return;
            }

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'members'), {
                    name,
                    unitId: LEADERSHIP_ROLES.includes(role) ? null : unitId, // Salva null se for da direção
                    role,
                    registeredAt: serverTimestamp()
                });
                showMessage(`Membro "${name}" adicionado com sucesso!`);
                document.getElementById('new-member-name').value = '';
            } catch (err) {
                console.error("Erro ao adicionar membro:", err);
                showMessage("Ocorreu um erro ao adicionar o membro.");
            }
        };

        function updateMembersTable() {
            const tbody = document.getElementById('members-table-body');
            if (!tbody) return;

            const unitSelect = document.getElementById('new-member-unit-select');
            if(unitSelect) {
                unitSelect.innerHTML = currentUnits.length > 0
                    ? '<option value="">Selecione a Unidade (se aplicável)</option>' + currentUnits.map(u => `<option value="${u.id}">${u.name}</option>`).join('')
                    : '<option value="">Cadastre uma unidade primeiro</option>';
            }

            tbody.innerHTML = currentMembers.length === 0
                ? '<tr><td colspan="4" class="text-center p-4">Nenhum membro cadastrado.</td></tr>'
                : currentMembers.sort((a,b) => a.name.localeCompare(b.name)).map(m => {
                    const unitName = currentUnits.find(u => u.id === m.unitId)?.name || 'Direção';
                    return `<tr>
                                <td>${m.name}</td>
                                <td>${unitName}</td>
                                <td>${m.role}</td>
                                <td class="whitespace-nowrap">
                                    <button data-id="${m.id}" class="delete-member-btn admin-btn-xs bg-red-500 hover:bg-red-600">Excluir</button>
                                </td>
                            </tr>`;
                }).join('');
            applyTableStyles(tbody);
            tbody.querySelectorAll('.admin-btn-xs').forEach(btn => btn.classList.add('text-white', 'font-bold', 'py-1', 'px-2', 'rounded', 'text-xs'));

            tbody.querySelectorAll('.delete-member-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const memberId = e.target.dataset.id;
                    const memberName = currentMembers.find(m => m.id === memberId)?.name;
                    showMessage(`Tem certeza que deseja excluir o membro "${memberName}"?`, async (confirmed) => {
                        if(confirmed) {
                            try {
                                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'members', memberId));
                                showMessage("Membro excluído.");
                            } catch (err) {
                                showMessage("Erro ao excluir membro.");
                                console.error(err);
                            }
                        }
                    }, true);
                });
            });
        }

        // FUNÇÃO DE ANÁLISE DE FALTAS (para alertas na folha de chamada)
        function analyzeCounselorAbsences(counselorId, allAttendanceRecords, selectedDate) {
            const thirtyDaysAgo = new Date(selectedDate);
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            const relevantRecords = allAttendanceRecords
                .filter(record => record.date.toDate() >= thirtyDaysAgo && record.date.toDate() <= selectedDate)
                .sort((a, b) => a.date.toDate() - b.date.toDate());
            
            let monthlyAbsences = 0;
            let consecutiveAbsences = 0;
            let lastStatusWasAbsent = false;
            let maxConsecutive = 0;

            relevantRecords.forEach(record => {
                const attendanceData = record.attendance || {};
                if (attendanceData.hasOwnProperty(counselorId)) {
                    if (attendanceData[counselorId] === false) {
                        monthlyAbsences++;
                        if (lastStatusWasAbsent) {
                            consecutiveAbsences++;
                        } else {
                            consecutiveAbsences = 1;
                        }
                        lastStatusWasAbsent = true;
                    } else {
                        lastStatusWasAbsent = false;
                        consecutiveAbsences = 0;
                    }
                }
                maxConsecutive = Math.max(maxConsecutive, consecutiveAbsences);
            });

            return {
                consecutive: maxConsecutive,
                monthly: monthlyAbsences
            };
        }

        // FOLHA DE PRESENÇA ATUALIZADA (para toda a liderança)
        async function renderAttendanceSheet(dateString) {
            const listContainer = document.getElementById('counselors-attendance-list');
            const saveBtn = document.getElementById('save-attendance-btn');
            if (!dateString) {
                listContainer.innerHTML = `<p>Selecione uma data para carregar a lista da liderança.</p>`;
                saveBtn.classList.add('hidden');
                return;
            }

            listContainer.innerHTML = '<div class="flex items-center justify-center p-4"><div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div><p class="ml-4">A carregar histórico...</p></div>';
            const leadershipMembers = currentMembers.filter(m => LEADERSHIP_ROLES.includes(m.role));

            if (leadershipMembers.length === 0) {
                listContainer.innerHTML = '<p>Nenhum membro da liderança cadastrado. Vá para "Gerenciar Membros" para adicioná-los.</p>';
                saveBtn.classList.add('hidden');
                return;
            }

            const selectedDate = new Date(dateString + 'T12:00:00Z');
            const thirtyDaysAgo = new Date(selectedDate);
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const attendanceQuery = query(
                collection(db, 'artifacts', appId, 'public', 'data', 'attendance_records'),
                where('date', '>=', thirtyDaysAgo),
                where('date', '<=', selectedDate)
            );
            const querySnapshot = await getDocs(attendanceQuery);
            const allAttendanceRecords = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            const recordForSelectedDate = allAttendanceRecords.find(r => r.id === dateString);
            const existingAttendance = recordForSelectedDate ? recordForSelectedDate.attendance : {};

            let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2">';
            leadershipMembers.sort((a,b) => a.name.localeCompare(b.name)).forEach(member => {
                const unitName = currentUnits.find(u => u.id === member.unitId)?.name || 'Direção';
                const isPresent = existingAttendance.hasOwnProperty(member.id) ? existingAttendance[member.id] : true;
                
                const absenceAnalysis = analyzeCounselorAbsences(member.id, allAttendanceRecords, selectedDate);
                let alertHtml = '';
                const alertMessages = [];

                if (absenceAnalysis.consecutive >= 2) {
                    alertMessages.push(`${absenceAnalysis.consecutive} faltas consecutivas.`);
                }
                if (absenceAnalysis.monthly >= 3) {
                    alertMessages.push(`${absenceAnalysis.monthly} faltas no último mês.`);
                }

                if(alertMessages.length > 0) {
                    alertHtml = `<span class="ml-2 text-red-500 cursor-pointer" title="${alertMessages.join(' ')}">⚠️</span>`;
                }
                
                html += `
                    <div class="flex items-center justify-between bg-white p-2 rounded-md shadow-sm">
                        <div class="flex items-center">
                            <span class="font-semibold">${member.name}</span>
                            ${alertHtml}
                            <span class="text-sm text-slate-500 ml-2">(${member.role === 'Conselheiro' ? unitName : member.role})</span>
                        </div>
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" data-member-id="${member.id}" class="attendance-checkbox h-5 w-5 rounded text-blue-600 focus:ring-blue-500" ${isPresent ? 'checked' : ''}>
                            <span class="ml-2 text-sm font-medium">Presente</span>
                        </label>
                    </div>
                `;
            });
            html += '</div>';
            listContainer.innerHTML = html;
            saveBtn.classList.remove('hidden');
        }

        // FUNÇÃO DE SALVAR CHAMADA ATUALIZADA
        async function handleSaveAttendance() {
            const dateString = document.getElementById('attendance-date').value;
            if (!dateString) {
                showMessage("Por favor, selecione uma data primeiro.");
                return;
            }

            const checkboxes = document.querySelectorAll('.attendance-checkbox');
            const attendanceStatus = {};
            checkboxes.forEach(box => {
                const memberId = box.dataset.memberId;
                if (memberId) {
                    attendanceStatus[memberId] = box.checked;
                }
            });

            const recordId = dateString;
            const attendanceRef = doc(db, 'artifacts', appId, 'public', 'data', 'attendance_records', recordId);

            try {
                await setDoc(attendanceRef, {
                    date: new Date(dateString + 'T12:00:00Z'),
                    attendance: attendanceStatus,
                    recordedBy: currentUser.uid,
                    recordedAt: serverTimestamp()
                }, { merge: true });

                showMessage("Registo de presença salvo com sucesso!");
            } catch (err) {
                console.error("Erro ao salvar presença:", err);
                showMessage("Ocorreu um erro ao salvar o registo de presença.");
            }
        }

        // --- NOVA FUNÇÃO PARA GERAR O RELATÓRIO DE FALTAS ---
        async function generateLeadershipAbsenceReport() {
            const startDateEl = document.getElementById('report-start-date');
            const endDateEl = document.getElementById('report-end-date');
            const reportContainer = document.getElementById('leadership-absence-report');

            if (!startDateEl.value || !endDateEl.value) {
                showMessage("Por favor, selecione a data de início e de fim para o relatório.");
                return;
            }

            const startDate = new Date(startDateEl.value + 'T00:00:00Z');
            const endDate = new Date(endDateEl.value + 'T23:59:59Z');

            if (startDate > endDate) {
                showMessage("A data de início não pode ser posterior à data de fim.");
                return;
            }

            reportContainer.innerHTML = '<div class="flex items-center justify-center p-4"><div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-rose-500"></div><p class="ml-4">A gerar relatório...</p></div>';

            try {
                const leadershipMembers = currentMembers.filter(m => LEADERSHIP_ROLES.includes(m.role));
                
                const attendanceQuery = query(
                    collection(db, 'artifacts', appId, 'public', 'data', 'attendance_records'),
                    where('date', '>=', startDate),
                    where('date', '<=', endDate)
                );
                const querySnapshot = await getDocs(attendanceQuery);
                const recordsInRange = querySnapshot.docs.map(doc => doc.data());

                const reportData = leadershipMembers.map(member => {
                    let presences = 0;
                    let absences = 0;
                    let meetingsCounted = 0;

                    recordsInRange.forEach(record => {
                        if (record.attendance && record.attendance.hasOwnProperty(member.id)) {
                            meetingsCounted++;
                            if (record.attendance[member.id] === true) {
                                presences++;
                            } else {
                                absences++;
                            }
                        }
                    });

                    const absencePercentage = meetingsCounted > 0 ? ((absences / meetingsCounted) * 100).toFixed(1) : "0.0";
                    
                    return {
                        name: member.name,
                        role: member.role,
                        meetingsCounted,
                        presences,
                        absences,
                        absencePercentage
                    };
                }).sort((a, b) => b.absencePercentage - a.absencePercentage); // Ordena por maior % de faltas

                if (reportData.length === 0) {
                     reportContainer.innerHTML = '<p class="text-slate-500 text-center p-4">Nenhum membro da liderança cadastrado.</p>';
                     return;
                }

                let tableHtml = `<table class="admin-table"><thead class="bg-rose-100"><tr>
                                    <th class="th-cell">Nome</th>
                                    <th class="th-cell">Função</th>
                                    <th class="th-cell text-center">Reuniões no Período</th>
                                    <th class="th-cell text-center">Presenças</th>
                                    <th class="th-cell text-center">Faltas</th>
                                    <th class="th-cell text-center rounded-tr-lg">% Faltas</th>
                                 </tr></thead><tbody>`;
                
                reportData.forEach(data => {
                    const percentageClass = data.absencePercentage > 25 ? 'text-red-600' : (data.absencePercentage > 10 ? 'text-amber-600' : 'text-green-600');
                    tableHtml += `<tr>
                                    <td>${data.name}</td>
                                    <td>${data.role}</td>
                                    <td class="text-center">${data.meetingsCounted}</td>
                                    <td class="text-center font-semibold text-green-700">${data.presences}</td>
                                    <td class="text-center font-semibold text-red-700">${data.absences}</td>
                                    <td class="text-center font-bold ${percentageClass}">${data.absencePercentage}%</td>
                                  </tr>`;
                });

                tableHtml += '</tbody></table>';
                reportContainer.innerHTML = tableHtml;
                applyTableStyles(reportContainer.querySelector('tbody'));

            } catch (err) {
                console.error("Erro ao gerar relatório:", err);
                reportContainer.innerHTML = '<p class="text-red-500 text-center p-4">Ocorreu um erro ao gerar o relatório. Tente novamente.</p>';
            }
        }


        // --- FIM: NOVAS FUNÇÕES ---

        function setupAuthFormListeners() {
            const authForm = document.getElementById('auth-form'), emailIn = document.getElementById('email'), passIn = document.getElementById('password'), loginBtn = document.getElementById('login-btn'), regBtn = document.getElementById('register-btn'), logoutBtn = document.getElementById('logout-btn');
            if (authForm && loginBtn && regBtn) {
                loginBtn.onclick = async (e) => { e.preventDefault(); const email = emailIn.value, pass = passIn.value; if (!email || !pass) { showMessage("Por favor, preencha o email e a senha."); return; } try { await signInWithEmailAndPassword(auth, email, pass); } catch (err) { console.error("Erro de Login:", err.code); showMessage(err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password' || err.code === 'auth/invalid-credential' ? "Email ou senha incorretos." : "Erro ao tentar iniciar sessão."); } };
                regBtn.onclick = async (e) => { e.preventDefault(); const email = emailIn.value, pass = passIn.value; if (!email || !pass) { showMessage("Por favor, preencha o email e a senha para se registar."); return; } if (pass.length < 6) { showMessage("A senha deve ter pelo menos 6 caracteres."); return; } try { await createUserWithEmailAndPassword(auth, email, pass); showMessage("Registo efetuado com sucesso! A iniciar sessão..."); } catch (err) { console.error("Erro de Registo:", err.code); showMessage(err.code === 'auth/email-already-in-use' ? "Este email já está em uso." : err.code === 'auth/weak-password' ? "A senha é muito fraca." : "Erro ao tentar registar."); } };
            }
            if (logoutBtn) { logoutBtn.onclick = async () => { try { await signOut(auth); showMessage("Sessão terminada com sucesso!"); } catch (err) { console.error("Erro de Logout:", err); showMessage("Ocorreu um erro ao terminar a sessão."); } }; }
        }

        let unsubscribers = [];
        function cleanupListeners() {
            unsubscribers.forEach(unsub => unsub());
            unsubscribers = [];
            if (activeChallengeUnsub) { activeChallengeUnsub(); activeChallengeUnsub = null; }
            if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
        }

        function showUnitPage(unitId) {
            document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById('main-nav').classList.add('hidden'); // Oculta a navegação principal

            const unitPageSection = document.getElementById('unit-page');
            unitPageSection.classList.add('active');
            renderUnitPageContent(unitId);
        }

        function renderUnitPageContent(unitId) {
            const unit = currentUnits.find(u => u.id === unitId);
            if (!unit) {
                showMessage("Unidade não encontrada.");
                switchTab('inicio'); // Volta para o início se a unidade não for achada
                return;
            }

            document.getElementById('unit-page-name').textContent = unit.name;
            document.getElementById('unit-page-score').textContent = unit.score || 0;

            const achievementsContainer = document.getElementById('unit-page-achievements');
            const unitAchievements = currentAwardedAchievements.filter(a => a.unitId === unitId);
            if (unitAchievements.length > 0) {
                achievementsContainer.innerHTML = unitAchievements.map(a => `
                    <div title="${a.achievementName}" class="flex flex-col items-center p-2 bg-slate-100 rounded-lg">
                        <span class="text-4xl">${a.achievementIcon}</span>
                        <span class="text-xs font-semibold mt-1 text-slate-600 truncate">${a.achievementName}</span>
                    </div>
                `).join('');
            } else {
                achievementsContainer.innerHTML = '<p class="text-slate-500 col-span-full">Nenhuma conquista ainda.</p>';
            }

            const submissionsContainer = document.getElementById('unit-page-submissions');
            const unitSubmissions = currentSubmissions.filter(s => s.unitId === unitId);
            if (unitSubmissions.length > 0) {
                submissionsContainer.innerHTML = `<table class="min-w-full bg-white rounded-lg shadow-md"><thead class="bg-blue-100"><tr><th class="th-cell">Atividade</th><th class="th-cell">Status</th><th class="th-cell">Pontos</th><th class="th-cell rounded-tr-lg">Data</th></tr></thead><tbody>${unitSubmissions.map(s => {
                    let statusCellHtml = `<span class="status-badge ${s.status}">${s.status}</span>`;
                    if (s.status === 'rejected' && s.rejectionReason) {
                        statusCellHtml += `<p class="text-xs text-red-600 italic mt-1" title="Motivo da Rejeição">${s.rejectionReason}</p>`;
                    }
                    return `<tr><td class="td-cell">${s.activityName || '?'}</td><td class="td-cell">${statusCellHtml}</td><td class="td-cell font-bold">${s.pointsAwarded != null ? s.pointsAwarded : 'N/A'}</td><td class="td-cell">${s.submittedAt ? new Date(s.submittedAt.toDate()).toLocaleDateString('pt-BR') : 'N/A'}</td></tr>`;
                }).join('')}</tbody></table>`;
                applyTableStyles(submissionsContainer.querySelector('tbody'));
            } else {
                submissionsContainer.innerHTML = '<p class="text-slate-500 text-center p-4">Nenhum envio registrado.</p>';
            }
        }

        function switchTab(targetTabId) {
            document.getElementById('main-nav').classList.remove('hidden'); // Garante que a nav principal está visível
            document.querySelectorAll('.tab-button').forEach(t => t.classList.toggle('active', t.dataset.tab === targetTabId));
            document.querySelectorAll('.content-section').forEach(s => s.classList.toggle('active', s.id === targetTabId));

            if (targetTabId === 'inicio') renderDashboard();
            else if (targetTabId === 'conquistas') renderAchievementsTab();
            else if (targetTabId === 'gestao') {
                if (userRole === 'secretary') renderSecretaryDashboard();
                else if (userRole === 'leader') renderUnitLeaderDashboard();
                else { showMessage("Sem permissão para aceder a esta área."); switchTab('inicio'); }
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const loadingOverlay = document.getElementById('loading-overlay');
            try {
                if (!firebaseConfig.apiKey || !firebaseConfig.projectId) throw new Error("Credenciais Firebase incompletas.");
                firebaseApp = initializeApp(firebaseConfig); db = getFirestore(firebaseApp); auth = getAuth(firebaseApp);
                if (loadingOverlay) loadingOverlay.classList.add('hidden');
                setupAuthFormListeners();
                onAuthStateChanged(auth, async (user) => {
                    const authSect = document.getElementById('auth-section'), mainContent = document.getElementById('main-app-content'), userP = document.getElementById('user-info'), logoutB = document.getElementById('logout-btn'), notifBell = document.getElementById('notifications-bell-container');
                    cleanupListeners();
                    if (user) {
                        currentUser = user;
                        const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid); const userDocSnap = await getDoc(userDocRef);
                        if (!userDocSnap.exists()) {
                            userRole = 'viewer'; // Novo usuário começa como 'viewer'
                            await setDoc(userDocRef, { role: userRole, uid: user.uid, email: user.email || '', createdAt: serverTimestamp() });
                        } else {
                            userRole = userDocSnap.data().role;
                        }

                        let welcomeMessage = "Olá!";
                        if (userRole === 'secretary') welcomeMessage = 'Olá, Secretário(a)';
                        else if (userRole === 'leader') welcomeMessage = 'Olá, Conselheiro(a)';
                        else if (userRole === 'viewer') welcomeMessage = 'Olá, Desbravador(a)';

                        if (userP) userP.textContent = `${welcomeMessage} (${user.email || 'Anônimo'})`;
                        if (logoutB) logoutB.classList.remove('hidden');
                        if (notifBell) notifBell.classList.remove('hidden');
                        if (authSect) authSect.classList.add('hidden'); if (mainContent) mainContent.classList.remove('hidden');
                        initAppContent();
                    } else {
                        currentUser = null; userRole = null;
                        if (userP) userP.textContent = 'Carregando...';
                        if (logoutB) logoutB.classList.add('hidden');
                        if (notifBell) notifBell.classList.add('hidden');
                        if (authSect) authSect.classList.remove('hidden'); if (mainContent) mainContent.classList.add('hidden');
                    }
                });
            } catch (err) { console.error("Erro na inicialização do Firebase:", err); showMessage(`Erro Firebase: ${err.message}. Verifique a consola e a sua configuração.`); if (loadingOverlay) loadingOverlay.classList.add('hidden'); }
        });

        async function initAppContent() {
            const gestaoTabBtn = document.querySelector('button[data-tab="gestao"]');
            if (gestaoTabBtn) gestaoTabBtn.classList.toggle('hidden', userRole === 'viewer');

            // Listeners de dados
            unsubscribers.push(onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'units'), s => { currentUnits = s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (b.score || 0) - (a.score || 0)); renderDashboard(); if (isActiveTabSecretary()) { updateUnitsTable(); updateAwardAchievementDropdowns(); updateMembersTable(); } if (isActiveTabLeader()) populateLeaderUnitSelect(); }));
            unsubscribers.push(onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'activities'), s => { currentActivities = s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => a.name.localeCompare(b.name)); if (isActiveTabSecretary()) updateActivitiesTable(); if (isActiveTabLeader()) populateLeaderActivitySelect(); }));
            unsubscribers.push(onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'submissions'), s => { currentSubmissions = s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (b.submittedAt?.toDate() || 0) - (a.submittedAt?.toDate() || 0)); renderDashboard(); if (isActiveTabSecretary()) updateSubmissionsTables(); if (isActiveTabLeader()) updateLeaderSubmissionsList(document.getElementById('unit-select-leader')?.value); }));
            unsubscribers.push(onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'demerits'), s => { currentDemerits = s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (b.appliedAt?.toDate() || 0) - (a.appliedAt?.toDate() || 0)); if (isActiveTabSecretary()) updateDemeritsTable(); }));
            unsubscribers.push(onSnapshot(collection(db, 'artifacts', appId, 'users'), s => { currentUsers = s.docs.map(d => ({ id: d.id, ...d.data() })); if (isActiveTabSecretary()) updateUsersTable(); }));
            unsubscribers.push(onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'achievements'), s => { currentAchievementDefs = s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => a.name.localeCompare(b.name)); if (isActiveTabSecretary()) { updateAchievementDefsTable(); updateAwardAchievementDropdowns(); } }));
            unsubscribers.push(onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'awarded_achievements'), s => { currentAwardedAchievements = s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (b.awardedAt?.toDate() || 0) - (a.awardedAt?.toDate() || 0)); if (document.getElementById('conquistas')?.classList.contains('active')) renderAchievementsTab(); }));
            unsubscribers.push(onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'notifications'), orderBy('timestamp', 'desc')), s => { allNotifications = s.docs.map(d => ({ id: d.id, ...d.data() })); renderNotifications(); }));
            unsubscribers.push(onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'members'), s => { currentMembers = s.docs.map(d => ({ id: d.id, ...d.data() })); if (isActiveTabSecretary()) { updateMembersTable(); }}));

            // Listener para o Desafio Surpresa
            const challengeRef = doc(db, 'artifacts', appId, 'public', 'data', 'surprise_challenges', 'active');
            activeChallengeUnsub = onSnapshot(challengeRef, handleActiveChallengeUpdate);
            unsubscribers.push(activeChallengeUnsub);

            // Configuração dos eventos da UI
            renderCalendar(); renderAbout();
            document.querySelectorAll('.tab-button').forEach(tab => { const newTab = tab.cloneNode(true); tab.parentNode.replaceChild(newTab, tab); newTab.addEventListener('click', () => switchTab(newTab.dataset.tab)); });
            document.body.addEventListener('click', (event) => { const button = event.target.closest('.accordion-button'); if (button) { const content = button.nextElementSibling, icon = button.querySelector('span:last-child'); if (!content || !icon) return; button.classList.toggle('open'); icon.classList.toggle('rotate-180'); content.style.maxHeight = button.classList.contains('open') ? content.scrollHeight + 'px' : null; } });
            document.getElementById('notifications-bell-btn').addEventListener('click', () => document.getElementById('notifications-panel').classList.toggle('hidden'));
            document.getElementById('notifications-list').addEventListener('click', handleNotificationClick);
            document.getElementById('mark-all-read-btn').addEventListener('click', handleMarkAllAsRead);
            document.getElementById('challenge-submission-form').addEventListener('submit', handleSubmitChallengeAnswer);
            document.getElementById('back-to-main-btn').addEventListener('click', () => switchTab('inicio'));

            // Iniciar na aba "Início"
            switchTab('inicio');
        }

        function isActiveTabSecretary() { return document.getElementById('gestao')?.classList.contains('active') && userRole === 'secretary'; }
        function isActiveTabLeader() { return document.getElementById('gestao')?.classList.contains('active') && userRole === 'leader'; }

        function populateLeaderUnitSelect() {
            const unitSL = document.getElementById('unit-select-leader'), noUnitsMsgL = document.getElementById('no-units-message-leader');
            if (unitSL) { unitSL.innerHTML = currentUnits.length > 0 ? '<option value="">Selecione sua unidade</option>' + currentUnits.map(u => `<option value="${u.id}">${u.name}</option>`).join('') : '<option value="">Nenhuma unidade cadastrada</option>'; if (noUnitsMsgL) noUnitsMsgL.classList.toggle('hidden', currentUnits.length > 0); }
        }

        function populateLeaderActivitySelect() {
            const actSL = document.getElementById('activity-select-leader'), noActsMsgL = document.getElementById('no-activities-message-leader');
            if (actSL) {
                const optionsHtml = currentActivities.map(a => { let deadlineText = ''; if (a.deadline) { const deadlineDate = a.deadline.toDate(), now = new Date(), isExpired = now > deadlineDate, formattedDate = deadlineDate.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }); deadlineText = ` - Prazo: ${formattedDate}${isExpired ? ' (Expirado)' : ''}`; } return `<option value="${a.id}">${a.name} (${a.type})${deadlineText}</option>`; }).join('');
                actSL.innerHTML = currentActivities.length > 0 ? '<option value="">Selecione uma atividade</option>' + optionsHtml : '<option value="">Nenhuma atividade cadastrada</option>';
                if (noActsMsgL) noActsMsgL.classList.toggle('hidden', currentActivities.length > 0);
            }
        }
    </script>
</body>

</html>